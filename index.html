<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT EMQX Cloud Tester</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        .status-box { padding: 10px; border-radius: 4px; margin-bottom: 15px; font-weight: bold; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        #log { background: #1e1e1e; color: #d4d4d4; padding: 15px; height: 350px; overflow-y: auto; border-radius: 4px; font-family: 'Consolas', monospace; font-size: 13px; }
        .topic-info { color: #569cd6; }
        .msg-content { color: #ce9178; }
        .time { color: #858585; margin-right: 8px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>EMQX Cloud Connection Test</h2>
        <p>Host: <code>n21f2dda.ala.dedicated.aws.emqxcloud.com</code></p>
    </div>

    <div id="status" class="status-box disconnected">Đang ngắt kết nối...</div>

    <div id="log"></div>
</div>

<script>
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');

    function addLog(msg, type = 'info') {
        const now = new Date().toLocaleTimeString();
        const div = document.createElement('div');
        div.style.marginBottom = '5px';
        
        let icon = type === 'error' ? '❌ ' : '✅ ';
        div.innerHTML = `<span class="time">[${now}]</span>${icon}${msg}`;
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
    }

    // Cấu hình kết nối cho WebSockets (Port 8084 cho WSS)
    const options = {
        clientId: 'web_test_' + Math.random().toString(16).substr(2, 5),
        username: 'anhtrung1',
        password: 'anhtrung1',
        clean: true,
        connectTimeout: 5000,
    };

    const host = 'wss://n21f2dda.ala.dedicated.aws.emqxcloud.com:8084/mqtt';

    addLog('Đang khởi tạo kết nối WebSockets...');
    const client = mqtt.connect(host, options);

    client.on('connect', () => {
        statusEl.innerText = 'ĐÃ KẾT NỐI THÀNH CÔNG';
        statusEl.className = 'status-box connected';
        addLog('Đã kết nối tới Broker!');
        
        // Tự động subscribe một topic để test
        const testTopic = 'emqx/test/topic';
        client.subscribe(testTopic, () => {
            addLog(`Đã đăng ký (Subscribed) topic: <span class="topic-info">${testTopic}</span>`);
            
            // Tự động gửi một tin nhắn test sau khi sub
            const payload = JSON.stringify({ msg: "Hello from Browser", status: "Active" });
            client.publish(testTopic, payload);
            addLog('Đã gửi (Publish) tin nhắn chào mừng.');
        });
    });

    client.on('message', (topic, message) => {
        addLog(`Nhận tin từ [<span class="topic-info">${topic}</span>]: <span class="msg-content">${message.toString()}</span>`);
    });

    client.on('error', (err) => {
        addLog('Lỗi: ' + err.message, 'error');
    });

    client.on('close', () => {
        statusEl.innerText = 'MẤT KẾT NỐI';
        statusEl.className = 'status-box disconnected';
    });
</script>

</body>
</html>
