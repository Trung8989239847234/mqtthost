<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ESP32 Cloud Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
  <style>
    /* --- 1. GIAO DI·ªÜN GLASSMORPHISM (Gi·ªØ nguy√™n t·ª´ code c≈©) --- */
    :root { --accent: #00ff00; --accentGlow: rgba(0, 255, 0, 0.55); }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: #fff;
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh; margin: 0;
    }
    .card {
      background: rgba(30, 30, 30, 0.75); backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px); padding: 20px;
      border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      width: 360px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* Tabs */
    .nav-tabs { display: flex; justify-content: space-around; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
    .nav-item { cursor: pointer; padding: 8px 16px; color: #aaa; font-weight: 600; font-size: 14px; text-transform: uppercase; border-radius: 8px; transition: 0.3s; }
    .nav-item.active { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.1); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.4s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* Timer Box & Status */
    .timer-box {
      background: rgba(0,0,0,0.3); color: var(--accent);
      font-family: 'Courier New', monospace; font-size: 56px;
      padding: 15px 0; border-radius: 12px; margin-top: 15px;
      border: 1px solid rgba(255,255,255,0.1);
      text-shadow: 0 0 18px var(--accentGlow); font-weight: bold;
    }
    .status-badge { padding: 6px 15px; border-radius: 50px; font-weight: 600; font-size: 12px; display: inline-block; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
    .status-on { background: linear-gradient(90deg, #11998e, #38ef7d); color: #fff; }
    .status-off { background: rgba(255, 255, 255, 0.15); color: #ccc; border: 1px solid #666; }
    .status-maint { background: linear-gradient(90deg, #ED213A, #93291E); color: #fff; animation: blink 1s infinite; }
    .status-wait { background: linear-gradient(90deg, #f12711, #f5af19); color: #fff; }
    @keyframes blink { 50% { opacity: 0.7; } }

    /* Controls */
    .control-row { background-color: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.05); }
    .stepper { display: flex; align-items: center; background-color: rgba(0,0,0,0.2); border-radius: 8px; padding: 2px; }
    .btn-step { background: none; border: none; color: #fff; font-size: 20px; width: 35px; height: 35px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .stepper input { background: transparent; border: none; color: #fff; font-size: 16px; width: 50px; text-align: center; font-weight: bold; outline: none; }

    .btn-primary { background: linear-gradient(90deg, #0061ff, #60efff); color: white; border: none; padding: 14px; width: 100%; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 5px; text-transform: uppercase; }
    .btn-primary:active { transform: scale(0.98); }

    .presets-container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
    .btn-preset { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); color: #ccc; border-radius: 8px; padding: 8px; font-size: 11px; cursor: pointer; }
    .btn-preset:hover { background: rgba(255,255,255,0.15); color: #fff; border-color: #0a84ff; }
    .btn-preset span { display: block; font-weight: bold; font-size: 13px; margin-bottom: 2px; color: #fff; }

    /* Maintenance */
    .maintenance-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; }
    .btn-m { background: rgba(255,255,255,0.05); color: #ddd; border: 1px solid rgba(255,255,255,0.1); font-size: 12px; padding: 10px 0; border-radius: 8px; cursor: pointer; }
    .btn-m:hover { background: rgba(255,255,255,0.15); }
    .btn-manual { color: #ffd60a; border-color: rgba(255, 214, 10, 0.3); }
    .btn-cancel { background: rgba(255, 69, 58, 0.15); color: #ff453a; border: 1px solid rgba(255, 69, 58, 0.3); margin-top: 10px; width: 100%; padding: 12px; border-radius: 10px; font-weight: 600; cursor: pointer; }

    /* Schedule Table */
    .tbl { width: 100%; border-collapse: collapse; font-size: 12px; }
    .tbl td { padding: 5px; text-align: left; vertical-align: middle; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .tbl input[type="time"] { background: rgba(0,0,0,0.3); border: 1px solid #444; color: #fff; border-radius: 5px; padding: 5px; width: 100%; box-sizing: border-box;}
    
    /* Day Selector */
    .day-selector { display: flex; gap: 3px; justify-content: center; margin-top: 4px; flex-wrap: wrap; }
    .day-btn { width: 20px; height: 20px; border-radius: 50%; border: 1px solid #555; background: rgba(0,0,0,0.3); color: #777; font-size: 9px; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; user-select: none; }
    .day-btn.active { background: #0a84ff; color: #fff; border-color: #0a84ff; box-shadow: 0 0 5px rgba(10, 132, 255, 0.5); }

    /* Toggle Switch */
    .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.2); transition: .2s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; top: 3px; background: white; transition: .2s; border-radius: 50%; }
    input:checked + .slider { background: #28a745; }
    input:checked + .slider:before { transform: translateX(18px); }
    .btn-del { background: rgba(255, 59, 48, 0.2); border: 1px solid #ff3b30; color: #ff3b30; border-radius: 5px; cursor: pointer; padding: 5px; }

    /* MQTT Status */
    #mqtt-status { position: absolute; top: 10px; right: 10px; width: 10px; height: 10px; border-radius: 50%; background: red; box-shadow: 0 0 5px red; }
    #mqtt-status.connected { background: #00ff00; box-shadow: 0 0 5px #00ff00; }
  </style>
</head>
<body>

<div class="card">
  <div id="mqtt-status" title="Disconnected"></div>
  <div class="nav-tabs">
    <div class="nav-item active" onclick="switchTab('home')" id="tab-home">Trang Ch·ªß</div>
    <div class="nav-item" onclick="switchTab('sch')" id="tab-sch">H·∫πn Gi·ªù</div>
    <div class="nav-item" onclick="switchTab('set')" id="tab-set">C√†i ƒê·∫∑t</div>
  </div>

  <div id="home" class="tab-content active">
    <div id="statusBadge" class="status-badge status-off">CONNECTING...</div>
    <h2>ESP32 TIMER</h2>
    <div id="timerDisplay" class="timer-box">--:--</div>
    
    <div style="text-align:left;font-size:11px;color:#888;margin-bottom:5px;font-weight:bold;margin-left:5px">PRESETS</div>
    <div class="presets-container">
      <button class="btn-preset" onclick="sendSave(5, 10)"><span>T∆Ø·ªöI</span>5m T·∫Øt / 10s B·∫≠t</button>
      <button class="btn-preset" onclick="sendSave(30, 5)"><span>B∆†M</span>30m T·∫Øt / 5s B·∫≠t</button>
      <button class="btn-preset" onclick="sendSave(1, 2)"><span>TEST</span>1m T·∫Øt / 2s B·∫≠t</button>
    </div>

    <div class="control-row">
      <div class="label-section">üèÉ CH·∫†Y (On) <span class="sub-text">Gi√¢y</span></div>
      <div class="stepper"><button class="btn-step" onclick="adj('onSec',-1)">‚àí</button><input type="number" id="onSec" value="5"><button class="btn-step" onclick="adj('onSec',1)">+</button></div>
    </div>
    <div class="control-row">
      <div class="label-section">üí§ NGH·ªà (Off) <span class="sub-text">Ph√∫t</span></div>
      <div class="stepper"><button class="btn-step" onclick="adj('offMin',-1)">‚àí</button><input type="number" id="offMin" value="1"><button class="btn-step" onclick="adj('offMin',1)">+</button></div>
    </div>

    <button class="btn-primary" onclick="doSave()">L∆ØU C√ÄI ƒê·∫∂T</button>

    <div style="margin-top:15px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px">
      <div style="font-size:11px;color:#aaa;text-align:left;margin-bottom:5px">CH·∫æ ƒê·ªò B·∫¢O TR√å</div>
      <div class="maintenance-grid">
        <button class="btn-m" onclick="sendMaint(1)">7p</button>
        <button class="btn-m" onclick="sendMaint(3)">30p</button>
        <button class="btn-m btn-manual" onclick="sendMaint(6)">Manual</button>
      </div>
      <button class="btn-cancel" onclick="sendMaint(0)">H·ª¶Y B·∫¢O TR√å</button>
    </div>
  </div>

  <div id="sch" class="tab-content">
    <h2>L·ªãch Ngh·ªâ</h2>
    <div style="text-align:left;font-size:11px;color:#aaa;margin-bottom:10px">Thi·∫øt b·ªã s·∫Ω NG·ª™NG ho·∫°t ƒë·ªông trong khung gi·ªù n√†y.</div>
    <div style="max-height:300px; overflow-y:auto">
        <table class="tbl">
            <tbody id="pauseTbody"></tbody>
        </table>
    </div>
    <button class="btn-m" style="width:100%;margin-top:10px;border:1px dashed #666" onclick="addPauseRow()">+ Th√™m m·ªëc</button>
    <button class="btn-primary" onclick="uploadPauseJson()">L∆ØU L·ªäCH TR√åNH</button>
  </div>

  <div id="set" class="tab-content">
    <h2>Th√¥ng tin</h2>
    <div class="control-row" style="display:block;text-align:left">
        <div>Device ID: <span id="disp_devid" style="float:right;color:#00ff00">timer02</span></div>
        <div style="margin-top:5px">WiFi RSSI: <span id="disp_rssi" style="float:right">...</span></div>
        <div style="margin-top:5px">Uptime: <span id="disp_uptime" style="float:right">...</span></div>
        <div style="margin-top:5px">Free Heap: <span id="disp_heap" style="float:right">...</span></div>
    </div>
    <div style="font-size:11px;color:#666;margin-top:20px">
        Dashboard MQTT v1.0<br>Connected via WSS (Port 8084)
    </div>
  </div>
</div>

<script>
// --- C·∫§U H√åNH MQTT ---
const mqttConfig = {
    host: "n21f2dda.ala.dedicated.aws.emqxcloud.com",
    port: 8084, // C·ªïng WSS cho HTTPS/GitHub Pages
    path: "/mqtt",
    clientId: "WebDashboard_" + parseInt(Math.random() * 100000),
    user: "anhtrung1",
    pass: "anhtrung1",
    topicSub: "devices/timer02/telemetry",
    topicPubBase: "devices/timer02/rpc/request/"
};

// Bi·∫øn to√†n c·ª•c
let client;
let pauseRanges = [];
let lastInteraction = 0;

// --- MQTT LOGIC ---
function connectMQTT() {
    client = new Paho.MQTT.Client(mqttConfig.host, mqttConfig.port, mqttConfig.path, mqttConfig.clientId);
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;

    client.connect({
        useSSL: true,
        userName: mqttConfig.user,
        password: mqttConfig.pass,
        onSuccess: onConnect,
        onFailure: onFailure,
        keepAliveInterval: 30
    });
}

function onConnect() {
    console.log("Connected to EMQX");
    document.getElementById("mqtt-status").className = "connected";
    document.getElementById("mqtt-status").title = "Connected";
    client.subscribe(mqttConfig.topicSub);
}

function onFailure(e) {
    console.log("Connect failed", e);
    setTimeout(connectMQTT, 5000);
}

function onConnectionLost(e) {
    console.log("Connection lost", e);
    document.getElementById("mqtt-status").className = "";
    setTimeout(connectMQTT, 5000);
}

function onMessageArrived(msg) {
    try {
        const payload = JSON.parse(msg.payloadString);
        // C·∫≠p nh·∫≠t UI t·ª´ telemetry
        updateUI(payload);
    } catch(e) { console.error("JSON parse error", e); }
}

function sendRPC(method, params) {
    if (!client || !client.isConnected()) { alert("M·∫•t k·∫øt n·ªëi MQTT!"); return; }
    const reqId = "req_" + parseInt(Math.random() * 10000);
    const topic = mqttConfig.topicPubBase + reqId;
    const payload = JSON.stringify({ method: method, params: params });
    
    const message = new Paho.MQTT.Message(payload);
    message.destinationName = topic;
    client.send(message);
    console.log("Sent RPC:", method, params);
}

// --- UI UPDATER ---
function updateUI(d) {
    // Ch·ªâ c·∫≠p nh·∫≠t input n·∫øu user kh√¥ng ƒëang thao t√°c (tr√°nh gi·∫≠t)
    const isIdle = (Date.now() - lastInteraction > 5000);

    // Tab Home
    if (d.status) {
        const b = document.getElementById("statusBadge");
        const tb = document.getElementById("timerDisplay");
        let cls = "status-off", txt = d.status, col = "#6c757d";

        if (d.pause_active) { txt = "‚è∏ ƒêANG NGH·ªà (L·ªäCH)"; cls = "status-off"; col = "#6c757d"; }
        else if (d.maint_mode > 0) { txt = "üîß ƒêANG B·∫¢O TR√å"; cls = "status-maint"; col = "#dc3545"; }
        else if (d.relay_run) { txt = "RUNNING (ON)"; cls = "status-on"; col = "#28a745"; }
        else if (d.status === "CHO RESET") { cls = "status-wait"; col = "#ffc107"; }
        
        b.className = "status-badge " + cls; b.innerHTML = txt;
        tb.style.color = col;
        tb.style.textShadow = "0 0 18px " + col;
    }
    
    if (d.time_rem) document.getElementById("timerDisplay").innerHTML = d.time_rem;
    if (d.off_min !== undefined && isIdle) document.getElementById("offMin").value = d.off_min;
    if (d.on_sec !== undefined && isIdle) document.getElementById("onSec").value = d.on_sec;

    // Tab Schedule (Load 1 l·∫ßn ho·∫∑c khi c√≥ update)
    if (d.pause_json && (pauseRanges.length === 0 || isIdle)) {
        try {
            const arr = JSON.parse(d.pause_json);
            if (JSON.stringify(arr) !== JSON.stringify(pauseRanges)) {
                pauseRanges = arr;
                renderPauseTable();
            }
        } catch(e) {}
    }

    // Tab Settings Info
    if (d.rssi) document.getElementById("disp_rssi").innerHTML = d.rssi + " dBm";
    if (d.uptime_s) document.getElementById("disp_uptime").innerHTML = Math.floor(d.uptime_s/60) + " ph√∫t";
    if (d.free_heap) document.getElementById("disp_heap").innerHTML = d.free_heap;
}

// --- UI INTERACTION ---
function switchTab(t) {
    document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
    document.getElementById(t).classList.add('active');
    document.getElementById('tab-' + t).classList.add('active');
}

function adj(id, val) {
    const el = document.getElementById(id);
    let v = parseInt(el.value) + val;
    if (v < 0) v = 0;
    if (id === 'onSec' && v < 1) v = 1;
    el.value = v;
    lastInteraction = Date.now();
}

function doSave() {
    const m = parseInt(document.getElementById("offMin").value);
    const s = parseInt(document.getElementById("onSec").value);
    sendRPC("save", {offMin: m, onSec: s}); // G·ª≠i JSON params
    alert("ƒê√£ g·ª≠i l·ªánh L∆∞u!");
}

function sendSave(m, s) {
    document.getElementById("offMin").value = m;
    document.getElementById("onSec").value = s;
    sendRPC("save", {offMin: m, onSec: s});
}

function sendMaint(mode) {
    sendRPC("setMaintenance", mode);
}

// --- SCHEDULE LOGIC ---
function renderPauseTable() {
    const tb = document.getElementById("pauseTbody");
    tb.innerHTML = "";
    const labels = ["CN","T2","T3","T4","T5","T6","T7"];

    pauseRanges.forEach((r, idx) => {
        const s = r.s || "12:00";
        const e = r.e || "13:00";
        const on = (r.on === 1 || r.on === true);
        const w = (r.w !== undefined) ? r.w : 127;

        let daysHtml = '<div class="day-selector">';
        for (let i = 1; i <= 7; i++) {
            let bitIdx = (i === 7) ? 0 : i;
            let isActive = (w & (1 << bitIdx));
            daysHtml += `<div class="day-btn ${isActive?'active':''}" onclick="toggleDay(${idx}, ${bitIdx}, this)">${labels[bitIdx]}</div>`;
        }
        daysHtml += '</div>';

        const row = document.createElement("tr");
        row.innerHTML = `
            <td>
                <div style="display:flex; gap:5px; margin-bottom:5px">
                    <input type="time" value="${s}" onchange="updSch(${idx}, 's', this.value)">
                    <span style="line-height:28px">-</span>
                    <input type="time" value="${e}" onchange="updSch(${idx}, 'e', this.value)">
                </div>
                ${daysHtml}
            </td>
            <td style="width:40px; text-align:center">
                <label class="switch"><input type="checkbox" ${on?'checked':''} onchange="updSch(${idx}, 'on', this.checked?1:0)"><span class="slider"></span></label>
            </td>
            <td style="width:30px"><button class="btn-del" onclick="delSch(${idx})">X</button></td>
        `;
        tb.appendChild(row);
    });
}

function addPauseRow() {
    pauseRanges.push({s: "12:00", e: "13:00", on: 1, w: 127});
    renderPauseTable();
    lastInteraction = Date.now();
}

function delSch(idx) {
    if (confirm("X√≥a m·ªëc n√†y?")) {
        pauseRanges.splice(idx, 1);
        renderPauseTable();
        lastInteraction = Date.now();
    }
}

function updSch(idx, key, val) {
    if (pauseRanges[idx]) {
        pauseRanges[idx][key] = val;
        lastInteraction = Date.now();
    }
}

function toggleDay(idx, bit, el) {
    if (!pauseRanges[idx]) return;
    let w = (pauseRanges[idx].w !== undefined) ? pauseRanges[idx].w : 127;
    const mask = 1 << bit;
    if (w & mask) {
        w &= ~mask;
        el.classList.remove('active');
    } else {
        w |= mask;
        el.classList.add('active');
    }
    pauseRanges[idx].w = w;
    lastInteraction = Date.now();
}

function uploadPauseJson() {
    const jsonStr = JSON.stringify(pauseRanges);
    sendRPC("setPauseJson", jsonStr);
    alert("ƒê√£ g·ª≠i l·ªãch tr√¨nh l√™n thi·∫øt b·ªã!");
}

// Start
connectMQTT();
</script>

</body>
</html>
