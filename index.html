<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>ESP32 TIMER PRO</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#1e3c72">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%2328a745' d='M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200zm61.8-104.4l-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6 0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z'/%3E%3C/svg%3E">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%2328a745' d='M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200zm61.8-104.4l-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6 0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z'/%3E%3C/svg%3E">

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    :root { --accent:#00ff00; --accentGlow: rgba(0,255,0,0.55); }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);
      color:#fff; display:flex; justify-content:center; align-items:center;
      min-height:100vh; margin:0; user-select:none; -webkit-user-select:none;
    }
    .card{
      background:rgba(30,30,30,0.75);
      backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
      padding:20px; border-radius:20px;
      box-shadow:0 8px 32px 0 rgba(0,0,0,0.37);
      width:360px; text-align:center;
      border:1px solid rgba(255,255,255,0.1);
      transition: border-color 0.3s;
    }
    /* Hi·ªáu ·ª©ng vi·ªÅn ƒë·ªè khi m·∫•t k·∫øt n·ªëi thi·∫øt b·ªã */
    .card.device-offline { border: 1px solid #ff453a; box-shadow: 0 0 15px rgba(255, 69, 58, 0.4); }

    .nav-tabs{display:flex;justify-content:space-around;margin-bottom:20px;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:10px}
    .nav-item{cursor:pointer;padding:8px 16px;color:#aaa;font-weight:600;font-size:14px;text-transform:uppercase;border-radius:8px;transition:.3s}
    .nav-item.active{background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.1)}
    .tab-content{display:none}
    .tab-content.active{display:block;animation:fadeIn .4s}
    @keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}

    h2{font-size:18px;font-weight:600;color:#e5e5e5;margin-bottom:5px;text-transform:uppercase;letter-spacing:1px}

    .timer-box{
      background:rgba(0,0,0,0.3);
      color:var(--accent,#00ff00);
      font-family:'Courier New',monospace;
      font-size:56px;padding:15px 0;border-radius:12px;margin-top:15px;
      border:1px solid rgba(255,255,255,0.1);
      text-shadow:0 0 18px var(--accentGlow,rgba(0,255,0,0.5));
      font-weight:bold; position:relative;
    }

    .progress-container{width:100%;background-color:rgba(255,255,255,0.1);height:6px;border-radius:0 0 10px 10px;overflow:hidden;margin-bottom:15px;margin-top:-5px}
    .progress-bar{height:100%;width:100%;background-color:#28a745;transition:width 1s linear, background-color .5s}

    .status-badge{padding:6px 15px;border-radius:50px;font-weight:600;font-size:12px;display:inline-block;margin-bottom:10px;text-transform:uppercase;letter-spacing:.5px;box-shadow:0 2px 10px rgba(0,0,0,0.2)}
    .status-on{background:linear-gradient(90deg,#11998e,#38ef7d);color:#fff;border:none}
    .status-off{background:rgba(255,255,255,0.15);color:#ccc;border:1px solid #666}
    .status-wait{background:linear-gradient(90deg,#f12711,#f5af19);color:#fff;border:none}
    .status-maint{background:linear-gradient(90deg,#ED213A,#93291E);color:#fff;border:none;animation:blink 1s infinite}
    /* Badge m·ªõi cho m·∫•t k·∫øt n·ªëi */
    .status-lost{background:#ff453a;color:#fff;border:none;animation:blink 1s infinite}

    @keyframes blink{50%{opacity:.7}}

    .control-row{background-color:rgba(255,255,255,0.05);border-radius:12px;padding:15px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,0.05)}
    .label-section{display:flex;align-items:center;gap:12px;font-weight:600;font-size:14px;color:#e5e5e5;text-align:left}
    .icon{font-size:22px}
    .sub-text{font-size:11px;color:#8e8e93;display:block;font-weight:normal;margin-top:2px}

    .stepper{display:flex;align-items:center;background-color:rgba(0,0,0,0.2);border-radius:8px;padding:2px}
    .btn-step{background:none;border:none;color:#fff;font-size:20px;width:35px;height:35px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s}
    .btn-step:active{opacity:.5;transform:scale(.9)}
    .btn-step:hover{color:#0a84ff}
    .stepper input{background:transparent;border:none;color:#fff;font-size:16px;width:50px;text-align:center;font-weight:bold;outline:none;-moz-appearance:textfield}
    .stepper input::-webkit-outer-spin-button,.stepper input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}

    .btn-primary{background:linear-gradient(90deg,#0061ff,#60efff);color:#fff;border:none;padding:14px;width:100%;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;transition:.2s;margin-top:5px;box-shadow:0 4px 15px rgba(0,97,255,0.4);text-transform:uppercase}
    .btn-primary:active{transform:scale(.98);box-shadow:0 2px 10px rgba(0,97,255,0.3)}

    .presets-container{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:15px}
    .btn-preset{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.1);color:#ccc;border-radius:8px;padding:8px;font-size:11px;cursor:pointer;transition:.2s}
    .btn-preset:hover{background:rgba(255,255,255,0.15);color:#fff;border-color:#0a84ff}
    .btn-preset span{display:block;font-weight:bold;font-size:13px;margin-bottom:2px;color:#fff}

    .maintenance-title{color:#8e8e93;font-size:11px;font-weight:bold;text-align:left;margin:25px 0 10px 0;text-transform:uppercase;letter-spacing:.5px;border-top:1px solid rgba(255,255,255,0.1);padding-top:15px}
    .maintenance-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .btn-m{background:rgba(255,255,255,0.05);color:#ddd;border:1px solid rgba(255,255,255,0.1);font-size:12px;padding:10px 0;border-radius:8px;cursor:pointer;transition:.2s}
    .btn-m:hover{background:rgba(255,255,255,0.15)}
    .btn-manual{color:#ffd60a;border-color:rgba(255,214,10,0.3)}
    .btn-cancel{background:rgba(255,69,58,0.15);color:#ff453a;border:1px solid rgba(255,69,58,0.3);margin-top:10px;width:100%;padding:12px;border-radius:10px;font-weight:600;cursor:pointer}

    .input-group{margin-bottom:12px;text-align:left;position:relative}
    .input-group label{display:block;font-size:12px;color:#aaa;margin-bottom:4px}
    .input-group input,.input-group select{width:100%;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);color:#fff;padding:10px;border-radius:8px;font-size:14px;box-sizing:border-box;transition:.3s}
    .input-group input:focus{border-color:#0a84ff;outline:none;background:rgba(0,0,0,0.5)}
    .toggle-eye{position:absolute;right:10px;top:32px;cursor:pointer;font-size:16px;opacity:.6}
    .toggle-eye:hover{opacity:1}

    .log-box{margin-top:25px;background:rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:10px;height:110px;overflow-y:auto;text-align:left;font-family:'Courier New',monospace;font-size:10px;color:#00ff00;opacity:.9}
    .log-entry{margin-bottom:2px;border-bottom:1px dashed #333}
    #saveMsg{color:#4cd964;font-size:13px;margin-top:10px;display:none;font-weight:bold;text-shadow:0 0 10px rgba(76,217,100,0.3)}

    /* Schedule */
    .card2{background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.12);border-radius:14px;padding:12px;margin-top:10px}
    .tbl{width:100%;border-collapse:collapse;font-size:12px}
    .tbl th,.tbl td{padding:8px 6px;border-bottom:1px solid rgba(255,255,255,0.08);text-align:left}
    .tbl th{color:#cfcfd4;font-weight:700;font-size:11px;letter-spacing:.2px}
    .tbl td{color:#fff;vertical-align:middle}
    .tbl input[type="time"]{width:100%;background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.12);color:#fff;padding:6px 8px;border-radius:8px;font-size:12px}

    .switch{position:relative;display:inline-block;width:44px;height:24px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#6c757d;transition:.2s;border-radius:999px}
    .slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:.2s;border-radius:50%}
    input:checked + .slider{background-color:#28a745}
    input:checked + .slider:before{transform:translateX(20px)}

    .btn-del{background:rgba(255,69,58,0.25);border:1px solid rgba(255,69,58,0.35);color:#ffb4ae;border-radius:10px;padding:7px 10px;cursor:pointer}
    .btn-del:hover{background:rgba(255,69,58,0.35)}
    .day-selector{display:flex;gap:6px;flex-wrap:wrap}
    .day-btn{padding:6px 8px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.06);color:#cfd2d8;font-weight:700;font-size:11px;cursor:pointer}
    .day-btn.active{background:rgba(10,132,255,0.25);border-color:rgba(10,132,255,0.5);color:#fff}

    .btn-row{display:flex;gap:8px;margin-top:8px}
    .btn-row .btn-m{flex:1}
    .btn-save{background:#28a745;border:0;color:#fff;border-radius:10px;padding:10px 0;font-weight:800;cursor:pointer;flex:1}
    .btn-save:hover{filter:brightness(1.06)}
    .badge-conn{display:inline-block;font-size:11px;color:#cfd2d8;margin-top:6px;opacity:.9}
  </style>
</head>

<body>
  <div class="card" id="mainCard">
    <div class="nav-tabs">
      <div id="tab-home" class="nav-item active" onclick="switchTab('home')">TRANG CH·ª¶</div>
      <div id="tab-schedule" class="nav-item" onclick="openSchedule()">H·∫∏N GI·ªú</div>
      <div id="tab-settings" class="nav-item" onclick="switchTab('settings')">C√ÄI ƒê·∫∂T</div>
    </div>

    <div id="home" class="tab-content active">
      <div id="statusBadge" class="status-badge status-off">WAITING...</div>
      <div class="badge-conn" id="connBadge">MQTT: DISCONNECTED</div>

      <h2>ESP32 TIMER PRO</h2>
      <div id="timerDisplay" class="timer-box">--:--</div>
      <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>

      <div style="text-align:left;font-size:11px;color:#8e8e93;font-weight:bold;margin-bottom:8px">C·∫§U H√åNH NHANH (PRESETS)</div>
      <div class="presets-container">
        <button class="btn-preset" onclick="applyPreset(5,10)"><span>T∆Ø·ªöI C√ÇY</span>5m T·∫Øt / 10s B·∫≠t</button>
        <button class="btn-preset" onclick="applyPreset(30,5)"><span>B∆†M N∆Ø·ªöC</span>30m T·∫Øt / 5s B·∫≠t</button>
        <button class="btn-preset" onclick="applyPreset(1,2)"><span>TEST NHANH</span>1m T·∫Øt / 2s B·∫≠t</button>
      </div>

      <div class="control-row">
        <div class="label-section">
          <div class="icon">üèÉ</div>
          <div><div>CH·∫†Y (On)</div><span class="sub-text">Th·ªùi gian b·∫≠t Relay</span></div>
        </div>
        <div class="stepper">
          <button class="btn-step" onclick="adjustValue('onSec',-1)">‚àí</button>
          <input type="number" id="onSec" value="" placeholder="--" min="0">
          <button class="btn-step" onclick="adjustValue('onSec',1)">+</button>
        </div>
      </div>

      <div class="control-row">
        <div class="label-section">
          <div class="icon">üí§</div>
          <div><div>NGH·ªà (Off)</div><span class="sub-text">Th·ªùi gian t·∫Øt Relay</span></div>
        </div>
        <div class="stepper">
          <button class="btn-step" onclick="adjustValue('offMin',-1)">‚àí</button>
          <input type="number" id="offMin" value="" placeholder="--" min="0">
          <button class="btn-step" onclick="adjustValue('offMin',1)">+</button>
        </div>
      </div>

      <button class="btn-primary" onclick="saveSettings()">L∆ØU TH·ªúI GIAN</button>
      <div id="saveMsg">‚úî ƒê√£ g·ª≠i l·ªánh (RPC)!</div>

      <div class="maintenance-title">üîß Ch·∫ø ƒë·ªô b·∫£o tr√¨</div>
      <div class="maintenance-grid">
        <button class="btn-m" onclick="setMaint(1)">7 Ph√∫t</button>
        <button class="btn-m" onclick="setMaint(2)">15 Ph√∫t</button>
        <button class="btn-m" onclick="setMaint(3)">30 Ph√∫t</button>
        <button class="btn-m" onclick="setMaint(4)">50 Ph√∫t</button>
        <button class="btn-m" onclick="setMaint(5)">80 Ph√∫t</button>
        <button class="btn-m btn-manual" onclick="setMaint(6)">‚àû Th·ªß c√¥ng</button>
      </div>
      <button class="btn-cancel" onclick="setMaint(0)">H·ª¶Y B·∫¢O TR√å</button>

      <div class="log-box" id="logDisplay">
        <div class="log-entry">App Ready. Add to Home Screen for best experience.</div>
      </div>
    </div>

    <div id="schedule" class="tab-content">
      <h2>H·∫πn gi·ªù ngh·ªâ</h2>
      <div class="card2">
        <div style="text-align:left;font-size:11px;color:#8e8e93;margin-bottom:8px">
          Thi·∫øt l·∫≠p c√°c kho·∫£ng th·ªùi gian motor s·∫Ω <b>t·∫°m ngh·ªâ</b>.
          N·∫øu th·ªùi gian hi·ªán t·∫°i n·∫±m trong kho·∫£ng n√†o c√≥ b·∫≠t (ON) th√¨ motor s·∫Ω b·ªã ng·∫Øt.
        </div>

        <table class="tbl">
          <thead>
            <tr>
              <th>B·∫Øt ƒë·∫ßu</th>
              <th>K·∫øt th√∫c</th>
              <th style="text-align:center">B·∫≠t</th>
              <th style="text-align:center">X√≥a</th>
            </tr>
          </thead>
          <tbody id="pauseTbody"></tbody>
        </table>

        <div class="btn-row">
          <button class="btn-m" onclick="addPauseRow()">+ Th√™m m·ªëc</button>
          <button class="btn-save" onclick="savePause()">L∆∞u L·ªãch</button>
        </div>

        <div style="margin-top:8px;text-align:left;font-size:11px;color:#8e8e93">
          M·∫πo: kho·∫£ng qua ƒë√™m (vd 22:00‚Üí06:00) v·∫´n h·ªó tr·ª£.
        </div>
      </div>
    </div>

    <div id="settings" class="tab-content">
      <h2>C·∫•u h√¨nh H·ªá th·ªëng</h2>

      <div class="input-group">
        <label>Device ID</label>
        <input type="text" id="cfg_devid" value="timer02">
      </div>

      <hr style="border-color:rgba(255,255,255,0.1);margin:15px 0">

      <div class="input-group">
        <label>EMQX Host</label>
        <input type="text" id="cfg_emqx_host" value="n21f2dda.ala.dedicated.aws.emqxcloud.com">
      </div>

      <div class="input-group">
        <label>EMQX WebSocket Port</label>
        <input type="number" id="cfg_emqx_ws_port" value="8084">
      </div>

      <div class="input-group">
        <label>WebSocket Path</label>
        <input type="text" id="cfg_emqx_ws_path" value="/mqtt">
      </div>

      <div class="input-group">
        <label>Use TLS (wss)</label>
        <select id="cfg_emqx_wss">
          <option value="1" selected>B·∫≠t (wss://)</option>
          <option value="0">T·∫Øt (ws://)</option>
        </select>
      </div>

      <div class="input-group">
        <label>EMQX Username</label>
        <input type="text" id="cfg_emqx_user" value="anhtrung1">
      </div>

      <div class="input-group">
        <label>EMQX Password</label>
        <input type="password" id="cfg_emqx_pass" value="anhtrung1">
        <span class="toggle-eye" onclick="togglePass('cfg_emqx_pass')">üëÅÔ∏è</span>
      </div>

      <button class="btn-primary" onclick="saveUiSettings()">L∆ØU (TR√äN TR√åNH DUY·ªÜT)</button>

      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn-m" style="flex:1;background:#007bff" onclick="mqttConnect()">K·∫æT N·ªêI</button>
        <button class="btn-m" style="flex:1" onclick="mqttDisconnect()">NG·∫ÆT</button>
      </div>

      <div class="log-box" id="topicBox" style="height:auto;margin-top:12px">
        <div class="log-entry"><b>Topic EMQX ƒëang d√πng:</b></div>
        <div class="log-entry" id="topicInfo">-</div>
      </div>

      <div style="margin-top:10px;text-align:left;font-size:11px;color:#cfd2d8;opacity:.9">
        L∆∞u √Ω: GitHub Pages ch·ªâ ch·∫°y tr√™n browser n√™n <b>ph·∫£i d√πng MQTT qua WebSocket</b> (ws/wss). Port TCP 1883 kh√¥ng d√πng tr·ª±c ti·∫øp trong browser.
      </div>
    </div>
  </div>

<script>
/* ========= STATE ========= */
let client = null;
let lastUserInteraction = 0;
let lastTelemetryTime = 0; // Th·ªùi gian nh·∫≠n tin cu·ªëi
let heartbeatInterval = null;

const state = {
  time_rem: "--:--", rem_s: null, off_min: null, on_sec: null,
  status: "SLEEPING", maint_mode: 0, pause_active: 0, relay_run: false, wait5s: false,
  pause_json: []
};

function addLog(msg){
  const box = document.getElementById("logDisplay");
  if(!box) return;
  const t = new Date().toLocaleTimeString('vi-VN', {hour12:false});
  const div = document.createElement("div");
  div.className="log-entry";
  div.textContent = `[${t}] ${msg}`;
  box.prepend(div);
  while(box.children.length>80) box.removeChild(box.lastChild);
}

/* ========= UI TABS ========= */
function switchTab(t){
  document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
  document.getElementById(t).classList.add('active');
  document.getElementById('tab-'+t).classList.add('active');
}
function openSchedule(){
  switchTab('schedule');
  renderPauseTable();
}

function togglePass(id){
  const x = document.getElementById(id);
  x.type = (x.type === "password") ? "text" : "password";
}

/* ========= SETTINGS (Browser LocalStorage) ========= */
function getCfg(){
  return {
    devid: (document.getElementById('cfg_devid').value || "timer02").trim(),
    host: (document.getElementById('cfg_emqx_host').value || "").trim(),
    wsPort: parseInt(document.getElementById('cfg_emqx_ws_port').value || "8084", 10),
    wsPath: (document.getElementById('cfg_emqx_ws_path').value || "/mqtt").trim(),
    wss: (document.getElementById('cfg_emqx_wss').value || "1") === "1",
    user: (document.getElementById('cfg_emqx_user').value || "").trim(),
    pass: (document.getElementById('cfg_emqx_pass').value || "")
  };
}
function saveUiSettings(){
  localStorage.setItem("emqx_ui_cfg", JSON.stringify(getCfg()));
  addLog("Saved UI settings");
  alert("ƒê√£ l∆∞u c·∫•u h√¨nh tr√¨nh duy·ªát!");
  updateTopicInfo();
}
function loadUiSettings(){
  try{
    const raw = localStorage.getItem("emqx_ui_cfg");
    if(!raw) return;
    const cfg = JSON.parse(raw);
    if(cfg.devid) document.getElementById('cfg_devid').value = cfg.devid;
    if(cfg.host) document.getElementById('cfg_emqx_host').value = cfg.host;
    if(cfg.wsPort) document.getElementById('cfg_emqx_ws_port').value = cfg.wsPort;
    if(cfg.wsPath) document.getElementById('cfg_emqx_ws_path').value = cfg.wsPath;
    document.getElementById('cfg_emqx_wss').value = cfg.wss ? "1" : "0";
    if(cfg.user) document.getElementById('cfg_emqx_user').value = cfg.user;
    if(cfg.pass !== undefined) document.getElementById('cfg_emqx_pass').value = cfg.pass;
  }catch(e){}
}

/* ========= TOPICS ========= */
function baseTopic(){ return "devices/" + getCfg().devid; }
function topicTelemetry(){ return baseTopic() + "/telemetry"; }
function topicRpcReqPlus(){ return baseTopic() + "/rpc/request/+"; }
function topicRpcRespPlus(){ return baseTopic() + "/rpc/response/+"; }

function updateTopicInfo(){
  const info = [`PUB Telemetry: ${topicTelemetry()}`, `PUB RPC: ${baseTopic() + "/rpc/response/{reqId}"}`].join(" | ");
  document.getElementById("topicInfo").textContent = info;
}

/* ========= MQTT CONNECTION ========= */
function mqttConnect(){
  const cfg = getCfg();
  if(!cfg.host){ alert("Thi·∫øu EMQX Host"); return; }
  
  const proto = cfg.wss ? "wss" : "ws";
  const url = `${proto}://${cfg.host}:${cfg.wsPort}${cfg.wsPath.startsWith('/')?cfg.wsPath:'/'+cfg.wsPath}`;

  if(client){ try{ client.end(true); }catch(e){} client = null; }

  addLog("Connecting: " + url);
  document.getElementById("connBadge").textContent = "MQTT: CONNECTING...";

  client = mqtt.connect(url, {
    username: cfg.user || undefined,
    password: cfg.pass || undefined,
    clientId: cfg.devid + "_web_" + Math.random().toString(16).slice(2,8),
    clean: true,
    keepalive: 60,
    reconnectPeriod: 2000
  });

  client.on("connect", () => {
    addLog("MQTT Connected!");
    document.getElementById("connBadge").textContent = "MQTT: CONNECTED";
    updateTopicInfo();
    
    // Reset timer
    lastTelemetryTime = Date.now(); 
    startHeartbeatMonitor();

    client.subscribe([topicTelemetry(), topicRpcRespPlus()], (err) => {
      if(!err) {
        addLog("Syncing data...");
        rpcCall("setOffMin", {}); 
        rpcCall("setOnSec", {});
        rpcCall("getPauseJson", {}); 
      }
    });
  });

  client.on("reconnect", () => document.getElementById("connBadge").textContent = "MQTT: RECONNECTING...");
  
  client.on("close", () => {
    document.getElementById("connBadge").textContent = "MQTT: DISCONNECTED";
    stopHeartbeatMonitor();
    updateOfflineUI(true); // Force show offline
  });
  
  client.on("error", (e) => addLog("MQTT Err: " + e.message));

  client.on("message", (topic, payload) => {
    const txt = payload.toString();

    // 1. Nh·∫≠n Telemetry
    if(topic === topicTelemetry()){
      lastTelemetryTime = Date.now(); // C·∫≠p nh·∫≠t th·ªùi gian nh·∫≠n tin cu·ªëi
      try{
        const obj = JSON.parse(txt);
        // Sync ƒë∆°n gi·∫£n
        if(obj.time_rem !== undefined) state.time_rem = obj.time_rem;
        if(obj.rem_s !== undefined) state.rem_s = obj.rem_s;
        if(obj.on_sec !== undefined) state.on_sec = obj.on_sec;
        if(obj.off_min !== undefined) state.off_min = obj.off_min;
        if(obj.status !== undefined) state.status = obj.status;
        if(obj.maint_mode !== undefined) state.maint_mode = obj.maint_mode;
        if(obj.pause_active !== undefined) state.pause_active = obj.pause_active;
        if(obj.relay_run !== undefined) state.relay_run = obj.relay_run;

        // SYNC L·ªäCH TR√åNH
        if(obj.pause_json !== undefined) {
           let raw = obj.pause_json;
           if (typeof raw === 'string') { try { raw = JSON.parse(raw); } catch(e){} }
           if(Array.isArray(raw)) state.pause_json = raw; else state.pause_json = [];
           if(document.getElementById('schedule').classList.contains('active')) renderPauseTable();
        }
        renderHome();
      }catch(e){}
    }
    // 2. Nh·∫≠n RPC Response
    else if(topic.startsWith(baseTopic()+"/rpc/response/")){
      try{
        const r = JSON.parse(txt);
        if(r.off_min !== undefined) document.getElementById("offMin").value = r.off_min;
        if(r.on_sec !== undefined) document.getElementById("onSec").value = r.on_sec;
        if(r.saved_off_min !== undefined) document.getElementById("offMin").value = r.saved_off_min;
        if(r.saved_on_sec !== undefined) document.getElementById("onSec").value = r.saved_on_sec;
      }catch(e){}
    }
  });
}

function mqttDisconnect(){
  if(client){ try{ client.end(true); }catch(e){} client = null; }
  document.getElementById("connBadge").textContent = "MQTT: DISCONNECTED";
  stopHeartbeatMonitor();
}

/* ========= HEARTBEAT MONITOR (T√≠nh nƒÉng 2) ========= */
function startHeartbeatMonitor(){
  if(heartbeatInterval) clearInterval(heartbeatInterval);
  heartbeatInterval = setInterval(() => {
    // N·∫øu qu√° 12s kh√¥ng nh·∫≠n ƒë∆∞·ª£c tin -> Coi l√† m·∫•t k·∫øt n·ªëi thi·∫øt b·ªã
    const diff = Date.now() - lastTelemetryTime;
    if(diff > 12000) {
       updateOfflineUI(true);
    } else {
       // N·∫øu ƒëang hi·ªán offline m√† c√≥ tin l·∫°i -> renderHome s·∫Ω t·ª± x√≥a
       document.getElementById("mainCard").classList.remove("device-offline");
    }
  }, 2000);
}

function stopHeartbeatMonitor(){
  if(heartbeatInterval) clearInterval(heartbeatInterval);
}

function updateOfflineUI(isOffline){
  const b = document.getElementById("statusBadge");
  const card = document.getElementById("mainCard");
  const timerBox = document.getElementById("timerDisplay");
  
  if(isOffline){
    b.innerHTML = "‚ö†Ô∏è M·∫§T K·∫æT N·ªêI TB";
    b.className = "status-badge status-lost";
    card.classList.add("device-offline");
    timerBox.style.setProperty("--accent", "#ff453a");
    timerBox.style.setProperty("--accentGlow", "rgba(255, 69, 58, 0.55)");
    timerBox.style.boxShadow = "0 0 0 1px rgba(255,255,255,0.1), 0 0 28px rgba(255, 69, 58, 0.55)";
  }
}

/* ========= RPC ========= */
function mqttPublish(topic, msgObj){
  if(!client || !client.connected){ alert("M·∫•t k·∫øt n·ªëi MQTT!"); return false; }
  client.publish(topic, JSON.stringify(msgObj), {qos:0, retain:false});
  return true;
}
function rpcCall(method, params){
  const reqId = Date.now().toString();
  const t = baseTopic() + "/rpc/request/" + reqId;
  const ok = mqttPublish(t, { method, params });
  return reqId;
}

/* ========= HOME ACTIONS ========= */
function adjustValue(id,d){
  const i=document.getElementById(id); let c=parseInt(i.value)||0; let n=c+d;
  if(n<0) n=0; if(id==='onSec' && n<1) n=1; i.value=n;
  lastUserInteraction=Date.now();
}
document.getElementById('offMin').addEventListener('input',()=>lastUserInteraction=Date.now());
document.getElementById('onSec').addEventListener('input',()=>lastUserInteraction=Date.now());

function applyPreset(m,s){
  document.getElementById('offMin').value = m; document.getElementById('onSec').value = s;
  saveSettings(); lastUserInteraction = Date.now() + 2000;
}
function saveSettings(){
  let m = parseInt(document.getElementById("offMin").value||"0",10);
  let s = parseInt(document.getElementById("onSec").value||"0",10);
  if(m<0) m=0; if(s<0) s=0; // Validate
  
  rpcCall("setOffMin", m);
  rpcCall("setOnSec", s);
  rpcCall("save", 1);
  const g=document.getElementById("saveMsg");
  g.style.display="block"; setTimeout(()=>g.style.display="none", 2000);
  lastUserInteraction=0;
}
function setMaint(mode){ rpcCall("setMaintenance", mode); }

/* ========= RENDER HOME ========= */
function renderHome(){
  // X√≥a c·∫£nh b√°o offline n·∫øu c√≥ d·ªØ li·ªáu m·ªõi
  document.getElementById("mainCard").classList.remove("device-offline");

  document.getElementById("timerDisplay").textContent = (state.time_rem && state.time_rem.length>0) ? state.time_rem : "--:--";
  const b = document.getElementById("statusBadge");
  const pb = document.getElementById("progressBar");
  const timerBox = document.getElementById("timerDisplay");

  let ac="#28a745", ag="rgba(40,167,69,0.55)";
  const pause = (Number(state.pause_active)||0)>0;
  const maint = Number(state.maint_mode)||0;
  const relay = !!state.relay_run;
  const wait5s = (String(state.status).toUpperCase().includes("WAIT") || String(state.status).toUpperCase().includes("CHO RESET"));

  if(pause){
    b.innerHTML="‚è∏ ƒêANG NGH·ªà"; b.className="status-badge status-off";
    pb.style.width="100%"; pb.style.backgroundColor="#6c757d"; ac="#6c757d"; ag="rgba(108,117,125,0.55)";
  } else if(maint>0){
    b.innerHTML="üîß ƒêANG B·∫¢O TR√å"; b.className="status-badge status-maint";
    pb.style.width="100%"; pb.style.backgroundColor="#dc3545"; ac="#dc3545"; ag="rgba(220,53,69,0.55)";
  } else if(relay){
    b.innerHTML="RUNNING (ON)"; b.className="status-badge status-on"; pb.style.backgroundColor="#28a745";
    const t=Number(state.on_sec)||0, c=Number(state.rem_s)||0;
    if(t>0 && c>=0) pb.style.width=(c/t*100)+"%";
  } else if(wait5s){
    b.innerHTML="WAITING RESET."; b.className="status-badge status-wait";
    pb.style.backgroundColor="#ffc107"; ac="#ffc107"; ag="rgba(255,193,7,0.55)"; pb.style.width="100%";
  } else {
    b.innerHTML="SLEEPING (OFF)"; b.className="status-badge status-off"; pb.style.backgroundColor="#6c757d";
    ac="#6c757d"; ag="rgba(108,117,125,0.55)";
    const t=(Number(state.off_min)||0)*60, c=Number(state.rem_s)||0;
    if(t>0 && c>=0) pb.style.width=(c/t*100)+"%";
  }
  timerBox.style.setProperty("--accent", ac);
  timerBox.style.setProperty("--accentGlow", ag);
  timerBox.style.boxShadow = "0 0 0 1px rgba(255,255,255,0.1), 0 0 28px " + ag;

  if(Date.now()-lastUserInteraction>5000){
    if(state.off_min!==null) document.getElementById("offMin").value=state.off_min;
    if(state.on_sec!==null) document.getElementById("onSec").value=state.on_sec;
  }
}

/* ========= SCHEDULE TABLE ========= */
function renderPauseTable(){
  const tb=document.getElementById('pauseTbody');
  if(!tb) return;
  tb.innerHTML="";
  let arr = state.pause_json;
  if(!Array.isArray(arr)) arr=[];

  if(arr.length===0){
    tb.innerHTML='<tr><td colspan="4" style="color:#8e8e93;padding:15px">Ch∆∞a c√≥ m·ªëc. B·∫•m <b>+ Th√™m m·ªëc</b></td></tr>';
    return;
  }
  const labels=["CN","T2","T3","T4","T5","T6","T7"];
  arr.forEach((r, idx)=>{
    const s=(r.s||"12:00"), e=(r.e||"13:00"), on=(r.on==1), w=(r.w===undefined?127:r.w);
    let daysHtml = '<div class="day-selector">';
    for(let i=1;i<=7;i++){
      const b=(i==7?0:i), act=(w&(1<<b));
      daysHtml += `<div class="day-btn ${act?'active':''}" onclick="toggleDay(${idx},${b},this)">${labels[b]}</div>`;
    }
    daysHtml += '</div>';

    const tr1=document.createElement('tr');
    tr1.innerHTML =
      `<td><input type="time" value="${s}" onchange="updP(${idx},'s',this.value)"></td>`+
      `<td><input type="time" value="${e}" onchange="updP(${idx},'e',this.value)"></td>`+
      `<td style="text-align:center"><label class="switch"><input type="checkbox" ${on?'checked':''} onchange="updP(${idx},'on',this.checked?1:0)"><span class="slider"></span></label></td>`+
      `<td style="text-align:center"><button class="btn-del" onclick="delP(${idx})">X</button></td>`;
    tb.appendChild(tr1);
    const tr2=document.createElement('tr');
    tr2.innerHTML = `<td colspan="4" style="border:none;padding-top:2px;padding-bottom:10px">${daysHtml}</td>`;
    tb.appendChild(tr2);
  });
}
function updP(idx,k,v){
  if(!state.pause_json[idx]) state.pause_json[idx]={s:"12:00",e:"13:00",on:1,w:127};
  state.pause_json[idx][k]=v;
}
function toggleDay(idx,b,el){
  if(!state.pause_json[idx]) return;
  let w = state.pause_json[idx].w===undefined?127:state.pause_json[idx].w;
  const m = 1<<b;
  if(w&m){ w &= ~m; el.classList.remove('active'); }
  else { w |= m; el.classList.add('active'); }
  state.pause_json[idx].w = w;
}
function addPauseRow(){
  if(!Array.isArray(state.pause_json)) state.pause_json=[];
  state.pause_json.push({s:"11:00",e:"05:00",on:1,w:127});
  renderPauseTable();
}
function delP(idx){
  state.pause_json.splice(idx,1);
  renderPauseTable();
}
function savePause(){
  const pl = state.pause_json||[];
  if(JSON.stringify(pl).length>1000){ alert("Data qu√° d√†i!"); return; }
  rpcCall("setPauseJson", pl);
  addLog("G·ª≠i l·ªánh L∆∞u L·ªãch (RPC)");
  alert("ƒê√£ g·ª≠i l·ªãch l√™n thi·∫øt b·ªã!");
}

/* ========= BOOT ========= */
loadUiSettings();
updateTopicInfo();
renderHome();
setTimeout(mqttConnect, 350);
</script>
</body>
</html>
