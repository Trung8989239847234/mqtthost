<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ESP32 TIMER PRO (EMQX)</title>

  <!-- MQTT over WebSocket (browser) -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    /* === Gi·ªØ nguy√™n style gi·ªëng webserver c·ªßa b·∫°n === */
    :root { --accent:#00ff00; --accentGlow: rgba(0,255,0,0.55); }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);
      color:#fff; display:flex; justify-content:center; align-items:center;
      min-height:100vh; margin:0;
    }
    .card{
      background:rgba(30,30,30,0.75);
      backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
      padding:20px; border-radius:20px;
      box-shadow:0 8px 32px 0 rgba(0,0,0,0.37);
      width:360px; text-align:center;
      border:1px solid rgba(255,255,255,0.1);
    }

    .nav-tabs{display:flex;justify-content:space-around;margin-bottom:20px;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:10px}
    .nav-item{cursor:pointer;padding:8px 16px;color:#aaa;font-weight:600;font-size:14px;text-transform:uppercase;border-radius:8px;transition:.3s}
    .nav-item.active{background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.1)}
    .tab-content{display:none}
    .tab-content.active{display:block;animation:fadeIn .4s}
    @keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}

    h2{font-size:18px;font-weight:600;color:#e5e5e5;margin-bottom:5px;text-transform:uppercase;letter-spacing:1px}

    .timer-box{
      background:rgba(0,0,0,0.3);
      color:var(--accent,#00ff00);
      font-family:'Courier New',monospace;
      font-size:56px;padding:15px 0;border-radius:12px;margin-top:15px;
      border:1px solid rgba(255,255,255,0.1);
      text-shadow:0 0 18px var(--accentGlow,rgba(0,255,0,0.5));
      font-weight:bold; position:relative;
    }

    .progress-container{width:100%;background-color:rgba(255,255,255,0.1);height:6px;border-radius:0 0 10px 10px;overflow:hidden;margin-bottom:15px;margin-top:-5px}
    .progress-bar{height:100%;width:100%;background-color:#28a745;transition:width 1s linear, background-color .5s}

    .status-badge{padding:6px 15px;border-radius:50px;font-weight:600;font-size:12px;display:inline-block;margin-bottom:10px;text-transform:uppercase;letter-spacing:.5px;box-shadow:0 2px 10px rgba(0,0,0,0.2)}
    .status-on{background:linear-gradient(90deg,#11998e,#38ef7d);color:#fff;border:none}
    .status-off{background:rgba(255,255,255,0.15);color:#ccc;border:1px solid #666}
    .status-wait{background:linear-gradient(90deg,#f12711,#f5af19);color:#fff;border:none}
    .status-maint{background:linear-gradient(90deg,#ED213A,#93291E);color:#fff;border:none;animation:blink 1s infinite}
    @keyframes blink{50%{opacity:.7}}

    .control-row{background-color:rgba(255,255,255,0.05);border-radius:12px;padding:15px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,0.05)}
    .label-section{display:flex;align-items:center;gap:12px;font-weight:600;font-size:14px;color:#e5e5e5;text-align:left}
    .icon{font-size:22px}
    .sub-text{font-size:11px;color:#8e8e93;display:block;font-weight:normal;margin-top:2px}

    .stepper{display:flex;align-items:center;background-color:rgba(0,0,0,0.2);border-radius:8px;padding:2px}
    .btn-step{background:none;border:none;color:#fff;font-size:20px;width:35px;height:35px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s}
    .btn-step:active{opacity:.5;transform:scale(.9)}
    .btn-step:hover{color:#0a84ff}
    .stepper input{background:transparent;border:none;color:#fff;font-size:16px;width:50px;text-align:center;font-weight:bold;outline:none;-moz-appearance:textfield}
    .stepper input::-webkit-outer-spin-button,.stepper input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}

    .btn-primary{background:linear-gradient(90deg,#0061ff,#60efff);color:#fff;border:none;padding:14px;width:100%;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;transition:.2s;margin-top:5px;box-shadow:0 4px 15px rgba(0,97,255,0.4);text-transform:uppercase}
    .btn-primary:active{transform:scale(.98);box-shadow:0 2px 10px rgba(0,97,255,0.3)}

    .presets-container{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:15px}
    .btn-preset{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.1);color:#ccc;border-radius:8px;padding:8px;font-size:11px;cursor:pointer;transition:.2s}
    .btn-preset:hover{background:rgba(255,255,255,0.15);color:#fff;border-color:#0a84ff}
    .btn-preset span{display:block;font-weight:bold;font-size:13px;margin-bottom:2px;color:#fff}

    .maintenance-title{color:#8e8e93;font-size:11px;font-weight:bold;text-align:left;margin:25px 0 10px 0;text-transform:uppercase;letter-spacing:.5px;border-top:1px solid rgba(255,255,255,0.1);padding-top:15px}
    .maintenance-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .btn-m{background:rgba(255,255,255,0.05);color:#ddd;border:1px solid rgba(255,255,255,0.1);font-size:12px;padding:10px 0;border-radius:8px;cursor:pointer;transition:.2s}
    .btn-m:hover{background:rgba(255,255,255,0.15)}
    .btn-manual{color:#ffd60a;border-color:rgba(255,214,10,0.3)}
    .btn-cancel{background:rgba(255,69,58,0.15);color:#ff453a;border:1px solid rgba(255,69,58,0.3);margin-top:10px;width:100%;padding:12px;border-radius:10px;font-weight:600;cursor:pointer}

    .input-group{margin-bottom:12px;text-align:left;position:relative}
    .input-group label{display:block;font-size:12px;color:#aaa;margin-bottom:4px}
    .input-group input,.input-group select{width:100%;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);color:#fff;padding:10px;border-radius:8px;font-size:14px;box-sizing:border-box;transition:.3s}
    .input-group input:focus{border-color:#0a84ff;outline:none;background:rgba(0,0,0,0.5)}
    .toggle-eye{position:absolute;right:10px;top:32px;cursor:pointer;font-size:16px;opacity:.6}
    .toggle-eye:hover{opacity:1}

    .log-box{margin-top:25px;background:rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:10px;height:110px;overflow-y:auto;text-align:left;font-family:'Courier New',monospace;font-size:10px;color:#00ff00;opacity:.9}
    .log-entry{margin-bottom:2px;border-bottom:1px dashed #333}
    #saveMsg{color:#4cd964;font-size:13px;margin-top:10px;display:none;font-weight:bold;text-shadow:0 0 10px rgba(76,217,100,0.3)}

    /* Schedule */
    .card2{background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.12);border-radius:14px;padding:12px;margin-top:10px}
    .tbl{width:100%;border-collapse:collapse;font-size:12px}
    .tbl th,.tbl td{padding:8px 6px;border-bottom:1px solid rgba(255,255,255,0.08);text-align:left}
    .tbl th{color:#cfcfd4;font-weight:700;font-size:11px;letter-spacing:.2px}
    .tbl td{color:#fff;vertical-align:middle}
    .tbl input[type="time"]{width:100%;background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.12);color:#fff;padding:6px 8px;border-radius:8px;font-size:12px}

    .switch{position:relative;display:inline-block;width:44px;height:24px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#6c757d;transition:.2s;border-radius:999px}
    .slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:.2s;border-radius:50%}
    input:checked + .slider{background-color:#28a745}
    input:checked + .slider:before{transform:translateX(20px)}

    .btn-del{background:rgba(255,69,58,0.25);border:1px solid rgba(255,69,58,0.35);color:#ffb4ae;border-radius:10px;padding:7px 10px;cursor:pointer}
    .btn-del:hover{background:rgba(255,69,58,0.35)}
    .day-selector{display:flex;gap:6px;flex-wrap:wrap}
    .day-btn{padding:6px 8px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.06);color:#cfd2d8;font-weight:700;font-size:11px;cursor:pointer}
    .day-btn.active{background:rgba(10,132,255,0.25);border-color:rgba(10,132,255,0.5);color:#fff}

    .btn-row{display:flex;gap:8px;margin-top:8px}
    .btn-row .btn-m{flex:1}
    .btn-save{background:#28a745;border:0;color:#fff;border-radius:10px;padding:10px 0;font-weight:800;cursor:pointer;flex:1}
    .btn-save:hover{filter:brightness(1.06)}
    .badge-conn{display:inline-block;font-size:11px;color:#cfd2d8;margin-top:6px;opacity:.9}
  </style>
</head>

<body>
  <div class="card">
    <div class="nav-tabs">
      <div id="tab-home" class="nav-item active" onclick="switchTab('home')">TRANG CH·ª¶</div>
      <div id="tab-schedule" class="nav-item" onclick="openSchedule()">H·∫∏N GI·ªú</div>
      <div id="tab-settings" class="nav-item" onclick="switchTab('settings')">C√ÄI ƒê·∫∂T</div>
    </div>

    <!-- HOME -->
    <div id="home" class="tab-content active">
      <div id="statusBadge" class="status-badge status-off">SLEEPING (OFF)</div>
      <div class="badge-conn" id="connBadge">MQTT: DISCONNECTED</div>

      <h2>ESP32 TIMER PRO</h2>
      <div id="timerDisplay" class="timer-box">--:--</div>
      <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>

      <div style="text-align:left;font-size:11px;color:#8e8e93;font-weight:bold;margin-bottom:8px">C·∫§U H√åNH NHANH (PRESETS)</div>
      <div class="presets-container">
        <button class="btn-preset" onclick="applyPreset(5,10)"><span>T∆Ø·ªöI C√ÇY</span>5m T·∫Øt / 10s B·∫≠t</button>
        <button class="btn-preset" onclick="applyPreset(30,5)"><span>B∆†M N∆Ø·ªöC</span>30m T·∫Øt / 5s B·∫≠t</button>
        <button class="btn-preset" onclick="applyPreset(1,2)"><span>TEST NHANH</span>1m T·∫Øt / 2s B·∫≠t</button>
      </div>

      <div class="control-row">
        <div class="label-section">
          <div class="icon">üèÉ</div>
          <div><div>CH·∫†Y (On)</div><span class="sub-text">Th·ªùi gian b·∫≠t Relay</span></div>
        </div>
        <div class="stepper">
          <button class="btn-step" onclick="adjustValue('onSec',-1)">‚àí</button>
          <input type="number" id="onSec" value="5">
          <button class="btn-step" onclick="adjustValue('onSec',1)">+</button>
        </div>
      </div>

      <div class="control-row">
        <div class="label-section">
          <div class="icon">üí§</div>
          <div><div>NGH·ªà (Off)</div><span class="sub-text">Th·ªùi gian t·∫Øt Relay</span></div>
        </div>
        <div class="stepper">
          <button class="btn-step" onclick="adjustValue('offMin',-1)">‚àí</button>
          <input type="number" id="offMin" value="1">
          <button class="btn-step" onclick="adjustValue('offMin',1)">+</button>
        </div>
      </div>

      <button class="btn-primary" onclick="saveSettings()">L∆ØU TH·ªúI GIAN</button>
      <div id="saveMsg">‚úî ƒê√£ g·ª≠i l·ªánh (RPC)!</div>

      <div class="maintenance-title">üîß Ch·∫ø ƒë·ªô b·∫£o tr√¨</div>
      <div class="maintenance-grid">
        <button class="btn-m" onclick="setMaint(1)">7 Ph√∫t</button>
        <button class="btn-m" onclick="setMaint(2)">15 Ph√∫t</button>
        <button class="btn-m" onclick="setMaint(3)">30 Ph√∫t</button>
        <button class="btn-m" onclick="setMaint(4)">50 Ph√∫t</button>
        <button class="btn-m" onclick="setMaint(5)">80 Ph√∫t</button>
        <button class="btn-m btn-manual" onclick="setMaint(6)">‚àû Th·ªß c√¥ng</button>
      </div>
      <button class="btn-cancel" onclick="setMaint(0)">H·ª¶Y B·∫¢O TR√å</button>

      <div class="log-box" id="logDisplay">
        <div class="log-entry">Log: ready.</div>
      </div>
    </div>

    <!-- SCHEDULE -->
    <div id="schedule" class="tab-content">
      <h2>H·∫πn gi·ªù ngh·ªâ</h2>
      <div class="card2">
        <div style="text-align:left;font-size:11px;color:#8e8e93;margin-bottom:8px">
          Thi·∫øt l·∫≠p c√°c kho·∫£ng th·ªùi gian motor s·∫Ω <b>t·∫°m ngh·ªâ</b>.
          N·∫øu th·ªùi gian hi·ªán t·∫°i n·∫±m trong kho·∫£ng n√†o c√≥ b·∫≠t (ON) th√¨ motor s·∫Ω b·ªã ng·∫Øt.
        </div>

        <table class="tbl">
          <thead>
            <tr>
              <th>B·∫Øt ƒë·∫ßu</th>
              <th>K·∫øt th√∫c</th>
              <th style="text-align:center">B·∫≠t</th>
              <th style="text-align:center">X√≥a</th>
            </tr>
          </thead>
          <tbody id="pauseTbody"></tbody>
        </table>

        <div class="btn-row">
          <button class="btn-m" onclick="addPauseRow()">+ Th√™m m·ªëc</button>
          <button class="btn-m" onclick="loadPauseFromDevice()">T·∫£i</button>
          <button class="btn-save" onclick="savePause()">L∆∞u</button>
        </div>

        <div style="margin-top:8px;text-align:left;font-size:11px;color:#8e8e93">
          M·∫πo: kho·∫£ng qua ƒë√™m (vd 22:00‚Üí06:00) v·∫´n h·ªó tr·ª£.
        </div>
      </div>
    </div>

    <!-- SETTINGS -->
    <div id="settings" class="tab-content">
      <h2>C·∫•u h√¨nh H·ªá th·ªëng</h2>

      <div class="input-group">
        <label>Device ID</label>
        <input type="text" id="cfg_devid" value="timer02">
      </div>

      <hr style="border-color:rgba(255,255,255,0.1);margin:15px 0">

      <div class="input-group">
        <label>EMQX Host</label>
        <input type="text" id="cfg_emqx_host" value="n21f2dda.ala.dedicated.aws.emqxcloud.com">
      </div>

      <div class="input-group">
        <label>EMQX WebSocket Port</label>
        <input type="number" id="cfg_emqx_ws_port" value="8084">
      </div>

      <div class="input-group">
        <label>WebSocket Path</label>
        <input type="text" id="cfg_emqx_ws_path" value="/mqtt">
      </div>

      <div class="input-group">
        <label>Use TLS (wss)</label>
        <select id="cfg_emqx_wss">
          <option value="1" selected>B·∫≠t (wss://)</option>
          <option value="0">T·∫Øt (ws://)</option>
        </select>
      </div>

      <div class="input-group">
        <label>EMQX Username</label>
        <input type="text" id="cfg_emqx_user" value="anhtrung1">
      </div>

      <div class="input-group">
        <label>EMQX Password</label>
        <input type="password" id="cfg_emqx_pass" value="anhtrung1">
        <span class="toggle-eye" onclick="togglePass('cfg_emqx_pass')">üëÅÔ∏è</span>
      </div>

      <button class="btn-primary" onclick="saveUiSettings()">L∆ØU (TR√äN TR√åNH DUY·ªÜT)</button>

      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn-m" style="flex:1;background:#007bff" onclick="mqttConnect()">K·∫æT N·ªêI</button>
        <button class="btn-m" style="flex:1" onclick="mqttDisconnect()">NG·∫ÆT</button>
      </div>

      <div class="log-box" id="topicBox" style="height:auto;margin-top:12px">
        <div class="log-entry"><b>Topic EMQX ƒëang d√πng:</b></div>
        <div class="log-entry" id="topicInfo">-</div>
      </div>

      <div style="margin-top:10px;text-align:left;font-size:11px;color:#cfd2d8;opacity:.9">
        L∆∞u √Ω: GitHub Pages ch·ªâ ch·∫°y tr√™n browser n√™n <b>ph·∫£i d√πng MQTT qua WebSocket</b> (ws/wss). Port TCP 1883 kh√¥ng d√πng tr·ª±c ti·∫øp trong browser.
      </div>
    </div>
  </div>

<script>
/* ========= STATE ========= */
let client = null;
let lastUserInteraction = 0;

const state = {
  time_rem: "--:--",
  rem_s: null,
  off_min: null,
  on_sec: null,
  status: "SLEEPING",
  maint_mode: 0,
  pause_active: 0,
  relay_run: false,
  wait5s: false,
  pause_json: "[]"
};

function addLog(msg){
  const box = document.getElementById("logDisplay");
  if(!box) return;
  const t = new Date().toLocaleTimeString('vi-VN', {hour12:false});
  const div = document.createElement("div");
  div.className="log-entry";
  div.textContent = `[${t}] ${msg}`;
  box.prepend(div);
  // gi·ªØ t·ªëi ƒëa ~80 d√≤ng
  while(box.children.length>80) box.removeChild(box.lastChild);
}

/* ========= UI tabs ========= */
function switchTab(t){
  document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
  document.getElementById(t).classList.add('active');
  document.getElementById('tab-'+t).classList.add('active');
}
let scheduleLoaded=false;
function openSchedule(){
  switchTab('schedule');
  if(!scheduleLoaded){ loadPauseFromDevice(); scheduleLoaded=true; }
}

/* ========= Password toggle ========= */
function togglePass(id){
  const x = document.getElementById(id);
  x.type = (x.type === "password") ? "text" : "password";
}

/* ========= Settings persistence (browser) ========= */
function getCfg(){
  const cfg = {
    devid: (document.getElementById('cfg_devid').value || "timer02").trim(),
    host: (document.getElementById('cfg_emqx_host').value || "").trim(),
    wsPort: parseInt(document.getElementById('cfg_emqx_ws_port').value || "8084", 10),
    wsPath: (document.getElementById('cfg_emqx_ws_path').value || "/mqtt").trim(),
    wss: (document.getElementById('cfg_emqx_wss').value || "1") === "1",
    user: (document.getElementById('cfg_emqx_user').value || "").trim(),
    pass: (document.getElementById('cfg_emqx_pass').value || "")
  };
  return cfg;
}
function saveUiSettings(){
  const cfg = getCfg();
  localStorage.setItem("emqx_ui_cfg", JSON.stringify(cfg));
  addLog("Saved UI settings (localStorage)");
  alert("ƒê√£ l∆∞u c·∫•u h√¨nh tr√™n tr√¨nh duy·ªát!");
  updateTopicInfo();
}
function loadUiSettings(){
  try{
    const raw = localStorage.getItem("emqx_ui_cfg");
    if(!raw) return;
    const cfg = JSON.parse(raw);
    if(cfg.devid) document.getElementById('cfg_devid').value = cfg.devid;
    if(cfg.host) document.getElementById('cfg_emqx_host').value = cfg.host;
    if(cfg.wsPort) document.getElementById('cfg_emqx_ws_port').value = cfg.wsPort;
    if(cfg.wsPath) document.getElementById('cfg_emqx_ws_path').value = cfg.wsPath;
    document.getElementById('cfg_emqx_wss').value = cfg.wss ? "1" : "0";
    if(cfg.user) document.getElementById('cfg_emqx_user').value = cfg.user;
    if(cfg.pass !== undefined) document.getElementById('cfg_emqx_pass').value = cfg.pass;
  }catch(e){}
}

/* ========= Topics ========= */
function baseTopic(){
  return "devices/" + getCfg().devid;
}
function topicTelemetry(){ return baseTopic() + "/telemetry"; }
function topicRpcReqPlus(){ return baseTopic() + "/rpc/request/+"; }
function topicRpcRespPlus(){ return baseTopic() + "/rpc/response/+"; }

function updateTopicInfo(){
  const info = [
    `PUB Telemetry: ${topicTelemetry()}`,
    `SUB RPC request: ${topicRpcReqPlus()}`,
    `PUB RPC response: ${baseTopic() + "/rpc/response/{reqId}"}`,
    `RPC payload: {"method":"setOnSec","params":5} (v√≠ d·ª•)`
  ].join("<br>");
  document.getElementById("topicInfo").innerHTML = info;
}

/* ========= MQTT Connect (Browser) ========= */
function mqttConnect(){
  const cfg = getCfg();
  if(!cfg.host){ alert("Thi·∫øu EMQX Host"); return; }

  // Browser ch·ªâ d√πng ws/wss, KH√îNG d√πng 1883 TCP tr·ª±c ti·∫øp.
  const proto = cfg.wss ? "wss" : "ws";
  const url = `${proto}://${cfg.host}:${cfg.wsPort}${cfg.wsPath.startsWith('/')?cfg.wsPath:'/'+cfg.wsPath}`;

  if(client){
    try{ client.end(true); }catch(e){}
    client = null;
  }

  addLog("MQTT connecting: " + url);
  document.getElementById("connBadge").textContent = "MQTT: CONNECTING...";

  client = mqtt.connect(url, {
    username: cfg.user || undefined,
    password: cfg.pass || undefined,
    clientId: cfg.devid + "_web_" + Math.random().toString(16).slice(2,8),
    clean: true,
    keepalive: 60,
    reconnectPeriod: 2000
  });

  client.on("connect", () => {
    addLog("MQTT connected");
    document.getElementById("connBadge").textContent = "MQTT: CONNECTED";
    updateTopicInfo();

    client.subscribe([topicTelemetry(), topicRpcRespPlus()], (err) => {
      if(err) addLog("SUB error: " + err.message);
      else addLog("Subscribed telemetry + rpc/response");
    });
  });

  client.on("reconnect", () => {
    document.getElementById("connBadge").textContent = "MQTT: RECONNECTING...";
  });

  client.on("close", () => {
    document.getElementById("connBadge").textContent = "MQTT: DISCONNECTED";
  });

  client.on("error", (e) => {
    addLog("MQTT error: " + (e && e.message ? e.message : e));
  });

  client.on("message", (topic, payload) => {
    const txt = payload.toString();
    if(topic === topicTelemetry()){
      try{
        const obj = JSON.parse(txt);
        Object.keys(obj).forEach(k => state[k] = obj[k]);
        // ƒë·ªìng b·ªô m·ªôt s·ªë field quen thu·ªôc
        if(obj.time_rem !== undefined) state.time_rem = obj.time_rem;
        renderHome();
        // schedule c·∫ßn d·ªØ li·ªáu pause_json
        if(obj.pause_json !== undefined) {
          state.pause_json = obj.pause_json;
          if(scheduleLoaded) renderPauseFromJson(state.pause_json);
        }
      }catch(e){}
      return;
    }
    // rpc response wildcard
    if(topic.startsWith(baseTopic()+"/rpc/response/")){
      addLog("RPC response: " + txt);
      try{
        const r = JSON.parse(txt);
        // n·∫øu response c√≥ off_min/on_sec th√¨ sync l·∫°i input
        if(r.off_min !== undefined) document.getElementById("offMin").value = r.off_min;
        if(r.on_sec !== undefined) document.getElementById("onSec").value = r.on_sec;
        if(r.saved_off_min !== undefined) document.getElementById("offMin").value = r.saved_off_min;
        if(r.saved_on_sec !== undefined) document.getElementById("onSec").value = r.saved_on_sec;
      }catch(e){}
      return;
    }
  });
}

function mqttDisconnect(){
  if(client){
    try{ client.end(true); }catch(e){}
    client = null;
  }
  document.getElementById("connBadge").textContent = "MQTT: DISCONNECTED";
  addLog("MQTT disconnected");
}

function mqttPublish(topic, msgObj){
  if(!client || !client.connected){
    addLog("MQTT not connected");
    alert("MQTT ch∆∞a k·∫øt n·ªëi!");
    return false;
  }
  const payload = JSON.stringify(msgObj);
  client.publish(topic, payload, {qos:0, retain:false});
  return true;
}

/* ========= RPC helper ========= */
function rpcCall(method, params){
  const reqId = Date.now().toString();
  const t = baseTopic() + "/rpc/request/" + reqId;
  const ok = mqttPublish(t, { method, params });
  if(ok) addLog(`RPC -> ${method} (${reqId})`);
  return reqId;
}

/* ========= HOME actions ========= */
function adjustValue(id,d){
  const i=document.getElementById(id);
  let c=parseInt(i.value)||0;
  let n=c+d;
  if(n<0) n=0;
  if(id==='onSec' && n<1) n=1;
  i.value=n;
  lastUserInteraction=Date.now();
}
document.getElementById('offMin').addEventListener('input',()=>lastUserInteraction=Date.now());
document.getElementById('onSec').addEventListener('input',()=>lastUserInteraction=Date.now());

function applyPreset(m,s){
  document.getElementById('offMin').value = m;
  document.getElementById('onSec').value = s;
  saveSettings();
  lastUserInteraction = Date.now() + 2000;
}

function saveSettings(){
  const m = parseInt(document.getElementById("offMin").value||"0",10);
  const s = parseInt(document.getElementById("onSec").value||"0",10);

  rpcCall("setOffMin", m);
  rpcCall("setOnSec", s);
  rpcCall("save", 1);

  const g=document.getElementById("saveMsg");
  g.style.display="block"; setTimeout(()=>g.style.display="none", 2000);
  lastUserInteraction=0;
}

function setMaint(mode){
  rpcCall("setMaintenance", mode);
}

/* ========= HOME render ========= */
function renderHome(){
  // timer
  const timerText = (state.time_rem && String(state.time_rem).length>0) ? String(state.time_rem) : "--:--";
  document.getElementById("timerDisplay").textContent = timerText;

  // badge logic gi·ªëng webserver
  const b = document.getElementById("statusBadge");
  const pb = document.getElementById("progressBar");
  const timerBox = document.getElementById("timerDisplay");

  let accentColor="#28a745";
  let accentGlow="rgba(40, 167, 69, 0.55)";

  const pause = (Number(state.pause_active)||0) > 0;
  const maint = Number(state.maint_mode)||0;
  const relay = !!state.relay_run;

  // wait5s: firmware c√≥ tr·∫°ng th√°i "CHO RESET" -> m√¨nh suy ra n·∫øu status == "CHO RESET"
  const wait5s = (String(state.status||"").toUpperCase().includes("CHO RESET")) || (String(state.status||"").toUpperCase().includes("WAIT"));

  if(pause){
    b.innerHTML="‚è∏ ƒêANG NGH·ªà"; b.className="status-badge status-off";
    pb.style.width="100%"; pb.style.backgroundColor="#6c757d";
    accentColor="#6c757d"; accentGlow="rgba(108, 117, 125, 0.55)";
  } else if(maint>0){
    b.innerHTML="üîß ƒêANG B·∫¢O TR√å"; b.className="status-badge status-maint";
    pb.style.width="100%"; pb.style.backgroundColor="#dc3545";
    accentColor="#dc3545"; accentGlow="rgba(220, 53, 69, 0.55)";
  } else if(relay){
    b.innerHTML="RUNNING (ON)"; b.className="status-badge status-on";
    pb.style.backgroundColor="#28a745";
    accentColor="#28a745"; accentGlow="rgba(40, 167, 69, 0.55)";
    // % ON d·ª±a theo on_sec (n·∫øu c√≥) v√† rem_s
    const total = Number(state.on_sec)||0;
    const cur = Number(state.rem_s)||0;
    if(total>0 && cur>=0) pb.style.width = (cur/total*100) + "%";
  } else if(wait5s){
    b.innerHTML="WAITING RESET."; b.className="status-badge status-wait";
    pb.style.backgroundColor="#ffc107";
    accentColor="#ffc107"; accentGlow="rgba(255, 193, 7, 0.55)";
    pb.style.width="100%";
  } else {
    b.innerHTML="SLEEPING (OFF)"; b.className="status-badge status-off";
    pb.style.backgroundColor="#6c757d";
    accentColor="#6c757d"; accentGlow="rgba(108, 117, 125, 0.55)";
    // % OFF d·ª±a theo off_min v√† rem_s
    const total = (Number(state.off_min)||0) * 60;
    const cur = Number(state.rem_s)||0;
    if(total>0 && cur>=0) pb.style.width = (cur/total*100) + "%";
  }

  timerBox.style.setProperty("--accent", accentColor);
  timerBox.style.setProperty("--accentGlow", accentGlow);
  timerBox.style.boxShadow = "0 0 0 1px rgba(255,255,255,0.1), 0 0 28px " + accentGlow;

  // sync inputs n·∫øu user kh√¥ng ƒëang ch·ªânh
  if(Date.now()-lastUserInteraction>5000){
    if(state.off_min !== null && state.off_min !== undefined) document.getElementById("offMin").value = state.off_min;
    if(state.on_sec !== null && state.on_sec !== undefined) document.getElementById("onSec").value = state.on_sec;
  }
}

/* ========= SCHEDULE logic (copy theo webserver, ch·ªâ ƒë·ªïi ph·∫ßn load/save) ========= */
let pauseRanges=[];

function renderPauseTable(){
  const tb=document.getElementById('pauseTbody');
  if(!tb) return;
  tb.innerHTML="";
  if(!Array.isArray(pauseRanges)) pauseRanges=[];
  if(pauseRanges.length===0){
    tb.innerHTML='<tr><td colspan="4" style="color:#8e8e93;padding:15px">Ch∆∞a c√≥ m·ªëc. B·∫•m <b>+ Th√™m m·ªëc</b></td></tr>';
    return;
  }

  const labels=["CN","T2","T3","T4","T5","T6","T7"]; // 0=CN, 1=T2...
  pauseRanges.forEach(function(r, idx){
    const s=(r&&r.s)?String(r.s):"12:00";
    const e=(r&&r.e)?String(r.e):"13:00";
    const on=(r&&Number(r.on)===1);
    const w=(r && r.w !== undefined) ? r.w : 127;

    let daysHtml = '<div class="day-selector">';
    for(let i=1;i<=7;i++){
      const bitIdx = (i==7) ? 0 : i;
      const isActive = (w & (1<<bitIdx));
      daysHtml += `<div class="day-btn ${isActive?'active':''}" onclick="toggleDay(${idx},${bitIdx},this)">${labels[bitIdx]}</div>`;
    }
    daysHtml += '</div>';

    const tr1=document.createElement('tr');
    tr1.setAttribute('data-row','time');
    tr1.innerHTML =
      `<td><input type="time" value="${s}" data-idx="${idx}" data-k="s" onchange="onPauseCellChange(this)"></td>`+
      `<td><input type="time" value="${e}" data-idx="${idx}" data-k="e" onchange="onPauseCellChange(this)"></td>`+
      `<td style="text-align:center"><label class="switch"><input type="checkbox" ${on?'checked':''} data-idx="${idx}" data-k="on" onchange="onPauseToggle(this)"><span class="slider"></span></label></td>`+
      `<td style="text-align:center"><button class="btn-del" onclick="deletePauseRow(${idx})">X</button></td>`;
    tb.appendChild(tr1);

    const tr2=document.createElement('tr');
    tr2.className='pause-day-row';
    tr2.setAttribute('data-row','days');
    tr2.innerHTML = `<td colspan="2" style="padding-top:2px;padding-bottom:10px">${daysHtml}</td><td></td><td></td>`;
    tb.appendChild(tr2);
  });
}

function onPauseCellChange(el){
  const idx=parseInt(el.getAttribute('data-idx')||"0",10);
  const k=el.getAttribute('data-k');
  if(!pauseRanges[idx]) pauseRanges[idx]={s:"12:00",e:"13:00",on:1,w:127};
  pauseRanges[idx][k]=el.value;
}
function onPauseToggle(el){
  const idx=parseInt(el.getAttribute('data-idx')||"0",10);
  if(!pauseRanges[idx]) pauseRanges[idx]={s:"12:00",e:"13:00",on:1,w:127};
  pauseRanges[idx].on = el.checked ? 1 : 0;
}
function toggleDay(idx, bit, el){
  if(!pauseRanges[idx]) return;
  let w = (pauseRanges[idx].w !== undefined) ? pauseRanges[idx].w : 127;
  const mask = 1 << bit;
  if(w & mask){ w &= ~mask; if(el) el.classList.remove('active'); }
  else { w |= mask; if(el) el.classList.add('active'); }
  pauseRanges[idx].w = w;
}
function addPauseRow(){
  if(!Array.isArray(pauseRanges)) pauseRanges=[];
  pauseRanges.push({s:"11:00", e:"05:00", on:1, w:127});
  renderPauseTable();
}
function deletePauseRow(idx){
  if(!Array.isArray(pauseRanges)) return;
  pauseRanges.splice(idx,1);
  renderPauseTable();
}

function renderPauseFromJson(j){
  try{
    const arr = JSON.parse(j || "[]");
    if(Array.isArray(arr)) pauseRanges = arr;
    else pauseRanges = [];
  }catch(e){ pauseRanges=[]; }
  renderPauseTable();
}

function loadPauseFromDevice(){
  // firmware s·∫Ω publish pause_json khi k·∫øt n·ªëi EMQX, ho·∫∑c khi b·∫°n m·ªü tab schedule
  renderPauseFromJson(state.pause_json);
  addLog("Schedule loaded from latest telemetry (pause_json)");
}

function savePause(){
  if(!Array.isArray(pauseRanges)) pauseRanges=[];
  const j = JSON.stringify(pauseRanges || []);
  if(j.length > 1000){
    alert("JSON qu√° d√†i (>1000). H√£y gi·∫£m s·ªë m·ªëc!");
    return;
  }
  // rpcSetPauseJson ch·∫•p nh·∫≠n params l√† string ho·∫∑c object {json: "..."}
  rpcCall("setPauseJson", { json: j });
  addLog("Schedule saved via RPC setPauseJson (len=" + j.length + ")");
  alert("ƒê√£ g·ª≠i l·ªãch ngh·ªâ (RPC).");
}

/* ========= Boot ========= */
loadUiSettings();
updateTopicInfo();
renderHome();

// Auto connect on load
setTimeout(mqttConnect, 350);
</script>

</body>
</html>
