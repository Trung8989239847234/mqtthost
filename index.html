<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ESP32 MULTI-TIMER PRO</title>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root { 
      --bg: #0f172a; 
      --card-bg: rgba(30, 41, 59, 0.7);
      --accent: #3b82f6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
    }
    
    body {
      font-family: -apple-system, system-ui, sans-serif;
      background: var(--bg);
      color: #fff;
      margin: 0;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    .container { width: 100%; max-width: 800px; }

    header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px; width: 100%;
    }

    .title-area h1 { font-size: 18px; margin: 0; letter-spacing: 1px; color: #94a3b8; }
    .status-chips { display: flex; gap: 8px; font-size: 12px; }
    .chip { padding: 4px 10px; border-radius: 20px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); }
    .chip.online { border-color: var(--success); color: var(--success); }

    /* === GRID LAYOUT === */
    .device-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    @media (max-width: 480px) { .device-grid { grid-template-columns: 1fr; } }

    .device-card {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 16px;
      border: 1px solid rgba(255,255,255,0.08);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .device-card:hover { transform: translateY(-4px); border-color: var(--accent); }
    .device-card.selected { border-color: var(--accent); box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
    
    .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .dev-name { font-weight: 800; font-size: 14px; color: #64748b; }
    .dev-id { font-size: 10px; color: #475569; }
    .dev-status-dot { width: 8px; height: 8px; border-radius: 50%; background: #334155; }
    .dev-status-dot.active { background: var(--success); box-shadow: 0 0 8px var(--success); }

    .card-body { text-align: center; padding: 10px 0; }
    .big-time { font-family: 'Courier New', monospace; font-size: 36px; font-weight: 700; color: #e2e8f0; }
    .small-status { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: #64748b; margin-top: 4px; }

    .card-footer { 
      display: flex; justify-content: space-between; margin-top: 12px; 
      font-size: 12px; color: #94a3b8; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 8px;
    }

    /* === DETAIL PANEL (Overlay or Slide) === */
    #detailPanel {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: #1e293b;
      border-top-left-radius: 30px; border-top-right-radius: 30px;
      padding: 24px;
      box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
      z-index: 100;
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      max-height: 80vh; overflow-y: auto;
    }
    #detailPanel.open { transform: translateY(0); }
    .close-bar { width: 40px; height: 4px; background: #334155; border-radius: 2px; margin: -10px auto 20px; cursor: pointer; }

    /* Controls & Forms */
    .control-group { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px; margin-bottom: 15px; }
    .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .btn-save { background: var(--accent); border: none; color: white; padding: 12px; width: 100%; border-radius: 12px; font-weight: 700; cursor: pointer; }
    
    /* AI Mini floating */
    .ai-fab {
      position: fixed; right: 20px; bottom: 20px;
      width: 56px; height: 56px; border-radius: 28px;
      background: linear-gradient(135deg, #8b5cf6, #d946ef);
      display: flex; justify-content: center; align-items: center;
      font-size: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 90;
    }

    /* Toast */
    #toast {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(15,23,42,0.9); padding: 10px 20px; border-radius: 50px;
      font-size: 13px; z-index: 1000; display: none; border: 1px solid var(--accent);
    }
  </style>
</head>
<body>

  <div id="toast">Th√¥ng b√°o</div>

  <div class="container">
    <header>
      <div class="title-area">
        <h1>IOT DASHBOARD</h1>
        <div style="font-size: 10px; color: #475569;">MULTI-DEVICE CONTROL</div>
      </div>
      <div class="status-chips">
        <div id="mqttStatus" class="chip">MQTT: DISCONNECTED</div>
      </div>
    </header>

    <div class="device-grid" id="deviceGrid">
      <!-- 4 Cards will be generated here -->
    </div>

    <!-- AI Input Area -->
    <div class="control-group">
      <div style="font-size: 12px; color: #94a3b8; margin-bottom: 8px;">TR·ª¢ L√ù AI (H·ªèi v·ªÅ 4 thi·∫øt b·ªã)</div>
      <div style="display: flex; gap: 8px;">
        <input type="text" id="aiQuery" style="flex:1; background: #000; border: 1px solid #334155; color: #fff; padding: 10px; border-radius: 8px;" placeholder="V√≠ d·ª•: Thi·∫øt b·ªã n√†o ƒëang n√≥ng nh·∫•t?">
        <button onclick="askAI()" style="background: #8b5cf6; border: none; color: #fff; padding: 0 15px; border-radius: 8px; cursor: pointer;">H·ªèi</button>
      </div>
    </div>
  </div>

  <!-- Detail Panel -->
  <div id="detailPanel">
    <div class="close-bar" onclick="closeDetail()"></div>
    <div id="detailContent">
      <h2 id="detName" style="margin: 0 0 5px 0;">DEVICE NAME</h2>
      <div id="detId" style="font-size: 12px; color: #64748b; margin-bottom: 20px;">ID: timerxx</div>
      
      <div class="control-group">
        <div class="row">
          <span>Th·ªùi gian ngh·ªâ (Ph√∫t)</span>
          <input type="number" id="inpOff" style="width: 60px; text-align: center; background: #000; color: #fff; border: 1px solid #334155; padding: 5px; border-radius: 5px;">
        </div>
        <div class="row">
          <span>Th·ªùi gian ch·∫°y (Gi√¢y)</span>
          <input type="number" id="inpOn" style="width: 60px; text-align: center; background: #000; color: #fff; border: 1px solid #334155; padding: 5px; border-radius: 5px;">
        </div>
        <button class="btn-save" onclick="saveSelectedDevice()">L∆ØU C√ÄI ƒê·∫∂T XU·ªêNG THI·∫æT B·ªä</button>
      </div>

      <div class="control-group">
        <div style="font-size: 11px; color: #64748b; margin-bottom: 10px;">B·∫¢O TR√å NHANH</div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
           <button onclick="setMaint(0)" style="padding: 10px; border-radius: 8px; border: 1px solid #ef4444; color: #ef4444; background: none;">H·ª¶Y</button>
           <button onclick="setMaint(1)" style="padding: 10px; border-radius: 8px; border: 1px solid #94a3b8; color: #94a3b8; background: none;">7P</button>
           <button onclick="setMaint(6)" style="padding: 10px; border-radius: 8px; border: 1px solid #f59e0b; color: #f59e0b; background: none;">V√î H·∫†N</button>
        </div>
      </div>
    </div>
  </div>

  <div class="ai-fab" onclick="alert('Dr.AI ƒëang l·∫Øng nghe...')">‚ú®</div>

<script>
/* ========= CONFIG ========= */
const DEVICE_IDS = ["timer01", "timer02", "timer03", "timer04"];
const MQTT_CONFIG = {
  host: "n21f2dda.ala.dedicated.aws.emqxcloud.com",
  port: 8084,
  user: "anhtrung1",
  pass: "anhtrung1",
  path: "/mqtt"
};

let client = null;
let selectedDeviceId = null;

// Kh·ªüi t·∫°o state cho 4 thi·∫øt b·ªã
window.devices = {};
DEVICE_IDS.forEach(id => {
  window.devices[id] = {
    online: false,
    status: "OFFLINE",
    time_rem: "--:--",
    amps: 0,
    temp: 0,
    off_min: 1,
    on_sec: 5,
    lastSeen: 0
  };
});

/* ========= MQTT LOGIC ========= */
function connectMQTT() {
  const url = `wss://${MQTT_CONFIG.host}:${MQTT_CONFIG.port}${MQTT_CONFIG.path}`;
  client = mqtt.connect(url, {
    username: MQTT_CONFIG.user,
    password: MQTT_CONFIG.pass,
    clientId: "web_dashboard_" + Math.random().toString(16).slice(2, 8)
  });

  client.on("connect", () => {
    document.getElementById("mqttStatus").innerText = "MQTT: CONNECTED";
    document.getElementById("mqttStatus").classList.add("online");
    // Subscribe t·∫•t c·∫£ thi·∫øt b·ªã c√≥ prefix devices/
    client.subscribe("devices/+/telemetry");
    client.subscribe("devices/+/rpc/response/+");
    showToast("ƒê√£ k·∫øt n·ªëi Server");
  });

  client.on("message", (topic, payload) => {
    const parts = topic.split('/');
    const devId = parts[1];
    if (!DEVICE_IDS.includes(devId)) return;

    try {
      const data = JSON.parse(payload.toString());
      // C·∫≠p nh·∫≠t state thi·∫øt b·ªã c·ª• th·ªÉ
      Object.assign(window.devices[devId], data);
      window.devices[devId].online = true;
      window.devices[devId].lastSeen = Date.now();
      
      renderGrid();
      if (selectedDeviceId === devId) updateDetailView();
    } catch(e) { console.error("Data error", e); }
  });
}

/* ========= UI RENDER ========= */
function renderGrid() {
  const grid = document.getElementById("deviceGrid");
  grid.innerHTML = "";

  DEVICE_IDS.forEach(id => {
    const dev = window.devices[id];
    const isOnline = (Date.now() - dev.lastSeen < 15000);
    
    const card = document.createElement("div");
    card.className = `device-card ${selectedDeviceId === id ? 'selected' : ''}`;
    card.onclick = () => openDetail(id);

    card.innerHTML = `
      <div class="card-header">
        <div>
          <div class="dev-name">THI·∫æT B·ªä ${id.slice(-2)}</div>
          <div class="dev-id">${id}</div>
        </div>
        <div class="dev-status-dot ${isOnline ? 'active' : ''}"></div>
      </div>
      <div class="card-body">
        <div class="big-time">${dev.time_rem}</div>
        <div class="small-status">${dev.status}</div>
      </div>
      <div class="card-footer">
        <span>üå° ${dev.temp}¬∞C</span>
        <span>‚ö° ${dev.amps}A</span>
      </div>
    `;
    grid.appendChild(card);
  });
}

function openDetail(id) {
  selectedDeviceId = id;
  const dev = window.devices[id];
  
  document.getElementById("detName").innerText = "THI·∫æT B·ªä " + id.slice(-2);
  document.getElementById("detId").innerText = "ID: " + id;
  document.getElementById("inpOff").value = dev.off_min || 1;
  document.getElementById("inpOn").value = dev.on_sec || 5;
  
  document.getElementById("detailPanel").classList.add("open");
  renderGrid(); // update border selected
}

function closeDetail() {
  selectedDeviceId = null;
  document.getElementById("detailPanel").classList.remove("open");
  renderGrid();
}

function updateDetailView() {
  const dev = window.devices[selectedDeviceId];
  // C·∫≠p nh·∫≠t ng·∫ßm c√°c con s·ªë n·∫øu c·∫ßn
}

/* ========= ACTIONS ========= */
function saveSelectedDevice() {
  if (!selectedDeviceId) return;
  const m = parseInt(document.getElementById("inpOff").value);
  const s = parseInt(document.getElementById("inpOn").value);
  
  const topic = `devices/${selectedDeviceId}/rpc/request/${Date.now()}`;
  client.publish(topic, JSON.stringify({ method: "setOffMin", params: m }));
  client.publish(topic, JSON.stringify({ method: "setOnSec", params: s }));
  client.publish(topic, JSON.stringify({ method: "save", params: 1 }));
  
  showToast("ƒê√£ g·ª≠i l·ªánh t·ªõi " + selectedDeviceId);
}

function setMaint(mode) {
  if (!selectedDeviceId) return;
  const topic = `devices/${selectedDeviceId}/rpc/request/${Date.now()}`;
  client.publish(topic, JSON.stringify({ method: "setMaintenance", params: mode }));
  showToast("G·ª≠i l·ªánh b·∫£o tr√¨...");
}

function showToast(m) {
  const t = document.getElementById("toast");
  t.innerText = m; t.style.display = "block";
  setTimeout(() => t.style.display = "none", 3000);
}

// Watchdog ki·ªÉm tra Offline
setInterval(() => {
  renderGrid();
}, 5000);

/* ========= AI LOGIC (M·∫´u) ========= */
async function askAI() {
  const q = document.getElementById("aiQuery").value;
  const geminiKey = "AIzaSyB5K7JbtmLiQ4t-HpcB6wrzPBhJ5PWcFhs"; // L·∫•y t·ª´ config c·ªßa b·∫°n
  
  const context = JSON.stringify(window.devices);
  const prompt = `D·ªØ li·ªáu 4 thi·∫øt b·ªã IoT: ${context}. C√¢u h·ªèi ng∆∞·ªùi d√πng: ${q}. H√£y tr·∫£ l·ªùi ng·∫Øn g·ªçn, ti·∫øng Vi·ªát.`;
  
  showToast("AI ƒëang suy nghƒ©...");
  try {
    const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiKey}`, {
      method: "POST",
      body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
    });
    const d = await resp.json();
    alert("ü§ñ Dr.AI: " + d.candidates[0].content.parts[0].text);
  } catch(e) { alert("L·ªói k·∫øt n·ªëi AI"); }
}

// Kh·ªüi ƒë·ªông
connectMQTT();
renderGrid();
</script>
</body>
</html>
