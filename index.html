<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>IOT ECOSYSTEM v2.0 (Pro)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

    <style>
        /* T·ªëi ∆∞u hi·ªáu nƒÉng render b·∫±ng contain v√† will-change */
        :root {
            --bg: #020617;
            /* Deep slate */
            --card-bg: rgba(30, 41, 59, 0.3);
            --card-border: rgba(255, 255, 255, 0.1);
            --accent: #38bdf8;
            --accent-glow: 0 0 20px rgba(56, 189, 248, 0.3);
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --ai-gradient: linear-gradient(135deg, #a855f7, #ec4899);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, #020617, #0f172a, #1e1b4b);
            background-attachment: fixed;
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Ambient Glow - REMOVED FOR PERFORMANCE
        body::before { ... }
        body::after { ... } 
        */

        /* === LOGIN OVERLAY === */
        #loginOverlay {
            position: fixed;
            inset: 0;
            background: #0f172a;
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .login-box {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 300px;
        }

        .login-title {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 10px;
            background: var(--ai-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-input {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #334155;
            color: #fff;
            border-radius: 12px;
            box-sizing: border-box;
            font-size: 16px;
            text-align: center;
            margin: 20px 0;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 12px;
            background: var(--accent);
            color: white;
            font-weight: 700;
            cursor: pointer;
            font-size: 14px;
        }

        .login-btn.secondary {
            background: rgba(148, 163, 184, 0.2);
            border: 1px solid #475569;
            margin-top: 10px;
        }

        .login-btn.google {
            background: #fff;
            color: #0f172a;
            margin-top: 10px;
        }

        /* === HEADER === */
        .container {
            width: 95%;
            max-width: 1200px;
            padding: 20px;
            box-sizing: border-box;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .logo-area h1 {
            font-size: 20px;
            margin: 0;
            font-weight: 800;
            letter-spacing: 1px;
            color: #fff;
        }

        .logo-area span {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            font-weight: 700;
        }

        .btn-circle {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: 0.3s;
            font-size: 20px;
        }

        .btn-circle:hover {
            background: var(--accent);
        }

        /* === GRID THI·∫æT B·ªä === */
        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
            contain: layout paint;
        }

        .device-card {
            background: rgba(30, 41, 59, 0.6);
            /* TƒÉng ƒë·ªô ƒë·ª•c ƒë·ªÉ gi·∫£m g√°nh n·∫∑ng t√≠nh to√°n blur */
            backdrop-filter: blur(10px);
            /* Gi·∫£m t·ª´ 20px xu·ªëng 10px */
            -webkit-backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 24px;
            border: 1px solid var(--card-border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            will-change: transform, opacity;
            contain: content;
            /* T·ªëi ∆∞u render */
        }

        .device-card:hover {
            transform: translateY(-5px) scale(1.02);
            border-color: rgba(56, 189, 248, 0.4);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), var(--accent-glow);
            background: rgba(255, 255, 255, 0.05);
        }

        .device-card.offline {
            opacity: 0.6;
            filter: grayscale(1);
        }

        .card-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            pointer-events: none;
        }

        .card-right {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .card-id {
            font-size: 11px;
            font-weight: 800;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .card-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #334155;
            transition: background 0.3s;
        }

        .card-dot.on {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }

        .mode-badge-mini {
            min-width: 22px;
            height: 14px;
            padding: 0 3px;
            border-radius: 10px;
            background: #ef4444;
            color: #fff;
            font-size: 8px;
            font-weight: 800;
            display: none;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .card-main-stats {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-grow: 1;
            padding: 10px 0;
            pointer-events: none;
        }

        .stat-item {
            text-align: center;
        }

        .stat-icon {
            font-size: 18px;
            margin-bottom: -5px;
            opacity: 0.6;
        }

        .stat-icon.run-spin {
            animation: runRotate 1s linear infinite;
            opacity: 1;
        }

        .stat-value {
            font-size: 48px;
            font-weight: 800;
            line-height: 1;
            letter-spacing: -1px;
        }

        .stat-unit {
            font-size: 12px;
            font-weight: 700;
            opacity: 0.5;
            margin-left: 2px;
        }

        .stat-item.off .stat-value {
            color: #94a3b8;
        }

        .stat-item.on .stat-value {
            color: var(--warning);
        }

        .card-timer-mini {
            margin-top: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            pointer-events: none;
            text-align: center;
        }

        .mini-time {
            font-family: 'Courier New', monospace;
            font-size: 20px;
            font-weight: 700;
            color: #fff;
            letter-spacing: 1px;
        }

        .mini-status {
            font-size: 9px;
            text-transform: uppercase;
            color: var(--accent);
            font-weight: 700;
            margin-top: 2px;
            display: block;
        }

        .mini-status.off {
            color: var(--text-dim);
        }

        /* === PANEL ƒêI·ªÄU KHI·ªÇN CHI TI·∫æT === */
        .panel-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: flex-end;
        }

        .panel {
            width: 100%;
            max-width: 500px;
            background: #1e293b;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            padding: 24px;
            box-sizing: border-box;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.33, 1, 0.68, 1);
            box-shadow: 0 -10px 50px rgba(0, 0, 0, 0.5);
            max-height: 90vh;
            overflow-y: auto;
            will-change: transform;
        }

        .panel.show {
            transform: translateY(0);
        }

        .handle {
            width: 40px;
            height: 4px;
            background: #475569;
            border-radius: 2px;
            margin: 0 auto 20px;
            cursor: pointer;
        }

        /* === NEW BIG CONTROL GROUP === */
        .info-group {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 20px;
            padding: 25px 0;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .info-item {
            text-align: center;
            flex: 1;
        }

        .info-label {
            font-size: 11px;
            color: #94a3b8;
            font-weight: 800;
            text-transform: uppercase;
            margin-bottom: 5px;
            display: block;
            letter-spacing: 0.5px;
        }

        .info-val-input {
            width: 70px;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 42px;
            font-weight: 800;
            text-align: center;
            outline: none;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            -moz-appearance: textfield;
            letter-spacing: -1px;
        }

        .info-val-input::-webkit-outer-spin-button,
        .info-val-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .info-unit {
            font-size: 14px;
            color: #64748b;
            font-weight: 700;
            margin-left: 2px;
        }

        .info-div {
            width: 1px;
            height: 60px;
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-step-big {
            width: 38px;
            height: 38px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.08);
            border: none;
            color: #fff;
            font-size: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }

        .btn-step-big:active {
            transform: scale(0.9);
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-step-big:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* PRESETS & BUTTONS */
        .presets-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 20px;
        }

        .btn-preset {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ccc;
            border-radius: 12px;
            padding: 10px;
            font-size: 11px;
            cursor: pointer;
            transition: .2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .btn-preset:active {
            transform: scale(0.96);
        }

        .btn-preset span {
            display: block;
            font-weight: 800;
            font-size: 12px;
            margin-bottom: 4px;
            color: #fff;
        }

        .btn-save-main {
            width: 100%;
            padding: 16px;
            border-radius: 16px;
            border: none;
            background: var(--accent);
            color: white;
            font-weight: 800;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-save-main:active {
            transform: scale(0.98);
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.2);
        }

        .maintenance-title {
            font-size: 11px;
            font-weight: 800;
            color: #64748b;
            margin: 25px 0 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .maintenance-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .btn-m {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.05);
            color: #94a3b8;
            padding: 10px;
            border-radius: 10px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-m:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .btn-manual {
            color: var(--warning);
            border-color: rgba(245, 158, 11, 0.2);
        }

        .btn-cancel {
            background: rgba(239, 68, 68, 0.15);
            color: #ff453a;
            border: 1px solid rgba(239, 68, 68, 0.3);
            margin-top: 10px;
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-force {
            background: rgba(59, 130, 246, 0.18);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.4);
            margin-top: 10px;
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-schedule {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
            font-size: 12px;
        }

        .dm-content {
            width: 95%;
            max-width: 520px;
            background: #1e293b;
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
            max-height: 85vh;
            overflow-y: auto;
        }

        .dm-list {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .dm-item {
            display: grid;
            grid-template-columns: 1fr 70px 70px;
            gap: 8px;
            align-items: center;
            background: rgba(255, 255, 255, .04);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 12px;
            padding: 8px;
        }

        .dm-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #334155;
            color: #fff;
            border-radius: 10px;
            padding: 9px;
            font-size: 12px;
            box-sizing: border-box;
        }

        .dm-btn {
            background: rgba(59, 130, 246, .2);
            color: #93c5fd;
            border: 1px solid rgba(59, 130, 246, .4);
            border-radius: 10px;
            padding: 9px 8px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
        }

        .dm-btn.warn {
            background: rgba(245, 158, 11, .2);
            color: #fbbf24;
            border-color: rgba(245, 158, 11, .4);
        }

        .dm-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        /* === AI FAB & TOAST === */
        .ai-fab {
            position: fixed;
            right: 25px;
            bottom: 25px;
            width: 56px;
            height: 56px;
            background: var(--ai-gradient);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
            z-index: 900;
            transition: transform 0.2s;
        }

        .ai-fab:active {
            transform: scale(0.9);
        }

        #toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #334155;
            color: #fff;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
            display: none;
            z-index: 3000;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* === AI MODAL === */
        #aiModal {
            display: none;
            z-index: 1100;
            align-items: center;
            justify-content: center;
        }

        .ai-content {
            width: 90%;
            max-width: 400px;
            background: #1e293b;
            border-radius: 24px;
            padding: 25px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
        }

        .ai-title {
            font-size: 16px;
            font-weight: 800;
            background: var(--ai-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            margin: 0;
        }

        .ai-input-group {
            position: relative;
        }

        .ai-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #334155;
            color: #fff;
            padding: 12px;
            padding-right: 40px;
            border-radius: 12px;
            box-sizing: border-box;
            font-size: 14px;
        }

        .ai-input:focus {
            border-color: #8b5cf6;
            outline: none;
        }

        .btn-mic {
            position: absolute;
            right: 5px;
            top: 5px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: 0.2s;
        }

        .btn-mic.listening {
            background: rgba(239, 68, 68, 0.2);
            animation: pulse 1.5s infinite;
        }

        .ai-actions {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        .btn-ai {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            font-size: 12px;
            color: #fff;
            transition: 0.2s;
        }

        .btn-ai-send {
            background: var(--ai-gradient);
        }

        .btn-ai-analyze {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-ai-analyze:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .ai-response {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 12px;
            font-size: 13px;
            color: #e2e8f0;
            line-height: 1.5;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            border-left: 3px solid #8b5cf6;
        }

        .ai-key-input {
            font-size: 11px;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #334155;
            background: #0f172a;
            color: #94a3b8;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 5px;
        }

        /* === SCHEDULE MODAL STYLES === */
        #scheduleModal {
            display: none;
            z-index: 1200;
            align-items: center;
            justify-content: center;
        }

        .schedule-content {
            width: 95%;
            max-width: 450px;
            background: #1e293b;
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
            max-height: 85vh;
            overflow-y: auto;
        }

        .guide-content {
            width: 95%;
            max-width: 520px;
            background: #1e293b;
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
            max-height: 85vh;
            overflow-y: auto;
        }

        .guide-content h4 {
            margin: 12px 0 8px;
            color: #93c5fd;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .guide-content ul {
            margin: 0 0 10px 18px;
            padding: 0;
            color: #cbd5e1;
            font-size: 13px;
            line-height: 1.5;
        }

        .guide-content li {
            margin-bottom: 6px;
        }

        /* === SETTINGS MODAL STYLES === */
        #settingsModal {
            display: none;
            z-index: 1300;
            align-items: center;
            justify-content: center;
        }

        .settings-content {
            width: 95%;
            max-width: 600px;
            background: #1e293b;
            border-radius: 24px;
            padding: 0;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .settings-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
        }

        .settings-body {
            display: flex;
            flex: 1;
            overflow: hidden;
            height: 500px;
        }

        .settings-nav {
            width: 140px;
            background: rgba(0, 0, 0, 0.1);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
            padding: 10px;
            gap: 5px;
        }

        .nav-item {
            padding: 12px 10px;
            margin-bottom: 2px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            color: #94a3b8;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
        }

        .nav-item.active {
            background: var(--accent);
            color: #fff;
            box-shadow: 0 4px 12px rgba(56, 189, 248, 0.3);
        }

        .settings-main {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .tab-pane {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-pane.active {
            display: block;
        }

        .tab-title {
            font-size: 14px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            text-transform: uppercase;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive Settings */
        @media (max-width: 600px) {
            .settings-body {
                flex-direction: column;
            }

            .settings-nav {
                width: 100%;
                flex-direction: row;
                overflow-x: auto;
                border-right: none;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                padding: 10px;
                box-sizing: border-box;
            }

            .nav-item {
                flex: none;
                font-size: 11px;
                padding: 8px 12px;
            }

            .settings-content {
                height: 90vh;
            }
        }

        .sched-list {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .sched-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 8px;
        }

        .sched-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .sched-time input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #334155;
            color: #fff;
            padding: 5px;
            border-radius: 6px;
            width: 60px;
            text-align: center;
        }

        .day-select {
            display: flex;
            gap: 4px;
            justify-content: space-between;
        }

        .d-btn {
            width: 100%;
            text-align: center;
            padding: 6px 0;
            border-radius: 6px;
            font-size: 10px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            color: #94a3b8;
            font-weight: 700;
        }

        .d-btn.act {
            background: rgba(59, 130, 246, 0.3);
            color: #fff;
            border: 1px solid rgba(59, 130, 246, 0.5);
        }

        .sw {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }

        .sw input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .sl {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #475569;
            transition: .2s;
            border-radius: 20px;
        }

        .sl:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .2s;
            border-radius: 50%;
        }

        input:checked+.sl {
            background-color: #10b981;
        }

        input:checked+.sl:before {
            transform: translateX(14px);
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        @keyframes runRotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div id="toast">Th√¥ng b√°o</div>

    <!-- LOGIN OVERLAY -->
    <div id="loginOverlay">
        <div class="login-box">
            <div class="login-title">IOT LOGIN</div>
            <p style="color:#94a3b8; font-size:12px">Nh·∫≠p M√£ Kh√°ch H√†ng ƒë·ªÉ qu·∫£n l√Ω thi·∫øt b·ªã</p>
            <input type="text" id="loginUser" class="login-input" placeholder="V√≠ d·ª•: user01">
            <input type="password" id="loginPass" class="login-input" placeholder="M·∫≠t kh·∫©u" value="">
            <button class="login-btn" onclick="performLogin()">TRUY C·∫¨P H·ªÜ TH·ªêNG</button>
            <button class="login-btn google" onclick="performGoogleLogin()">ƒêƒÇNG NH·∫¨P B·∫∞NG GOOGLE</button>
            <button class="login-btn secondary" onclick="registerAccount()">T·∫†O T√ÄI KHO·∫¢N</button>
        </div>
    </div>

    <!-- AI MODAL -->
    <div id="aiModal" class="panel-overlay" onclick="if(event.target.id==='aiModal') closeAI()">
        <div class="ai-content">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <h3 class="ai-title">‚ú® TRUNG T√ÇM AI</h3>
                <button onclick="closeAI()"
                    style="background:none; border:none; color:#94a3b8; font-size:20px; cursor:pointer;">&times;</button>
            </div>
            <input type="password" id="geminiKey" class="ai-key-input"
                placeholder="D√°n Gemini API Key v√†o ƒë√¢y (L∆∞u t·ª± ƒë·ªông)" onchange="saveGeminiKey(this.value)">
            <div class="ai-input-group">
                <input type="text" id="aiCommand" class="ai-input"
                    placeholder="Nh·∫≠p l·ªánh ho·∫∑c h·ªèi (VD: B·∫≠t m√°y 1 10 ph√∫t)">
                <button class="btn-mic" onclick="startVoice(this)">üé§</button>
            </div>
            <div class="ai-actions">
                <button class="btn-ai btn-ai-send" onclick="executeAI()">üöÄ G·ª¨I L·ªÜNH</button>
                <button class="btn-ai btn-ai-analyze" onclick="analyzeSystem()">üè• KH√ÅM B·ªÜNH</button>
            </div>
            <div id="aiResponse" class="ai-response"></div>
        </div>
    </div>

    <!-- SCHEDULE MODAL -->
    <div id="scheduleModal" class="panel-overlay" onclick="if(event.target.id==='scheduleModal') closeSchedule()">
        <div class="schedule-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
                <h3 style="margin:0; color:#fff">üìÖ H·∫∏N GI·ªú NGH·ªà</h3>
                <button onclick="closeSchedule()"
                    style="background:none; border:none; color:#94a3b8; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <p id="schedDevId" style="font-size:11px; color:#94a3b8; margin-top:-10px">ID: --</p>

            <div class="sched-list" id="schedList"></div>

            <div style="display:flex; gap:10px; margin-top:20px">
                <button class="btn-m" style="flex:1" onclick="addScheduleItem()">+ TH√äM M·ªêC</button>
                <button class="btn-save-main" style="flex:1; margin:0; padding: 12px; font-size:12px;"
                    onclick="saveSchedule()">L∆ØU L·ªäCH</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL (Unified) -->
    <div id="settingsModal" class="panel-overlay" onclick="if(event.target.id==='settingsModal') closeSettings()">
        <div class="settings-content">
            <div class="settings-header">
                <h3 style="margin:0; font-size:16px; color:#fff">‚öôÔ∏è C√ÄI ƒê·∫∂T H·ªÜ TH·ªêNG</h3>
                <button onclick="closeSettings()"
                    style="background:none; border:none; color:#94a3b8; font-size:24px; cursor:pointer;">&times;</button>
            </div>

            <div class="settings-body">
                <div class="settings-nav">
                    <div class="nav-item active" onclick="switchTab('tab-account', this)">üë§ T√†i kho·∫£n</div>
                    <div class="nav-item" onclick="switchTab('tab-devices', this)">üóÇÔ∏è Thi·∫øt b·ªã</div>
                    <div class="nav-item" onclick="switchTab('tab-system', this)">üõ†Ô∏è H·ªá th·ªëng</div>
                    <div class="nav-item" onclick="switchTab('tab-guide', this)">üìò H∆∞·ªõng d·∫´n</div>
                </div>

                <div class="settings-main">

                    <!-- TAB ACCOUNT -->
                    <div id="tab-account" class="tab-pane active">
                        <div class="tab-title">Li√™n k·∫øt & B·∫£o m·∫≠t</div>
                        <div style="margin-bottom:15px; font-size:12px; color:#94a3b8;">
                            Email: <b id="uiEmail" style="color:#fff">...</b><br>
                            SƒêT Li√™n k·∫øt: <b id="uiPhone" style="color:var(--accent)">...</b>
                        </div>
                        <input id="linkedPhone" class="dm-input" type="text" placeholder="Nh·∫≠p SƒêT, v√≠ d·ª•: 0907888111"
                            style="margin-bottom:10px">
                        <button class="dm-btn" onclick="saveLinkedPhone()">üîó L∆ØU LI√äN K·∫æT SƒêT</button>

                        <div
                            style="margin: 20px 0 10px; font-size:12px; color:#94a3b8; border-top:1px solid rgba(255,255,255,0.05); padding-top:10px;">
                            ƒê·ªïi m·∫≠t kh·∫©u</div>
                        <input id="newPassword" class="dm-input" type="password" placeholder="M·∫≠t kh·∫©u m·ªõi (>= 6 k√Ω t·ª±)"
                            style="margin-bottom:8px">
                        <input id="confirmPassword" class="dm-input" type="password" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi"
                            style="margin-bottom:8px">
                        <button class="dm-btn" onclick="changePasswordInApp()">üîê ƒê·ªîI M·∫¨T KH·∫®U</button>
                    </div>

                    <!-- TAB DEVICES -->
                    <div id="tab-devices" class="tab-pane">
                        <div class="tab-title">Qu·∫£n l√Ω t√™n & Th·ª© t·ª±</div>
                        <div style="font-size:12px; color:#94a3b8; margin-bottom:10px">
                            D√πng m≈©i t√™n ‚Üë ‚Üì ƒë·ªÉ s·∫Øp x·∫øp v·ªã tr√≠ hi·ªÉn th·ªã.
                        </div>
                        <div id="dmList" class="dm-list" style="max-height:300px; overflow-y:auto; margin-bottom:15px">
                        </div>
                        <div style="display:flex; gap:10px">
                            <button class="dm-btn" onclick="saveDeviceManagerChanges()" style="flex:1">üíæ L∆ØU</button>
                            <button class="dm-btn warn" onclick="resetDeviceOrder()" style="flex:1">‚Ü∫ RESET</button>
                        </div>
                    </div>

                    <!-- TAB SYSTEM -->
                    <div id="tab-system" class="tab-pane">
                        <div class="tab-title">Ti·ªán √≠ch & ƒêƒÉng xu·∫•t</div>

                        <div
                            style="background:rgba(255,255,255,0.03); padding:15px; border-radius:12px; margin-bottom:15px">
                            <div style="font-size:12px; color:#94a3b8; margin-bottom:5px">X√≥a Cache Local</div>
                            <button class="dm-btn warn"
                                onclick="if(confirm('X√≥a d·ªØ li·ªáu thi·∫øt b·ªã ƒë·ªÉ t·∫£i l·∫°i?')){localStorage.removeItem('iot_ecosystem_cfg');location.reload();}"
                                style="width:100%">
                                ‚Üª X√ìA DATA & T·∫¢I L·∫†I
                            </button>
                        </div>

                        <div style="background:rgba(239, 68, 68, 0.1); padding:15px; border-radius:12px;">
                            <div style="font-size:12px; color:#ef4444; margin-bottom:5px">Khu v·ª±c nguy hi·ªÉm</div>
                            <button class="dm-btn" style="width:100%; background:#ef4444; color:#fff; border:none;"
                                onclick="logout()">
                                üîì ƒêƒÇNG XU·∫§T (LOGOUT)
                            </button>
                        </div>
                    </div>

                    <!-- TAB GUIDE -->
                    <div id="tab-guide" class="tab-pane">
                        <div class="tab-title">H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</div>
                        <div class="guide-content" style="box-shadow:none; padding:0; background:none;">
                            <h4>1) ƒêi·ªÅu khi·ªÉn thi·∫øt b·ªã</h4>
                            <ul>
                                <li>B·∫•m v√†o th·∫ª ƒë·ªÉ m·ªü panel chi ti·∫øt.</li>
                                <li>C√†i ƒë·∫∑t th·ªùi gian ngh·ªâ/ch·∫°y r·ªìi b·∫•m L∆∞u.</li>
                            </ul>
                            <h4>2) PWA & Ti·ªán √≠ch</h4>
                            <ul>
                                <li>Th√™m v√†o m√†n h√¨nh ch√≠nh ƒë·ªÉ d√πng nh∆∞ App.</li>
                                <li>B·∫•m icon ‚ú® ƒë·ªÉ g·ªçi AI tr·ª£ l√Ω.</li>
                            </ul>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- PANEL ƒêI·ªÄU KHI·ªÇN CHI TI·∫æT -->
    <div id="panelOverlay" class="panel-overlay" onclick="closePanel(event)">
        <div class="panel" id="mainPanel">
            <div class="handle" onclick="closePanel({target:{id:'panelOverlay'}})"></div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <div>
                    <h2 id="panelTitle" style="margin:0; color: #fff; font-size: 18px;">TIMER CONTROL</h2>
                    <p id="panelId" style="color: var(--text-dim); font-size: 11px; margin: 0;">ID: --</p>
                </div>
                <div id="panelStatusBadge"
                    style="padding: 4px 10px; background: #334155; border-radius: 20px; font-size: 10px; font-weight: bold;">
                    OFFLINE</div>
            </div>

            <!-- === NEW BIG CONTROL GROUP === -->
            <div class="info-group">
                <div class="info-item">
                    <span class="info-label">C√ÄI ƒê·∫∂T NGH·ªà</span>
                    <div style="display:flex; justify-content:center; align-items:center; gap:8px; margin-top:8px">
                        <button class="btn-step-big" onclick="adjustValue('offMin',-1)">‚àí</button>
                        <div style="display:flex; align-items:baseline; gap:2px">
                            <input type="number" id="offMin" class="info-val-input" value="0">
                            <span class="info-unit">P</span>
                        </div>
                        <button class="btn-step-big" onclick="adjustValue('offMin',1)">+</button>
                    </div>
                </div>
                <div class="info-div"></div>
                <div class="info-item">
                    <span class="info-label">C√ÄI ƒê·∫∂T CH·∫†Y</span>
                    <div style="display:flex; justify-content:center; align-items:center; gap:8px; margin-top:8px">
                        <button class="btn-step-big" onclick="adjustValue('onSec',-1)">‚àí</button>
                        <div style="display:flex; align-items:baseline; gap:2px">
                            <input type="number" id="onSec" class="info-val-input" value="0">
                            <span class="info-unit">S</span>
                        </div>
                        <button class="btn-step-big" onclick="adjustValue('onSec',1)">+</button>
                    </div>
                </div>
            </div>

            <!-- PRESETS -->
            <div style="text-align:left;font-size:11px;color:#8e8e93;font-weight:bold;margin-bottom:8px">C·∫§U H√åNH NHANH
            </div>
            <div class="presets-container">
                <button class="btn-preset" onclick="applyPreset(5,10)"><span>T∆Ø·ªöI C√ÇY</span>5m T·∫Øt / 10s B·∫≠t</button>
                <button class="btn-preset" onclick="applyPreset(30,5)"><span>B∆†M N∆Ø·ªöC</span>30m T·∫Øt / 5s B·∫≠t</button>
                <button class="btn-preset" onclick="applyPreset(1,2)"><span>TEST NHANH</span>1m T·∫Øt / 2s B·∫≠t</button>
            </div>

            <button class="btn-save-main" onclick="saveSettings()">L∆ØU C√ÄI ƒê·∫∂T M·ªöI</button>
            <button class="btn-schedule" onclick="openSchedule()">üìÖ C√ÄI ƒê·∫∂T L·ªäCH NGH·ªà (SCHEDULE)</button>
            <button class="btn-force" onclick="forceRun()">‚ö° FORCE RUN</button>

            <div class="maintenance-title">üîß Ch·∫ø ƒë·ªô b·∫£o tr√¨</div>
            <div class="maintenance-grid">
                <button class="btn-m" onclick="setMaint(1)">7p</button>
                <button class="btn-m" onclick="setMaint(2)">15p</button>
                <button class="btn-m" onclick="setMaint(3)">30p</button>
                <button class="btn-m" onclick="setMaint(4)">50p</button>
                <button class="btn-m" onclick="setMaint(5)">80p</button>
                <button class="btn-m btn-manual" onclick="setMaint(6)">‚àû</button>
            </div>
            <button class="btn-cancel" onclick="setMaint(0)">H·ª¶Y B·∫¢O TR√å</button>

            <div style="height: 30px;"></div>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="logo-area">
                <h1>IOT ECOSYSTEM v1.9</h1>
                <span id="deviceCount">ƒêANG CH·ªú ƒêƒÇNG NH·∫¨P...</span>
            </div>
            <div class="header-actions">
                <button class="btn-circle" onclick="openSettings()">‚öôÔ∏è</button>
            </div>
        </header>

        <div class="device-grid" id="grid"></div>
    </div>

    <div class="ai-fab" onclick="openAI()">‚ú®</div>

    <script>
        /* ========= CONFIG ========= */
        const DEFAULT_MQTT = {
            host: "",
            // C·∫•u h√¨nh g·ªëc ƒë√£ b·ªã x√≥a ƒë·ªÉ b·∫£o m·∫≠t.
            // App s·∫Ω t·∫£i c·∫•u h√¨nh t·ª´ Firebase iot/system_config/mqtt
            port: "",
            protocol: "",
            path: ""
        };

        const SECURITY_CONFIG = {
            // ƒê√£ chuy·ªÉn Secret l√™n Firebase iot/system_config/mqtt (v1.9)
            emqxJwtSecret: "",
            // N·∫øu EMQX c·∫•u h√¨nh l·∫•y JWT t·ª´ password th√¨ ƒë·ªÉ 'password'.
            // N·∫øu c·∫•u h√¨nh l·∫•y t·ª´ username th√¨ ƒë·ªïi th√†nh 'username'.
            jwtPlacement: 'password'
        };

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDCX9OOVjK9xHCMR2Qhttfm8Z7vrXZt4z0",
            authDomain: "iot-trung.firebaseapp.com",
            databaseURL: "https://iot-trung-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "iot-trung",
            storageBucket: "iot-trung.firebasestorage.app",
            messagingSenderId: "649552656369",
            appId: "1:649552656369:web:faf89019c2614fee95b650",
            measurementId: "G-K6WR5P6S3Y"
        };

        window.devices = {};
        let client = null;
        let currentSelectedId = null;
        let currentUser = "";
        let mqttUserId = "";
        let tempSchedule = [];
        let fbDb = null;
        let fbReady = false;
        let deviceAliases = {};
        let deviceOrders = {};
        let linkedPhone = "";
        let linkedPhoneOwnerUid = "";
        let loginProvider = "password";
        let mqttTopicRoot = "";
        let isManualLoginFlow = false;
        let autoLoginHandled = false;

        async function ensureAuthPersistence() {
            try {
                await firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                console.log('[Auth] Persistence=LOCAL');
            } catch (err) {
                console.warn('[Auth] setPersistence failed:', err);
            }
        }
        function initFirebase() {
            try {
                const isPlaceholder = String(FIREBASE_CONFIG.apiKey || '').includes('YOUR_') ||
                    String(FIREBASE_CONFIG.databaseURL || '').includes('your-project-id');
                if (isPlaceholder) {
                    console.warn('[Firebase] ƒêang d√πng config m·∫´u. H√£y thay FIREBASE_CONFIG ƒë·ªÉ k√≠ch ho·∫°t.');
                    return;
                }

                const app = firebase.apps.length ? firebase.app() : firebase.initializeApp(FIREBASE_CONFIG);
                fbDb = app.database();
                fbReady = true;
                console.log('[Firebase] Connected Realtime Database');

            } catch (err) {
                console.error('[Firebase] Init error:', err);
            }
        }

        function safeKey(v) {
            return String(v || '').replace(/[.#$\[\]/]/g, '_');
        }

        function getOwnerKey() {
            return firebase.auth().currentUser?.uid || safeKey(currentUser) || 'unknown_user';
        }

        function getCurrentUid() {
            return firebase.auth().currentUser?.uid || '';
        }

        function normalizePhone(v) {
            return String(v || '').replace(/\s+/g, '').replace(/[^0-9+]/g, '');
        }

        function phoneLinkKey(phone) {
            return safeKey(normalizePhone(phone));
        }

        async function readPhoneOwner(phone) {
            if (!fbReady || !fbDb) return '';
            const key = phoneLinkKey(phone);
            if (!key) return '';
            const snap = await fbDb.ref(`iot_phone_links/${key}`).once('value');
            return String(snap.val() || '');
        }

        async function claimPhoneLink(phone) {
            if (!fbReady || !fbDb) throw new Error('FIREBASE_NOT_READY');
            const uid = getCurrentUid();
            if (!uid) throw new Error('UNAUTHENTICATED');

            const key = phoneLinkKey(phone);
            if (!key) throw new Error('INVALID_PHONE');

            const ref = fbDb.ref(`iot_phone_links/${key}`);
            let tx;
            try {
                tx = await ref.transaction((current) => {
                    if (current === null || current === uid) return uid;
                    return; // abort n·∫øu ƒë√£ thu·ªôc uid kh√°c
                }, undefined, false);
            } catch (err) {
                // Th∆∞·ªùng g·∫∑p: PERMISSION_DENIED do Firebase Rules
                throw err;
            }

            if (!tx.committed) throw new Error('PHONE_ALREADY_LINKED');

            // Mirror th√¥ng tin d·ªÖ tra c·ª©u tr√™n UI (email hi·ªán t·∫°i)
            const email = firebase.auth().currentUser?.email || '';
            await fbDb.ref(`iot_phone_link_profiles/${key}`).set({
                uid,
                email,
                phone: normalizePhone(phone),
                updatedAt: Date.now()
            });

            return true;
        }

        async function releasePhoneLink(phone) {
            if (!fbReady || !fbDb) return;
            const uid = getCurrentUid();
            if (!uid) return;

            const key = phoneLinkKey(phone);
            if (!key) return;

            const ref = fbDb.ref(`iot_phone_links/${key}`);
            await ref.transaction((current) => {
                if (current === uid) return null;
                return current;
            }, undefined, false);

            const ownerNow = await readPhoneOwner(phone);
            if (!ownerNow) {
                await fbDb.ref(`iot_phone_link_profiles/${key}`).remove();
            }
        }

        async function ensurePhoneOwnership(phone) {
            const uid = getCurrentUid();
            const owner = await readPhoneOwner(phone);
            if (owner && uid && owner !== uid) {
                throw new Error('PHONE_OWNERSHIP_MISMATCH');
            }
            return true;
        }

        async function getPhoneOwnerProfile(phone) {
            if (!fbReady || !fbDb) return null;
            const key = phoneLinkKey(phone);
            if (!key) return null;
            const snap = await fbDb.ref(`iot_phone_link_profiles/${key}`).once('value');
            return snap.val() || null;
        }

        function aliasKey(id) {
            return safeKey(id);
        }

        function getDisplayName(id) {
            return deviceAliases[aliasKey(id)] || String(id || '').toUpperCase();
        }

        function getOrderOf(id) {
            const v = deviceOrders[aliasKey(id)];
            return Number.isFinite(v) ? v : 99999;
        }

        function usernameToEmail(username) {
            const cleaned = String(username || '').trim().replace(/[^a-zA-Z0-9]/g, '');
            return `${cleaned}@iot.local`;
        }

        function fbUpdate(path, data) {
            if (!fbReady || !fbDb) return;
            fbDb.ref(path).update(data).catch(err => console.error('[Firebase] update error:', err));
        }

        function fbSet(path, data) {
            if (!fbReady || !fbDb) return;
            fbDb.ref(path).set(data).catch(err => console.error('[Firebase] set error:', err));
        }

        function syncDeviceToFirebase(devId) {
            if (!fbReady || !fbDb) return;
            const dev = window.devices[devId];
            if (!dev) return;

            const userKey = getOwnerKey();
            const devKey = safeKey(devId);
            fbSet(`iot/${userKey}/devices/${devKey}`, {
                ...dev,
                updatedAt: Date.now()
            });
        }

        function fbLogCommand(devId, method, params) {
            if (!fbReady || !fbDb) return;
            const userKey = getOwnerKey();
            const devKey = safeKey(devId);
            fbDb.ref(`iot/${userKey}/commands/${devKey}`).push({
                method,
                params,
                ts: Date.now()
            }).catch(err => console.error('[Firebase] push error:', err));
        }

        async function loadDeviceAliases() {
            if (!fbReady || !fbDb) return;
            try {
                const snap = await fbDb.ref(`iot/${getOwnerKey()}/device_aliases`).once('value');
                deviceAliases = snap.val() || {};
            } catch (e) {
                console.warn('Kh√¥ng t·∫£i ƒë∆∞·ª£c device aliases', e);
                deviceAliases = {};
            }
        }

        async function loadDeviceOrders() {
            if (!fbReady || !fbDb) return;
            try {
                const snap = await fbDb.ref(`iot/${getOwnerKey()}/device_orders`).once('value');
                deviceOrders = snap.val() || {};
            } catch (e) {
                console.warn('Kh√¥ng t·∫£i ƒë∆∞·ª£c device orders', e);
                deviceOrders = {};
            }
        }

        async function loadAccountProfile() {
            if (!fbReady || !fbDb) return;
            try {
                const snap = await fbDb.ref(`iot/${getOwnerKey()}/profile`).once('value');
                const p = snap.val() || {};
                linkedPhone = normalizePhone(p.linked_phone || '');

                if (linkedPhone) {
                    const owner = await readPhoneOwner(linkedPhone);
                    linkedPhoneOwnerUid = owner;
                    if (owner && owner !== getCurrentUid()) {
                        // Profile c≈© b·ªã tr√πng, kh√≥a l·∫°i ƒë·ªÉ kh√¥ng d√πng nh·∫ßm topic c·ªßa t√†i kho·∫£n kh√°c
                        linkedPhone = '';
                        showToast('SƒêT trong profile ƒë√£ thu·ªôc t√†i kho·∫£n kh√°c. Vui l√≤ng li√™n k·∫øt SƒêT m·ªõi.');
                    }
                } else {
                    linkedPhoneOwnerUid = '';
                }

                if (document.getElementById('linkedPhone')) document.getElementById('linkedPhone').value = linkedPhone;
                const mail = firebase.auth().currentUser?.email || '';
                if (document.getElementById('accEmail')) document.getElementById('accEmail').value = mail;
            } catch (e) {
                linkedPhone = '';
            }
        }

        async function saveDeviceAlias() {
            if (!currentSelectedId || !fbReady || !fbDb) return;
            const input = document.getElementById('deviceAliasInput');
            if (!input) return;

            const val = input.value.trim();
            const key = aliasKey(currentSelectedId);
            try {
                if (val) {
                    await fbDb.ref(`iot/${getOwnerKey()}/device_aliases/${key}`).set(val);
                    deviceAliases[key] = val;
                } else {
                    await fbDb.ref(`iot/${getOwnerKey()}/device_aliases/${key}`).remove();
                    delete deviceAliases[key];
                }
                updateDeviceCard(currentSelectedId);
                document.getElementById("panelTitle").innerText = getDisplayName(currentSelectedId);
                showToast('ƒê√£ l∆∞u t√™n hi·ªÉn th·ªã');
            } catch (e) {
                showToast('L∆∞u t√™n th·∫•t b·∫°i');
            }
        }

        function getAllKnownDeviceIds() {
            const ids = new Set(Object.keys(window.devices || {}));
            Object.keys(deviceAliases || {}).forEach(k => ids.add(k));
            Object.keys(deviceOrders || {}).forEach(k => ids.add(k));
            return Array.from(ids);
        }

        function sortDeviceIds(ids) {
            return [...ids].sort((a, b) => {
                const oa = getOrderOf(a), ob = getOrderOf(b);
                if (oa !== ob) return oa - ob;
                return String(getDisplayName(a)).localeCompare(String(getDisplayName(b)), 'vi');
            });
        }

        function applyCardOrder(id) {
            const card = document.getElementById('card-' + id);
            if (card) card.style.order = String(getOrderOf(id));
        }

        function renderDeviceManager() {
            const box = document.getElementById('dmList');
            if (!box) return;
            const sorted = sortDeviceIds(getAllKnownDeviceIds());
            if (sorted.length === 0) {
                box.innerHTML = `<div style="color:#64748b; text-align:center; padding:16px">Ch∆∞a c√≥ thi·∫øt b·ªã ƒë·ªÉ qu·∫£n l√Ω</div>`;
                return;
            }
            box.innerHTML = sorted.map((id, idx) => `
      <div class="dm-item">
        <input class="dm-input" data-dev="${id}" value="${(deviceAliases[aliasKey(id)] || '').replace(/"/g, '&quot;')}" placeholder="T√™n hi·ªÉn th·ªã cho ${id}">
        <button class="dm-btn" onclick="moveDeviceOrder('${id}', -1)">‚Üë</button>
        <button class="dm-btn" onclick="moveDeviceOrder('${id}', 1)">‚Üì</button>
      </div>
    `).join('');
        }

        function openDeviceManager() {
            document.getElementById('deviceManagerModal').style.display = 'flex';
            renderDeviceManager();
        }

        function closeDeviceManager() {
            document.getElementById('deviceManagerModal').style.display = 'none';
        }

        function ensureDefaultOrders() {
            const sorted = sortDeviceIds(getAllKnownDeviceIds());
            sorted.forEach((id, idx) => {
                if (!Number.isFinite(deviceOrders[aliasKey(id)])) deviceOrders[aliasKey(id)] = idx;
            });
        }

        function moveDeviceOrder(id, delta) {
            ensureDefaultOrders();
            const sorted = sortDeviceIds(getAllKnownDeviceIds());
            const from = sorted.indexOf(id);
            if (from < 0) return;
            const to = from + delta;
            if (to < 0 || to >= sorted.length) return;
            const temp = sorted[from];
            sorted[from] = sorted[to];
            sorted[to] = temp;
            sorted.forEach((devId, idx) => { deviceOrders[aliasKey(devId)] = idx; applyCardOrder(devId); });
            renderDeviceManager();
        }

        async function saveDeviceManagerChanges() {
            if (!fbReady || !fbDb) return;
            const inputs = document.querySelectorAll('#dmList input[data-dev]');
            const aliasesNext = {};
            inputs.forEach(el => {
                const dev = el.getAttribute('data-dev');
                const name = (el.value || '').trim();
                if (name) aliasesNext[aliasKey(dev)] = name;
            });
            deviceAliases = aliasesNext;
            ensureDefaultOrders();
            try {
                const base = `iot/${getOwnerKey()}`;
                await Promise.all([
                    fbDb.ref(base + '/device_aliases').set(deviceAliases),
                    fbDb.ref(base + '/device_orders').set(deviceOrders)
                ]);
                Object.keys(window.devices || {}).forEach(id => { updateDeviceCard(id); applyCardOrder(id); });
                if (currentSelectedId) document.getElementById("panelTitle").innerText = getDisplayName(currentSelectedId);
                showToast('ƒê√£ l∆∞u t√™n & v·ªã tr√≠ thi·∫øt b·ªã');
                closeDeviceManager();
            } catch (e) {
                showToast('L∆∞u th·∫•t b·∫°i');
            }
        }

        function resetDeviceOrder() {
            const sorted = Object.keys(window.devices || {}).sort((a, b) => String(a).localeCompare(String(b), 'vi'));
            sorted.forEach((id, idx) => {
                deviceOrders[aliasKey(id)] = idx;
                applyCardOrder(id);
            });
            renderDeviceManager();
        }

        initFirebase();

        /* ========= INIT & LOGIN ========= */
        window.onload = async function () {
            const savedUser = localStorage.getItem("current_user");
            const key = localStorage.getItem("gemini_api_key");
            if (key) document.getElementById("geminiKey").value = key;

            if (savedUser) {
                document.getElementById("loginUser").value = savedUser;
            }
            // Gi·ªØ ·∫©n login overlay cho t·ªõi khi Firebase tr·∫£ v·ªÅ tr·∫°ng th√°i auth ƒë·∫ßu ti√™n,
            // tr√°nh hi·ªán tho√°ng b·∫£ng ƒëƒÉng nh·∫≠p khi F5 d√π phi√™n v·∫´n c√≤n.
            document.getElementById("loginOverlay").style.display = "none";

            // Gi·ªØ phi√™n ƒëƒÉng nh·∫≠p qua F5/ƒë√≥ng m·ªü tab
            await ensureAuthPersistence();

            // T·ª± kh√¥i ph·ª•c phi√™n ƒëƒÉng nh·∫≠p (ƒë·∫∑c bi·ªát Google) sau khi F5
            firebase.auth().onAuthStateChanged(async (user) => {
                if (user) {
                    if (isManualLoginFlow || autoLoginHandled) return;
                    autoLoginHandled = true;

                    const saved = (localStorage.getItem("current_user") || '').trim();
                    const emailPrefix = String(user.email || '').split('@')[0] || '';
                    const resolvedUser = saved || emailPrefix || 'google_user';
                    const provider = (user.providerData || []).some(p => p.providerId === 'google.com') ? 'google' : 'password';

                    document.getElementById("loginUser").value = resolvedUser;
                    await finalizeLogin(resolvedUser, provider);
                    showToast('ƒê√£ t·ª± ƒëƒÉng nh·∫≠p t·ª´ phi√™n tr∆∞·ªõc');
                    return;
                }

                autoLoginHandled = false;
                document.getElementById("loginOverlay").style.display = "flex";
            });
        };

        async function performLogin() {
            isManualLoginFlow = true;
            const u = document.getElementById("loginUser").value.trim();
            const p = document.getElementById("loginPass").value;
            if (!u) { alert("Vui l√≤ng nh·∫≠p M√£ Kh√°ch H√†ng"); return; }
            if (!p || p.length < 6) { alert("M·∫≠t kh·∫©u t·ªëi thi·ªÉu 6 k√Ω t·ª±"); return; }

            const email = usernameToEmail(u);
            try {
                await firebase.auth().signInWithEmailAndPassword(email, p);
            } catch (err) {
                showToast("Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u");
                return;
            }

            await finalizeLogin(u, "password");
            isManualLoginFlow = false;
        }

        async function performGoogleLogin() {
            try {
                isManualLoginFlow = true;
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.setCustomParameters({ prompt: 'select_account' });
                const cred = await firebase.auth().signInWithPopup(provider);

                // V·ªõi Google, userId hi·ªÉn th·ªã v·∫´n l·∫•y t·ª´ √¥ nh·∫≠p n·∫øu c√≥, n·∫øu kh√¥ng fallback email prefix
                const enteredUser = document.getElementById("loginUser").value.trim();
                const emailUser = String(cred.user?.email || '').split('@')[0];
                const resolvedUser = enteredUser || emailUser || "google_user";
                document.getElementById("loginUser").value = resolvedUser;

                await finalizeLogin(resolvedUser, "google");
                showToast("ƒêƒÉng nh·∫≠p Google th√†nh c√¥ng");
                isManualLoginFlow = false;
            } catch (err) {
                console.error('Google login error:', err);
                showToast("Kh√¥ng th·ªÉ ƒëƒÉng nh·∫≠p Google");
                isManualLoginFlow = false;
            }
        }

        async function finalizeLogin(u, provider) {
            loginProvider = provider || 'password';
            currentUser = u;
            localStorage.setItem("current_user", u);
            document.getElementById("loginOverlay").style.display = "none";

            await loadDeviceAliases();
            await loadDeviceOrders();
            await loadAccountProfile();

            // Flow chu·∫©n: n·∫øu login Google th√¨ b·∫Øt bu·ªôc bind SƒêT tr∆∞·ªõc khi connect MQTT
            if (loginProvider === 'google') {
                mqttUserId = linkedPhone || "";
            } else {
                mqttUserId = linkedPhone || u;
            }

            fbUpdate(`iot/${getOwnerKey()}/meta`, {
                lastLoginAt: Date.now(),
                source: "backup3.html",
                provider: provider || "unknown"
            });

            // Clear old data
            window.devices = {};
            document.getElementById("grid").innerHTML = "";

            if (!mqttUserId) {
                updateCounter();
                openAccountManager();
                showToast('H√£y li√™n k·∫øt SƒêT ƒë·ªÉ truy c·∫≠p ƒë√∫ng topic MQTT');
                return;
            }

            connect();
        }

        async function registerAccount() {
            const u = document.getElementById("loginUser").value.trim();
            const p = document.getElementById("loginPass").value;
            if (!u) { alert("Nh·∫≠p username tr∆∞·ªõc"); return; }
            if (!p || p.length < 6) { alert("M·∫≠t kh·∫©u t·ªëi thi·ªÉu 6 k√Ω t·ª±"); return; }

            const email = usernameToEmail(u);
            try {
                await firebase.auth().createUserWithEmailAndPassword(email, p);
                showToast("T·∫°o t√†i kho·∫£n th√†nh c√¥ng, ƒëang ƒëƒÉng nh·∫≠p...");
                await performLogin();
            } catch (err) {
                if (err.code === 'auth/email-already-in-use') showToast("T√†i kho·∫£n ƒë√£ t·ªìn t·∫°i, h√£y ƒëƒÉng nh·∫≠p");
                else showToast("Kh√¥ng t·∫°o ƒë∆∞·ª£c t√†i kho·∫£n: " + (err.message || err.code));
            }
        }

        function logout() {
            firebase.auth().signOut().finally(() => {
                localStorage.removeItem("current_user");
                deviceAliases = {};
                deviceOrders = {};
                mqttTopicRoot = "";
                location.reload();
            });
        }

        function toBase64UrlFromBytes(bytes) {
            let binary = '';
            const len = bytes.byteLength || bytes.length;
            for (let i = 0; i < len; i++) binary += String.fromCharCode(bytes[i]);
            return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
        }

        function toBase64UrlFromString(str) {
            return btoa(unescape(encodeURIComponent(str)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/g, '');
        }

        async function fetchSystemConfig() {
            if (!fbReady || !fbDb) return null;
            try {
                const snap = await fbDb.ref('iot/system_config/mqtt').once('value');
                const cfg = snap.val();
                if (cfg && cfg.host && cfg.port) {
                    console.log('[Config] Loaded from Firebase:', cfg);
                    return cfg;
                }
            } catch (e) {
                console.warn('[Config] Failed to load from Firebase, using default.', e);
            }
            return null;
        }

        async function buildEmqxJwtHs256(secretOverride) {
            const now = Math.floor(Date.now() / 1000);
            const header = { alg: 'HS256', typ: 'JWT' };
            const payload = {
                sub: mqttUserId,
                username: mqttUserId,
                iat: now,
                exp: now + 24 * 60 * 60
            };

            const h = toBase64UrlFromString(JSON.stringify(header));
            const p = toBase64UrlFromString(JSON.stringify(payload));
            const message = `${h}.${p}`;

            const secret = secretOverride || SECURITY_CONFIG.emqxJwtSecret;

            const enc = new TextEncoder();
            const key = await crypto.subtle.importKey(
                'raw',
                enc.encode(secret),
                { name: 'HMAC', hash: 'SHA-256' },
                false,
                ['sign']
            );

            const sigBuffer = await crypto.subtle.sign('HMAC', key, enc.encode(message));
            const sig = toBase64UrlFromBytes(new Uint8Array(sigBuffer));
            return `${message}.${sig}`;
        }

        async function connect() {
            if (!mqttUserId) {
                showToast('Ch∆∞a c√≥ MQTT User ID');
                return;
            }

            try {
                await ensurePhoneOwnership(mqttUserId);
            } catch (err) {
                console.error('Phone ownership mismatch:', err);
                showToast('SƒêT n√†y kh√¥ng thu·ªôc t√†i kho·∫£n hi·ªán t·∫°i');
                return;
            }

            // --- [NEW v1.9] Config Loading ---
            let config = DEFAULT_MQTT;
            let jwtSecret = SECURITY_CONFIG.emqxJwtSecret;

            const remoteConfig = await fetchSystemConfig();
            if (remoteConfig) {
                config = { ...DEFAULT_MQTT, ...remoteConfig }; // Merge default with remote
                if (remoteConfig.secret) jwtSecret = remoteConfig.secret;
                showToast('ƒê√£ t·∫£i c·∫•u h√¨nh t·ª´ Firebase');
            } else {
                showToast('D√πng c·∫•u h√¨nh m·∫∑c ƒë·ªãnh (Source Code)');
            }

            const url = `${config.protocol}://${config.host}:${config.port}${config.path || '/mqtt'}`;
            mqttTopicRoot = `users/${mqttUserId}/devices`;
            if (!mqttTopicRoot) {
                showToast('MQTT topicRoot kh√¥ng h·ª£p l·ªá');
                return;
            }

            if (client) client.end();

            let jwtToken = '';
            try {
                jwtToken = await buildEmqxJwtHs256(jwtSecret);
            } catch (err) {
                console.error('JWT build error:', err);
                showToast('Kh√¥ng t·∫°o ƒë∆∞·ª£c JWT t·ª´ secret.');
                return;
            }

            const mqttUsername = SECURITY_CONFIG.jwtPlacement === 'username' ? jwtToken : mqttUserId;
            const mqttPassword = SECURITY_CONFIG.jwtPlacement === 'password' ? jwtToken : '';

            client = mqtt.connect(url, {
                // D√πng JWT t·∫°o t·ª´ secret hardcode theo y√™u c·∫ßu
                username: mqttUsername,
                password: mqttPassword,
                clientId: "eco_ai_" + Math.random().toString(16).slice(2, 8)
            });

            client.on("connect", () => {
                showToast("ƒê√£ k·∫øt n·ªëi Server MQTT");
                const baseTopic = mqttTopicRoot;
                client.subscribe(`${baseTopic}/+/telemetry`);
                client.subscribe(`${baseTopic}/+/rpc/response/+`);
                console.log('[MQTT] connected, topic root:', baseTopic, '| userId:', mqttUserId);

                fbUpdate(`iot/${getOwnerKey()}/meta`, {
                    mqttConnected: true,
                    lastMqttConnectAt: Date.now()
                });
            });

            client.on("message", (topic, payload) => {
                const parts = topic.split('/');
                const devId = parts[3];
                if (!devId) return;

                try {
                    const data = JSON.parse(payload.toString());

                    if (!window.devices[devId]) {
                        window.devices[devId] = { id: devId };
                        createDeviceCard(devId);
                        requestDeviceSync(devId);
                    }

                    if (data.pause_json) {
                        if (typeof data.pause_json === 'string') {
                            try { data.pause_json = JSON.parse(data.pause_json); } catch (e) { }
                        }
                    }

                    Object.assign(window.devices[devId], data);
                    window.devices[devId].lastSeen = Date.now();
                    updateDeviceCard(devId);
                    syncDeviceToFirebase(devId);

                    if (currentSelectedId === devId && document.getElementById("mainPanel").classList.contains("show")) {
                        if (document.activeElement.id !== "offMin" && data.off_min !== undefined) document.getElementById("offMin").value = data.off_min;
                        if (document.activeElement.id !== "onSec" && data.on_sec !== undefined) document.getElementById("onSec").value = data.on_sec;
                    }
                } catch (e) { console.error("Data error", e); }
            });

            client.on('error', (err) => {
                console.error('[MQTT] error:', err);
                showToast('MQTT l·ªói x√°c th·ª±c/k·∫øt n·ªëi. Xem Console (F12).');
            });

            client.on('close', () => {
                console.warn('[MQTT] connection closed');
            });
        }

        /* ========= OPTIMIZED RENDER ========= */
        function createDeviceCard(id) {
            const grid = document.getElementById("grid");
            const card = document.createElement("div");
            card.id = "card-" + id;
            card.className = "device-card";
            card.onclick = () => openPanel(id);
            card.innerHTML = `
      <div class="card-top">
        <span class="card-id" id="label-${id}">${getDisplayName(id)}</span>
        <div class="card-right">
          <div class="card-dot" id="dot-${id}"></div>
          <span class="mode-badge-mini" id="mode-${id}">15p</span>
        </div>
      </div>
      <div class="card-main-stats">
        <div class="stat-item off">
           <div class="stat-icon">üí§</div>
           <div class="stat-value" id="val-off-${id}">--<span class="stat-unit">P</span></div>
        </div>
        <div class="stat-item on">
           <div class="stat-icon" id="runicon-${id}">‚ö°</div>
           <div class="stat-value" id="val-on-${id}">--<span class="stat-unit">S</span></div>
        </div>
      </div>
      <div class="card-timer-mini">
        <div class="mini-time" id="time-${id}">--:--</div>
      </div>
    `;
            grid.appendChild(card);
            applyCardOrder(id);
            updateCounter();
        }

        function updateDeviceCard(id) {
            const dev = window.devices[id];
            if (!dev) return;

            const isOnline = (Date.now() - dev.lastSeen < 30000);
            const card = document.getElementById("card-" + id);
            const dot = document.getElementById("dot-" + id);
            const modeBadge = document.getElementById("mode-" + id);
            const runIcon = document.getElementById("runicon-" + id);
            const valOff = document.getElementById("val-off-" + id);
            const valOn = document.getElementById("val-on-" + id);
            const time = document.getElementById("time-" + id);
            const label = document.getElementById("label-" + id);

            const statusText = String(dev.status || '').toUpperCase();
            const isRunning = isOnline && (statusText.includes('RUN') || statusText.includes('ON') || statusText.includes('CH·∫†Y'));

            if (runIcon) runIcon.classList.toggle('run-spin', isRunning);

            if (card) {
                if (isOnline) card.classList.remove('offline');
                else card.classList.add('offline');
            }
            if (dot) {
                if (isOnline) dot.classList.add('on');
                else dot.classList.remove('on');
            }

            if (valOff) valOff.innerHTML = `${dev.off_min !== undefined ? dev.off_min : '--'}<span class="stat-unit">P</span>`;
            if (valOn) valOn.innerHTML = `${dev.on_sec !== undefined ? dev.on_sec : '--'}<span class="stat-unit">S</span>`;
            if (time) time.innerText = dev.time_rem || '--:--';
            if (label) label.innerText = getDisplayName(id);

            if (modeBadge) {
                let m = Number(
                    dev.maintenance_mode ??
                    dev.maint_mode ??
                    dev.maintenance ??
                    dev.maint ??
                    dev.mode_maint
                );

                if (!Number.isFinite(m)) {
                    const s = String(dev.status || '').toUpperCase();
                    const mt = s.match(/(?:MAINT|B·∫¢O\s*TR√å)\s*[:\- ]?\s*(\d)/i);
                    if (mt) m = Number(mt[1]);
                }

                if (Number.isFinite(m) && m >= 1 && m <= 6) {
                    modeBadge.style.display = 'inline-flex';
                    const modeTextMap = {
                        1: '7p',
                        2: '15p',
                        3: '30p',
                        4: '50p',
                        5: '80p',
                        6: '‚àû'
                    };
                    modeBadge.textContent = modeTextMap[m] || '';
                } else {
                    modeBadge.style.display = 'none';
                }
            }
        }

        function updateCounter() {
            const count = Object.keys(window.devices).length;
            const ns = (mqttUserId || currentUser || '').toUpperCase();
            document.getElementById("deviceCount").innerText = `MQTT USER: ${ns} | ${count} THI·∫æT B·ªä`;
        }

        // Watchdog ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i Offline m√† kh√¥ng c·∫ßn tin nh·∫Øn m·ªõi
        setInterval(() => {
            Object.keys(window.devices).forEach(id => updateDeviceCard(id));
        }, 10000);


        /* ========= PANEL CONTROLS ========= */
        function openPanel(id) {
            currentSelectedId = id;
            const dev = window.devices[id];
            document.getElementById("panelTitle").innerText = getDisplayName(id);
            document.getElementById("panelId").innerText = `ID: ${id.toUpperCase()} | Last Update: ` + new Date(dev.lastSeen).toLocaleTimeString();

            const isOnline = (Date.now() - dev.lastSeen < 30000);
            const badge = document.getElementById("panelStatusBadge");
            badge.innerText = isOnline ? "ONLINE" : "OFFLINE";
            badge.style.background = isOnline ? "var(--success)" : "#334155";

            document.getElementById("offMin").value = dev.off_min !== undefined ? dev.off_min : 0;
            document.getElementById("onSec").value = dev.on_sec !== undefined ? dev.on_sec : 0;

            document.getElementById("panelOverlay").style.display = "flex";
            setTimeout(() => document.getElementById("mainPanel").classList.add("show"), 10);

            requestDeviceSync(id);
            rpcSend(id, "getPauseJson", {});
        }

        function requestDeviceSync(id) {
            if (!client) return;
            rpcSend(id, "setOffMin", {});
            rpcSend(id, "setOnSec", {});
        }

        function closePanel(e) {
            if (e.target.id === "panelOverlay" || e.target.className === "handle") {
                document.getElementById("mainPanel").classList.remove("show");
                setTimeout(() => document.getElementById("panelOverlay").style.display = "none", 400);
                currentSelectedId = null;
            }
        }

        function adjustValue(id, d) {
            const el = document.getElementById(id);
            let val = parseInt(el.value) || 0;
            val += d;
            if (val < 0) val = 0;
            el.value = val;
        }

        function applyPreset(m, s) {
            document.getElementById("offMin").value = m;
            document.getElementById("onSec").value = s;
            saveSettings();
        }

        function saveSettings() {
            if (!currentSelectedId || !client) return;
            const m = parseInt(document.getElementById("offMin").value);
            const s = parseInt(document.getElementById("onSec").value);
            rpcSend(currentSelectedId, "setOffMin", m);
            rpcSend(currentSelectedId, "setOnSec", s);
            rpcSend(currentSelectedId, "save", 1);
            showToast(`ƒê√£ g·ª≠i c√†i ƒë·∫∑t t·ªõi ${currentSelectedId}`);
        }

        function setMaint(mode) {
            if (!currentSelectedId || !client) return;
            rpcSend(currentSelectedId, "setMaintenance", mode);
            showToast(`G·ª≠i l·ªánh b·∫£o tr√¨ t·ªõi ${currentSelectedId}`);
        }

        function forceRun() {
            if (!currentSelectedId || !client) return;
            rpcSend(currentSelectedId, "forceRun", 1);
            showToast(`ƒê√£ g·ª≠i FORCE RUN t·ªõi ${currentSelectedId}`);
        }

        function rpcSend(id, method, params) {
            if (!mqttTopicRoot) {
                showToast('Ch∆∞a c√≥ MQTT topicRoot h·ª£p l·ªá');
                return;
            }
            const topic = `${mqttTopicRoot}/${id}/rpc/request/${Date.now()}`;
            fbLogCommand(id, method, params);
            client.publish(topic, JSON.stringify({ method: method, params: params }));
        }

        /* ========= SCHEDULE LOGIC ========= */
        function openSchedule() {
            if (!currentSelectedId) return;
            document.getElementById("scheduleModal").style.display = "flex";
            document.getElementById("schedDevId").innerText = "THI·∫æT B·ªä: " + currentSelectedId.toUpperCase();

            const dev = window.devices[currentSelectedId];
            if (dev && Array.isArray(dev.pause_json)) {
                tempSchedule = JSON.parse(JSON.stringify(dev.pause_json));
            } else {
                tempSchedule = [];
            }
            renderScheduleList();
        }

        function closeSchedule() { document.getElementById("scheduleModal").style.display = "none"; }

        function renderScheduleList() {
            const list = document.getElementById("schedList");
            list.innerHTML = "";
            if (tempSchedule.length === 0) {
                list.innerHTML = `<div style="text-align:center; color:#64748b; padding:20px;">Ch∆∞a c√≥ l·ªãch h·∫πn n√†o</div>`;
                return;
            }

            tempSchedule.forEach((item, idx) => {
                const s = item.s || "12:00";
                const e = item.e || "13:00";
                const on = item.on == 1;
                const w = item.w === undefined ? 127 : item.w;

                const days = ["CN", "T2", "T3", "T4", "T5", "T6", "T7"];
                let daysHtml = "";
                const order = [1, 2, 3, 4, 5, 6, 0];

                order.forEach(d => {
                    const isActive = (w & (1 << d));
                    daysHtml += `<div class="d-btn ${isActive ? 'act' : ''}" onclick="toggleSchedDay(${idx}, ${d})">${days[d]}</div>`;
                });

                const div = document.createElement("div");
                div.className = "sched-item";
                div.innerHTML = `
            <div class="sched-row">
                <div class="sched-time" style="display:flex; align-items:center; gap:5px; font-size:12px">
                    <span>T·ª´</span> <input type="time" value="${s}" onchange="updateSched(${idx}, 's', this.value)">
                    <span>ƒê·∫øn</span> <input type="time" value="${e}" onchange="updateSched(${idx}, 'e', this.value)">
                </div>
                <div style="display:flex; gap:10px; align-items:center">
                    <label class="sw">
                        <input type="checkbox" ${on ? 'checked' : ''} onchange="updateSched(${idx}, 'on', this.checked?1:0)">
                        <span class="sl"></span>
                    </label>
                    <button onclick="removeSched(${idx})" style="background:#ef4444; border:none; color:white; border-radius:4px; width:20px; height:20px; cursor:pointer;">&times;</button>
                </div>
            </div>
            <div class="day-select">${daysHtml}</div>
        `;
                list.appendChild(div);
            });
        }

        function addScheduleItem() {
            tempSchedule.push({ s: "12:00", e: "13:00", on: 1, w: 127 });
            renderScheduleList();
        }

        function removeSched(idx) {
            tempSchedule.splice(idx, 1);
            renderScheduleList();
        }

        function updateSched(idx, field, val) {
            if (tempSchedule[idx]) {
                tempSchedule[idx][field] = val;
            }
        }

        function toggleSchedDay(idx, dayBit) {
            if (!tempSchedule[idx]) return;
            let w = tempSchedule[idx].w === undefined ? 127 : tempSchedule[idx].w;
            const mask = 1 << dayBit;
            if (w & mask) w &= ~mask;
            else w |= mask;
            tempSchedule[idx].w = w;
            renderScheduleList();
        }

        function saveSchedule() {
            if (!currentSelectedId) return;
            rpcSend(currentSelectedId, "setPauseJson", tempSchedule);
            showToast("ƒê√£ l∆∞u l·ªãch tr√¨nh!");
            closeSchedule();
        }

        /* ========= AI INTELLIGENCE ========= */
        function openAI() { document.getElementById("aiModal").style.display = "flex"; }
        function closeAI() { document.getElementById("aiModal").style.display = "none"; }
        /* ========= UNIFIED SETTINGS ========= */
        function openSettings() {
            document.getElementById("settingsModal").style.display = "flex";
            // Auto load data for Account tab
            if (document.getElementById('linkedPhone')) document.getElementById('linkedPhone').value = linkedPhone || '';
            if (document.getElementById('uiEmail')) document.getElementById('uiEmail').innerText = firebase.auth().currentUser?.email || 'Ch∆∞a ƒëƒÉng nh·∫≠p';
            if (document.getElementById('uiPhone')) document.getElementById('uiPhone').innerText = linkedPhone || '(Ch∆∞a li√™n k·∫øt)';
        }
        function closeSettings() { document.getElementById("settingsModal").style.display = "none"; }

        function switchTab(tabId, el) {
            // Hide all tabs
            document.querySelectorAll('.tab-pane').forEach(t => t.classList.remove('active'));
            // Remove active class from navs
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            // Show target
            document.getElementById(tabId).classList.add('active');
            el.classList.add('active');

            // If Device tab, load devices
            if (tabId === 'tab-devices') {
                renderDeviceManagerList();
            }
        }

        // Re-use logic for Device Manager List
        function renderDeviceManagerList() {
            const list = document.getElementById("dmList");
            list.innerHTML = "";
            let arr = Object.keys(window.devices).sort((a, b) => getOrderOf(a) - getOrderOf(b));
            arr.forEach(id => {
                const row = document.createElement("div");
                row.className = "dm-item";
                row.innerHTML = `
                    <div style="display:flex; flex-direction:column; gap:2px">
                        <div style="font-size:10px; color:#94a3b8; font-weight:800">${id.toUpperCase()}</div>
                        <input type="text" class="dm-input" value="${getDisplayName(id)}" onchange="updateAlias('${id}', this.value)" placeholder="ƒê·∫∑t t√™n...">
                    </div>
                    <button class="dm-btn" onclick="moveDeviceOrder('${id}', -1)">‚Üë</button>
                    <button class="dm-btn" onclick="moveDeviceOrder('${id}', 1)">‚Üì</button>
                `;
                list.appendChild(row);
            });
        }

        // Helper functions from old modals
        function updateAlias(id, val) { deviceAliases[aliasKey(id)] = val; }
        function moveDeviceOrder(id, dir) {
            const arr = Object.keys(window.devices).sort((a, b) => getOrderOf(a) - getOrderOf(b));
            const idx = arr.indexOf(id);
            if (idx < 0) return;
            const newIdx = idx + dir;
            if (newIdx < 0 || newIdx >= arr.length) return;
            // Swap
            const temp = arr[idx];
            arr[idx] = arr[newIdx];
            arr[newIdx] = temp;
            // Update order map
            arr.forEach((k, i) => deviceOrders[aliasKey(k)] = i);
            renderDeviceManagerList();
        }
        function saveDeviceManagerChanges() {
            localStorage.setItem("iot_device_aliases", JSON.stringify(deviceAliases));
            localStorage.setItem("iot_device_orders", JSON.stringify(deviceOrders));
            Object.keys(window.devices).forEach(id => updateDeviceCard(id));
            if (currentSelectedId) document.getElementById("panelTitle").innerText = getDisplayName(currentSelectedId);
            showToast("ƒê√£ l∆∞u t√™n & v·ªã tr√≠ thi·∫øt b·ªã");
        }
        function resetDeviceOrder() {
            if (!confirm("M·ªçi t√πy ch·ªânh t√™n & sai s·ªë s·∫Ω v·ªÅ m·∫∑c ƒë·ªãnh?")) return;
            deviceAliases = {};
            deviceOrders = {};
            localStorage.removeItem("iot_device_aliases");
            localStorage.removeItem("iot_device_orders");
            renderDeviceManagerList();
            Object.keys(window.devices).forEach(id => updateDeviceCard(id));
            showToast("ƒê√£ reset m·∫∑c ƒë·ªãnh");
        }



        async function saveLinkedPhone() {
            if (!fbReady || !fbDb) return;
            const phone = normalizePhone(document.getElementById('linkedPhone')?.value || '');
            if (!phone) { showToast('Nh·∫≠p SƒêT c·∫ßn li√™n k·∫øt'); return; }

            const prevPhone = linkedPhone;
            try {
                await claimPhoneLink(phone);

                if (prevPhone && prevPhone !== phone) {
                    try { await releasePhoneLink(prevPhone); } catch (_) { }
                }

                await fbDb.ref(`iot/${getOwnerKey()}/profile/linked_phone`).set(phone);
                linkedPhone = phone;
                linkedPhoneOwnerUid = getCurrentUid();
                mqttUserId = phone;
                localStorage.setItem('linked_phone', phone);

                // Auto reconnect MQTT ngay sau khi l∆∞u li√™n k·∫øt SƒêT
                window.devices = {};
                document.getElementById('grid').innerHTML = '';
                updateCounter();
                connect();

                // L∆∞u xong th√¨ ƒë√≥ng popup qu·∫£n l√Ω t√†i kho·∫£n, khi c·∫ßn m·ªõi m·ªü l·∫°i ƒë·ªÉ s·ª≠a
                closeAccountManager();

                showToast('ƒê√£ l∆∞u li√™n k·∫øt SƒêT v√† t·ª± reconnect MQTT');
            } catch (e) {
                console.error('saveLinkedPhone error:', e);
                const code = String(e?.code || '');
                const msg = String(e?.message || '');

                if (String(e?.message || '').includes('PHONE_ALREADY_LINKED')) {
                    showToast('SƒêT n√†y ƒë√£ li√™n k·∫øt v·ªõi t√†i kho·∫£n kh√°c');
                    return;
                }
                if (msg.includes('UNAUTHENTICATED')) {
                    showToast('Phi√™n ƒëƒÉng nh·∫≠p kh√¥ng h·ª£p l·ªá, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i');
                    return;
                }
                if (code.includes('PERMISSION_DENIED') || msg.includes('PERMISSION_DENIED')) {
                    showToast('Firebase Rules ƒëang ch·∫∑n ghi iot_phone_links / iot_phone_link_profiles');
                    return;
                }
                showToast('L∆∞u li√™n k·∫øt th·∫•t b·∫°i: ' + (code || msg || 'UNKNOWN_ERROR'));
            }
        }

        async function reconnectByLinkedPhone() {
            const inputPhone = normalizePhone(document.getElementById('linkedPhone')?.value || '');

            // Kh√¥ng cho bypass b·∫±ng c√°ch nh·∫≠p SƒêT r·ªìi reconnect th·∫≥ng
            if (inputPhone && inputPhone !== linkedPhone) {
                await saveLinkedPhone();
            }

            if (!linkedPhone) { showToast('Ch∆∞a c√≥ SƒêT li√™n k·∫øt ƒë·ªÉ reconnect'); return; }

            try {
                await ensurePhoneOwnership(linkedPhone);
            } catch (_) {
                showToast('SƒêT n√†y thu·ªôc t√†i kho·∫£n kh√°c, kh√¥ng th·ªÉ reconnect');
                return;
            }

            mqttUserId = linkedPhone;

            window.devices = {};
            document.getElementById('grid').innerHTML = '';
            updateCounter();
            connect();
        }

        async function changePasswordInApp() {
            const p1 = document.getElementById('newPassword')?.value || '';
            const p2 = document.getElementById('confirmPassword')?.value || '';
            if (p1.length < 6) { showToast('M·∫≠t kh·∫©u m·ªõi t·ªëi thi·ªÉu 6 k√Ω t·ª±'); return; }
            if (p1 !== p2) { showToast('X√°c nh·∫≠n m·∫≠t kh·∫©u kh√¥ng kh·ªõp'); return; }
            const user = firebase.auth().currentUser;
            if (!user) { showToast('Ch∆∞a ƒëƒÉng nh·∫≠p'); return; }
            try {
                await user.updatePassword(p1);
                showToast('ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng');
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            } catch (err) {
                if (String(err.code || '').includes('requires-recent-login')) {
                    showToast('Phi√™n ƒëƒÉng nh·∫≠p c≈©, h√£y ƒëƒÉng nh·∫≠p l·∫°i r·ªìi ƒë·ªïi m·∫≠t kh·∫©u');
                } else {
                    showToast('Kh√¥ng ƒë·ªïi ƒë∆∞·ª£c m·∫≠t kh·∫©u');
                }
            }
        }

        async function sendResetEmailFromApp() {
            const email = (document.getElementById('accEmail')?.value || firebase.auth().currentUser?.email || '').trim();
            if (!email) { showToast('Kh√¥ng c√≥ email ƒë·ªÉ g·ª≠i reset'); return; }
            try {
                await firebase.auth().sendPasswordResetEmail(email);
                showToast('ƒê√£ g·ª≠i email reset m·∫≠t kh·∫©u');
            } catch (e) {
                showToast('G·ª≠i email reset th·∫•t b·∫°i');
            }
        }
        function saveGeminiKey(val) { localStorage.setItem("gemini_api_key", val.trim()); showToast("ƒê√£ l∆∞u API Key"); }

        function startVoice(btn) {
            if (!('webkitSpeechRecognition' in window)) { alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ gi·ªçng n√≥i"); return; }
            const r = new webkitSpeechRecognition();
            r.lang = 'vi-VN';
            r.start();
            btn.classList.add('listening');
            r.onresult = (e) => {
                document.getElementById("aiCommand").value = e.results[0][0].transcript;
                btn.classList.remove('listening');
                executeAI();
            }
            r.onerror = () => btn.classList.remove('listening');
            r.onspeechend = () => btn.classList.remove('listening');
        }

        async function executeAI() {
            const cmd = document.getElementById("aiCommand").value;
            const key = document.getElementById("geminiKey").value;
            const resBox = document.getElementById("aiResponse");

            if (!cmd || !key) { showToast("Nh·∫≠p l·ªánh v√† API Key!"); return; }
            resBox.style.display = "block";
            resBox.innerHTML = "ü§ñ ƒêang suy nghƒ©...";

            const context = JSON.stringify(window.devices);
            const prompt = `Tr·ª£ l√Ω IoT. Devices: ${context}. User: "${cmd}". 
    JSON Output: { "target": "dev_id"|"ALL", "action": "config"|"maint", "params": {...}, "message": "..." }`;

            try {
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const d = await resp.json();
                const raw = d.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                const logic = JSON.parse(raw);
                resBox.innerHTML = `ü§ñ ${logic.message}`;

                if (logic.action) {
                    const targets = (logic.target === "ALL") ? Object.keys(window.devices) : [logic.target];
                    targets.forEach(id => {
                        if (window.devices[id]) {
                            if (logic.action === "config") {
                                rpcSend(id, "setOffMin", logic.params.off);
                                rpcSend(id, "setOnSec", logic.params.on);
                                rpcSend(id, "save", 1);
                            }
                            if (logic.action === "maint") rpcSend(id, "setMaintenance", logic.mode);
                        }
                    });
                }
            } catch (e) { resBox.innerHTML = "‚ùå L·ªói AI"; }
        }

        async function analyzeSystem() {
            const key = document.getElementById("geminiKey").value;
            if (!key) { showToast("C·∫ßn API Key"); return; }
            const context = JSON.stringify(window.devices);
            const prompt = `Ph√¢n t√≠ch IoT: ${context}. B√°o c√°o ng·∫Øn g·ªçn c√°c b·∫•t th∆∞·ªùng (nhi·ªát/d√≤ng/k·∫øt n·ªëi).`;

            document.getElementById("aiResponse").style.display = "block";
            document.getElementById("aiResponse").innerHTML = "üîç ƒêang kh√°m...";
            try {
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const d = await resp.json();
                document.getElementById("aiResponse").innerHTML = marked.parse(d.candidates[0].content.parts[0].text);
            } catch (e) { alert("L·ªói AI"); }
        }

        function showToast(m) {
            const t = document.getElementById("toast");
            t.innerText = m; t.style.display = "block";
            setTimeout(() => t.style.display = "none", 3000);
        }
    </script>
</body>

</html>
