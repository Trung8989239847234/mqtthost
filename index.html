<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Timer Cloud Control</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
  <style>
    :root { --accent: #00ff00; --accentGlow: rgba(0, 255, 0, 0.55); }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: #fff; display: flex; justify-content: center; min-height: 100vh; margin: 0; padding-top: 20px; box-sizing: border-box; }
    .card { background: rgba(30, 30, 30, 0.85); backdrop-filter: blur(12px); padding: 20px; border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(0,0,0,0.37); width: 100%; max-width: 380px; text-align: center; border: 1px solid rgba(255,255,255,0.1); height: fit-content; margin-bottom: 20px; position: relative;}
    
    /* Tabs */
    .nav-tabs { display: flex; justify-content: space-around; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
    .nav-item { cursor: pointer; padding: 8px 12px; color: #aaa; font-weight: 600; font-size: 13px; text-transform: uppercase; border-radius: 8px; transition: 0.3s; }
    .nav-item.active { background: rgba(255,255,255,0.15); color: #fff; border: 1px solid rgba(255,255,255,0.1); }
    .tab-content { display: none; animation: fadeIn 0.4s; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* Timer */
    .timer-box { background: rgba(0,0,0,0.3); color: var(--accent); font-family: 'Courier New', monospace; font-size: 56px; padding: 15px 0; border-radius: 12px; margin-top: 15px; border: 1px solid rgba(255,255,255,0.1); text-shadow: 0 0 18px var(--accentGlow); font-weight: bold; }
    .status-badge { padding: 5px 12px; border-radius: 50px; font-weight: bold; font-size: 11px; display: inline-block; margin-bottom: 10px; text-transform: uppercase; }
    .status-on { background: #28a745; color: #fff; } .status-off { background: #6c757d; color: #ddd; }
    .status-maint { background: #dc3545; animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0.7; } }

    /* Controls */
    .control-row { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .stepper { display: flex; align-items: center; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 2px; }
    .btn-step { background: none; border: none; color: #fff; font-size: 20px; width: 35px; height: 35px; cursor: pointer; }
    .stepper input { background: transparent; border: none; color: #fff; font-size: 16px; width: 50px; text-align: center; font-weight: bold; outline: none; }
    
    .btn-primary { background: linear-gradient(90deg, #0061ff, #60efff); color: white; border: none; padding: 14px; width: 100%; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 10px; text-transform: uppercase; }
    .btn-m { background: rgba(255,255,255,0.1); color: #ddd; border: 1px solid rgba(255,255,255,0.1); font-size: 12px; padding: 10px; border-radius: 8px; cursor: pointer; width: 30%; margin: 3px; }
    .btn-del { background: rgba(255, 59, 48, 0.2); border: 1px solid #ff3b30; color: #ff3b30; border-radius: 6px; padding: 4px 8px; cursor: pointer; }

    /* Schedule */
    .tbl { width: 100%; border-collapse: collapse; font-size: 12px; }
    .tbl td { padding: 8px 4px; text-align: left; vertical-align: middle; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .tbl input[type="time"] { background: rgba(0,0,0,0.3); border: 1px solid #555; color: #fff; border-radius: 5px; padding: 5px; width: 100%; box-sizing: border-box; }
    
    /* Day Selector */
    .day-selector { display: flex; gap: 3px; margin-top: 5px; flex-wrap: wrap; }
    .day-btn { width: 22px; height: 22px; border-radius: 50%; border: 1px solid #666; background: rgba(0,0,0,0.3); color: #888; font-size: 9px; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; user-select: none; }
    .day-btn.active { background: #0a84ff; color: #fff; border-color: #0a84ff; box-shadow: 0 0 5px #0a84ff; }

    /* Switch */
    .switch { position: relative; display: inline-block; width: 36px; height: 20px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #555; transition: .2s; border-radius: 20px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; top: 2px; background: white; transition: .2s; border-radius: 50%; }
    input:checked + .slider { background: #28a745; }
    input:checked + .slider:before { transform: translateX(16px); }

    /* Connection Status */
    #conn-stat { position: absolute; top: 15px; right: 15px; width: 10px; height: 10px; border-radius: 50%; background: #dc3545; box-shadow: 0 0 8px #dc3545; transition: 0.3s; }
    #conn-stat.ok { background: #28a745; box-shadow: 0 0 8px #28a745; }
  </style>
</head>
<body>

<div class="card">
  <div id="conn-stat" title="Disconnected"></div>
  
  <div class="nav-tabs">
    <div class="nav-item active" onclick="switchTab('home')" id="tab-home">Trang Ch·ªß</div>
    <div class="nav-item" onclick="switchTab('sch')" id="tab-sch">H·∫πn Gi·ªù</div>
    <div class="nav-item" onclick="switchTab('set')" id="tab-set">C√†i ƒê·∫∑t</div>
  </div>

  <div id="home" class="tab-content active">
    <div id="statusBadge" class="status-badge status-off">ƒêANG K·∫æT N·ªêI...</div>
    <div id="timerDisplay" class="timer-box">--:--</div>
    
    <div class="control-row">
      <div>üèÉ CH·∫†Y (Gi√¢y)</div>
      <div class="stepper"><button class="btn-step" onclick="adj('onSec',-1)">‚àí</button><input type="number" id="onSec" value="5"><button class="btn-step" onclick="adj('onSec',1)">+</button></div>
    </div>
    <div class="control-row">
      <div>üí§ NGH·ªà (Ph√∫t)</div>
      <div class="stepper"><button class="btn-step" onclick="adj('offMin',-1)">‚àí</button><input type="number" id="offMin" value="1"><button class="btn-step" onclick="adj('offMin',1)">+</button></div>
    </div>

    <button class="btn-primary" onclick="saveSettings()">L∆ØU C√ÄI ƒê·∫∂T</button>
    <div style="font-size:11px; color:#aaa; margin-top:5px">‚ö†Ô∏è B·∫•m L∆ØU ƒë·ªÉ c·∫≠p nh·∫≠t xu·ªëng m·∫°ch</div>

    <div style="margin-top:20px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px">
      <div style="font-size:11px;color:#aaa;text-align:left;margin-bottom:5px">CH·∫æ ƒê·ªò B·∫¢O TR√å</div>
      <div>
        <button class="btn-m" onclick="sendRPC('setMaintenance',1)">7p</button>
        <button class="btn-m" onclick="sendRPC('setMaintenance',3)">30p</button>
        <button class="btn-m" onclick="sendRPC('setMaintenance',6)" style="color:#ffd60a;border-color:#ffd60a">Th·ªß c√¥ng</button>
      </div>
      <button class="btn-m" style="width:100%;margin-top:5px;color:#ff453a;border-color:#ff453a" onclick="sendRPC('setMaintenance',0)">H·ª¶Y B·∫¢O TR√å</button>
    </div>
  </div>

  <div id="sch" class="tab-content">
    <div style="text-align:left;font-size:11px;color:#aaa;margin-bottom:10px">L·ªãch ng·ª´ng ho·∫°t ƒë·ªông (ngh·ªâ ng∆°i) theo gi·ªù.</div>
    <div style="max-height:320px; overflow-y:auto">
        <table class="tbl"><tbody id="pauseTbody"></tbody></table>
    </div>
    <button class="btn-m" style="width:100%;margin-top:10px;border:1px dashed #666" onclick="addPauseRow()">+ Th√™m m·ªëc</button>
    <button class="btn-primary" onclick="uploadPauseJson()">L∆ØU L·ªäCH TR√åNH</button>
  </div>

  <div id="set" class="tab-content">
    <h3>Th√¥ng tin thi·∫øt b·ªã</h3>
    <div class="control-row"><span>Device ID</span><span style="color:#00ff00">timer02</span></div>
    <div class="control-row"><span>WiFi Signal</span><span id="info-rssi">...</span></div>
    <div class="control-row"><span>Free RAM</span><span id="info-heap">...</span></div>
    <div class="control-row"><span>Uptime</span><span id="info-uptime">...</span></div>
    <div style="margin-top:20px;font-size:10px;color:#666">Cloud Dashboard v2.0 (WSS Port 8084)</div>
  </div>
</div>

<script>
// --- C·∫§U H√åNH MQTT ---
const mqttConfig = {
    host: "n21f2dda.ala.dedicated.aws.emqxcloud.com",
    port: 8084, // C·ªïng WSS cho Web
    path: "/mqtt",
    clientId: "Web_" + parseInt(Math.random() * 100000),
    user: "anhtrung1", pass: "anhtrung1",
    topicSub: "devices/timer02/telemetry",
    topicPubBase: "devices/timer02/rpc/request/"
};

let client;
let pauseRanges = [];
let lastInteraction = 0; // ƒê·ªÉ tr√°nh update ƒë√® khi ƒëang ch·ªânh

// --- MQTT LOGIC ---
function connectMQTT() {
    client = new Paho.MQTT.Client(mqttConfig.host, mqttConfig.port, mqttConfig.path, mqttConfig.clientId);
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;
    client.connect({ useSSL: true, userName: mqttConfig.user, password: mqttConfig.pass, onSuccess: onConnect, onFailure: onFailure });
}

function onConnect() {
    console.log("Connected");
    document.getElementById("conn-stat").className = "ok";
    client.subscribe(mqttConfig.topicSub);
    // [QUAN TR·ªåNG] H·ªèi ESP32 g·ª≠i l·∫°i d·ªØ li·ªáu ngay khi k·∫øt n·ªëi
    sendRPC("getData", {});
}

function onFailure(e) { console.log("Failed", e); setTimeout(connectMQTT, 5000); }
function onConnectionLost(e) { document.getElementById("conn-stat").className = ""; setTimeout(connectMQTT, 5000); }

function onMessageArrived(msg) {
    try {
        const d = JSON.parse(msg.payloadString);
        const isIdle = (Date.now() - lastInteraction > 5000); // Ch·ªâ update input n·∫øu user ko b·∫•m g√¨ 5s

        // Update Inputs (ch·ªâ khi idle ƒë·ªÉ tr√°nh nh·∫£y s·ªë khi ƒëang b·∫•m)
        if (d.off_min !== undefined && isIdle) document.getElementById("offMin").value = d.off_min;
        if (d.on_sec !== undefined && isIdle) document.getElementById("onSec").value = d.on_sec;

        // Update Info
        if (d.rssi) document.getElementById("info-rssi").innerText = d.rssi + " dBm";
        if (d.free_heap) document.getElementById("info-heap").innerText = d.free_heap;
        if (d.uptime_s) document.getElementById("info-uptime").innerText = Math.floor(d.uptime_s/60) + " ph√∫t";

        // Update Timer & Status
        if (d.status) {
            const b = document.getElementById("statusBadge");
            const tb = document.getElementById("timerDisplay");
            let cls = "status-off", txt = d.status, col = "#6c757d";
            if (d.pause_active) { txt = "‚è∏ ƒêANG NGH·ªà (L·ªäCH)"; }
            else if (d.maint_mode > 0) { txt = "üîß ƒêANG B·∫¢O TR√å"; cls = "status-maint"; col = "#dc3545"; }
            else if (d.relay_run) { txt = "RUNNING (ON)"; cls = "status-on"; col = "#28a745"; }
            else if (d.status === "CHO RESET") { cls = "status-wait"; col = "#ffc107"; }
            b.className = "status-badge " + cls; b.innerHTML = txt;
            tb.style.color = col; tb.style.textShadow = "0 0 20px " + col;
        }
        if (d.time_rem) document.getElementById("timerDisplay").innerHTML = d.time_rem;

        // Update Schedule (Load 1 l·∫ßn ƒë·∫ßu ho·∫∑c khi c√≥ thay ƒë·ªïi t·ª´ n∆°i kh√°c)
        if (d.pause_json && (pauseRanges.length === 0 || isIdle)) {
            const newArr = JSON.parse(d.pause_json);
            if (JSON.stringify(newArr) !== JSON.stringify(pauseRanges)) {
                pauseRanges = newArr;
                renderPauseTable();
            }
        }
    } catch(e) {}
}

function sendRPC(method, params) {
    if (!client || !client.isConnected()) return;
    const topic = mqttConfig.topicPubBase + parseInt(Math.random() * 10000);
    const payload = JSON.stringify({ method: method, params: params });
    const message = new Paho.MQTT.Message(payload);
    message.destinationName = topic;
    client.send(message);
}

// --- UI INTERACTION ---
function switchTab(t) {
    document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
    document.getElementById(t).classList.add('active');
    document.getElementById('tab-' + t).classList.add('active');
}

function adj(id, val) {
    const el = document.getElementById(id);
    let v = parseInt(el.value || 0) + val;
    if (v < 0) v = 0;
    if (id === 'onSec' && v < 1) v = 1;
    el.value = v;
    lastInteraction = Date.now();
}

function saveSettings() {
    const m = parseInt(document.getElementById("offMin").value);
    const s = parseInt(document.getElementById("onSec").value);
    sendRPC("save", {offMin: m, onSec: s});
    alert("ƒê√£ g·ª≠i l·ªánh L∆∞u!");
}

function applyPreset(m, s) {
    document.getElementById("offMin").value = m;
    document.getElementById("onSec").value = s;
    saveSettings();
}

// --- SCHEDULE LOGIC ---
function renderPauseTable() {
    const tb = document.getElementById("pauseTbody");
    tb.innerHTML = "";
    const labels = ["CN","T2","T3","T4","T5","T6","T7"];
    pauseRanges.forEach((r, idx) => {
        const s = r.s || "12:00";
        const e = r.e || "13:00";
        const on = (r.on === 1 || r.on === true);
        const w = (r.w !== undefined) ? r.w : 127;
        let daysHtml = '<div class="day-selector">';
        for (let i = 1; i <= 7; i++) {
            let bitIdx = (i === 7) ? 0 : i;
            let isActive = (w & (1 << bitIdx));
            daysHtml += `<div class="day-btn ${isActive?'active':''}" onclick="toggleDay(${idx}, ${bitIdx}, this)">${labels[bitIdx]}</div>`;
        }
        daysHtml += '</div>';
        const row = document.createElement("tr");
        row.innerHTML = `
            <td><input type="time" value="${s}" onchange="updSch(${idx}, 's', this.value)"></td>
            <td><input type="time" value="${e}" onchange="updSch(${idx}, 'e', this.value)"></td>
            <td style="width:40px;text-align:center"><label class="switch"><input type="checkbox" ${on?'checked':''} onchange="updSch(${idx}, 'on', this.checked?1:0)"><span class="slider"></span></label></td>
            <td style="width:30px"><button class="btn-del" onclick="delSch(${idx})">X</button></td>
        `;
        const row2 = document.createElement("tr");
        row2.innerHTML = `<td colspan="4" style="padding-top:0;border-bottom:1px solid rgba(255,255,255,0.1)">${daysHtml}</td>`;
        tb.appendChild(row);
        tb.appendChild(row2);
    });
}

function addPauseRow() { pauseRanges.push({s: "12:00", e: "13:00", on: 1, w: 127}); renderPauseTable(); lastInteraction = Date.now(); }
function delSch(idx) { if (confirm("X√≥a?")) { pauseRanges.splice(idx, 1); renderPauseTable(); lastInteraction = Date.now(); } }
function updSch(idx, key, val) { pauseRanges[idx][key] = val; lastInteraction = Date.now(); }
function toggleDay(idx, bit, el) {
    if (!pauseRanges[idx]) return;
    let w = (pauseRanges[idx].w !== undefined) ? pauseRanges[idx].w : 127;
    w ^= (1 << bit); // Toggle bit
    pauseRanges[idx].w = w;
    el.classList.toggle('active');
    lastInteraction = Date.now();
}
function uploadPauseJson() {
    const jsonStr = JSON.stringify(pauseRanges);
    sendRPC("setPauseJson", jsonStr);
    alert("ƒê√£ g·ª≠i l·ªãch tr√¨nh!");
}

connectMQTT();
</script>
</body>
</html>
