<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ESP32 TIMER PRO (EMQX)</title>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    /* === STYLE C≈® GI·ªÆ NGUY√äN === */
    :root { --accent:#00ff00; --accentGlow: rgba(0,255,0,0.55); }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);
      color:#fff; display:flex; justify-content:center; align-items:center;
      min-height:100vh; margin:0;
    }
    .card{
      background:rgba(30,30,30,0.75);
      backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
      padding:20px; border-radius:20px;
      box-shadow:0 8px 32px 0 rgba(0,0,0,0.37);
      width:360px; text-align:center;
      border:1px solid rgba(255,255,255,0.1);
      position: relative; /* ƒê·ªÉ toast hi·ªÉn th·ªã ƒë√∫ng */
    }

    .nav-tabs{display:flex;justify-content:space-around;margin-bottom:20px;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:10px}
    .nav-item{cursor:pointer;padding:8px 16px;color:#aaa;font-weight:600;font-size:14px;text-transform:uppercase;border-radius:8px;transition:.3s}
    .nav-item.active{background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.1)}
    .tab-content{display:none}
    .tab-content.active{display:block;animation:fadeIn .4s}
    @keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}

    h2{font-size:18px;font-weight:600;color:#e5e5e5;margin-bottom:5px;text-transform:uppercase;letter-spacing:1px}

    .timer-box{
      background:rgba(0,0,0,0.3);
      color:var(--accent,#00ff00);
      font-family:'Courier New',monospace;
      font-size:56px;padding:15px 0;border-radius:12px;margin-top:15px;
      border:1px solid rgba(255,255,255,0.1);
      text-shadow:0 0 18px var(--accentGlow,rgba(0,255,0,0.5));
      font-weight:bold; position:relative;
    }

    .progress-container{width:100%;background-color:rgba(255,255,255,0.1);height:6px;border-radius:0 0 10px 10px;overflow:hidden;margin-bottom:15px;margin-top:-5px}
    .progress-bar{height:100%;width:100%;background-color:#28a745;transition:width 1s linear, background-color .5s}

    .status-badge{padding:6px 15px;border-radius:50px;font-weight:600;font-size:12px;display:inline-block;margin-bottom:10px;text-transform:uppercase;letter-spacing:.5px;box-shadow:0 2px 10px rgba(0,0,0,0.2)}
    .status-on{background:linear-gradient(90deg,#11998e,#38ef7d);color:#fff;border:none}
    .status-off{background:rgba(255,255,255,0.15);color:#ccc;border:1px solid #666}
    .status-wait{background:linear-gradient(90deg,#f12711,#f5af19);color:#fff;border:none}
    .status-maint{background:linear-gradient(90deg,#ED213A,#93291E);color:#fff;border:none;animation:blink 1s infinite}
    @keyframes blink{50%{opacity:.7}}

    .control-row{background-color:rgba(255,255,255,0.05);border-radius:12px;padding:15px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,0.05)}
    .label-section{display:flex;align-items:center;gap:12px;font-weight:600;font-size:14px;color:#e5e5e5;text-align:left}
    .icon{font-size:22px}
    .sub-text{font-size:11px;color:#8e8e93;display:block;font-weight:normal;margin-top:2px}

    .stepper{
      display:flex;
      align-items:center;
      background-color:rgba(0,0,0,0.2);
      border-radius:10px;
      padding:6px;              /* tƒÉng padding */
      gap:6px;                  /* t·∫°o kho·∫£ng c√°ch r√µ */
    }

    .btn-step{
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);
      color:#fff;
      font-size:26px;

      width:48px;               /* >= 44px ƒë·ªÉ d·ªÖ b·∫•m */
      height:48px;
      border-radius:12px;

      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:.15s;

      touch-action:manipulation;               /* gi·∫£m delay & miss tap */
      -webkit-tap-highlight-color:transparent; /* b·ªè highlight iOS */
      user-select:none;
    }

    .btn-step:active{opacity:.6;transform:scale(.96)}
    .btn-step:hover{color:#0a84ff}

    .stepper input{
      background:transparent;
      border:none;
      color:#fff;
      font-size:18px;
      width:64px;
      text-align:center;
      font-weight:bold;
      outline:none;
      -moz-appearance:textfield;
    }

    .stepper input::-webkit-outer-spin-button,
    .stepper input::-webkit-inner-spin-button{
      -webkit-appearance:none;
      margin:0;
    }

    @media (max-width: 420px){
      .btn-step{ width:56px; height:56px; font-size:30px; }
      .stepper input{ width:72px; font-size:20px; }
      .card{ width:min(420px, 92vw); }
    }

    .btn-primary{background:linear-gradient(90deg,#0061ff,#60efff);color:#fff;border:none;padding:14px;width:100%;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;transition:.2s;margin-top:5px;box-shadow:0 4px 15px rgba(0,97,255,0.4);text-transform:uppercase}
    .btn-primary:active{transform:scale(.98);box-shadow:0 2px 10px rgba(0,97,255,0.3)}

    .presets-container{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:15px}
    .btn-preset{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.1);color:#ccc;border-radius:8px;padding:8px;font-size:11px;cursor:pointer;transition:.2s}
    .btn-preset:hover{background:rgba(255,255,255,0.15);color:#fff;border-color:#0a84ff}
    .btn-preset span{display:block;font-weight:bold;font-size:13px;margin-bottom:2px;color:#fff}

    .maintenance-title{color:#8e8e93;font-size:11px;font-weight:bold;text-align:left;margin:25px 0 10px 0;text-transform:uppercase;letter-spacing:.5px;border-top:1px solid rgba(255,255,255,0.1);padding-top:15px}
    .maintenance-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .btn-m{background:rgba(255,255,255,0.05);color:#ddd;border:1px solid rgba(255,255,255,0.1);font-size:12px;padding:10px 0;border-radius:8px;cursor:pointer;transition:.2s}
    .btn-m:hover{background:rgba(255,255,255,0.15)}
    .btn-manual{color:#ffd60a;border-color:rgba(255,214,10,0.3)}
    .btn-cancel{background:rgba(255,69,58,0.15);color:#ff453a;border:1px solid rgba(255,69,58,0.3);margin-top:10px;width:100%;padding:12px;border-radius:10px;font-weight:600;cursor:pointer}

    .input-group{margin-bottom:12px;text-align:left;position:relative}
    .input-group label{display:block;font-size:12px;color:#aaa;margin-bottom:4px}
    .input-group input,.input-group select{width:100%;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);color:#fff;padding:10px;border-radius:8px;font-size:14px;box-sizing:border-box;transition:.3s}
    .input-group input:focus{border-color:#0a84ff;outline:none;background:rgba(0,0,0,0.5)}
    .toggle-eye{position:absolute;right:10px;top:32px;cursor:pointer;font-size:16px;opacity:.6}
    .toggle-eye:hover{opacity:1}

    .log-box{margin-top:25px;background:rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:10px;height:110px;overflow-y:auto;text-align:left;font-family:'Courier New',monospace;font-size:10px;color:#00ff00;opacity:.9}
    .log-entry{margin-bottom:2px;border-bottom:1px dashed #333}
    
    /* === [M·ªöI] STYLE CHO TIMELINE & TOAST === */
    
    /* Timeline 24H */
    .timeline-container { margin: 15px 0 20px 0; text-align: left; }
    .timeline-labels { display: flex; justify-content: space-between; font-size: 10px; color: #888; margin-bottom: 3px; }
    .timeline-bar {
        width: 100%; height: 10px; background: #28a745; border-radius: 5px; overflow: hidden; display: flex;
        border: 1px solid rgba(255,255,255,0.1);
    }
    .t-seg { height: 100%; }
    .t-run { background: #28a745; } /* M√†u xanh ch·∫°y */
    .t-off { background: #dc3545; } /* M√†u ƒë·ªè ngh·ªâ */
    
    /* Toast Notification (Thay th·∫ø Alert) */
    #toast {
        visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 50px;
        padding: 12px; position: fixed; z-index: 1000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.3s, bottom 0.3s;
        border: 1px solid rgba(255,255,255,0.2);
    }
    #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
    
    /* Schedule & Others */
    .card2{background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.12);border-radius:14px;padding:12px;margin-top:10px}
    .tbl{width:100%;border-collapse:collapse;font-size:12px}
    .tbl th,.tbl td{padding:8px 6px;border-bottom:1px solid rgba(255,255,255,0.08);text-align:left}
    .tbl th{color:#cfcfd4;font-weight:700;font-size:11px;letter-spacing:.2px}
    .tbl td{color:#fff;vertical-align:middle}
    .tbl input[type="time"]{width:100%;background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.12);color:#fff;padding:6px 8px;border-radius:8px;font-size:12px}
    .switch{position:relative;display:inline-block;width:44px;height:24px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#6c757d;transition:.2s;border-radius:999px}
    .slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:.2s;border-radius:50%}
    input:checked + .slider{background-color:#28a745}
    input:checked + .slider:before{transform:translateX(20px)}
    .btn-del{background:rgba(255,69,58,0.25);border:1px solid rgba(255,69,58,0.35);color:#ffb4ae;border-radius:10px;padding:7px 10px;cursor:pointer}
    .btn-del:hover{background:rgba(255,69,58,0.35)}
    .day-selector{display:flex;gap:6px;flex-wrap:wrap}
    .day-btn{padding:6px 8px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.06);color:#cfd2d8;font-weight:700;font-size:11px;cursor:pointer}
    .day-btn.active{background:rgba(10,132,255,0.25);border-color:rgba(10,132,255,0.5);color:#fff}
    .btn-row{display:flex;gap:8px;margin-top:8px}
    .btn-row .btn-m{flex:1}
    .btn-save{background:#28a745;border:0;color:#fff;border-radius:10px;padding:10px 0;font-weight:800;cursor:pointer;flex:1}
    .btn-save:hover{filter:brightness(1.06)}
    .badge-conn{display:inline-block;font-size:11px;color:#cfd2d8;margin-top:6px;opacity:.9}

    /* === [M·ªöI] HI·ªÇN TH·ªä AMPS / TEMP (ƒê∆†N GI·∫¢N) === */
    .simple-sensors{
      margin:10px 0 6px;
      display:flex;
      justify-content:center;
      align-items:baseline;
      gap:18px;
      font-family:'Courier New',monospace;
      font-weight:900;
      font-size:22px;
      color:#e5e5e5;
      letter-spacing:.3px;
    }
    .simple-sensors .unit{font-size:13px;font-weight:800;opacity:.75;margin-left:4px}
@media (max-width: 420px){ .simple-sensors{font-size:24px} }

    /* === [M·ªöI] STATUS DOT + SETTINGS COLLAPSE + LOCK === */
    .simple-sensors{
      transition: opacity .25s ease;
      gap:16px;
    }
    .simple-sensors.stale{ opacity:.45; }
    .status-dot{
      width:9px;height:9px;border-radius:999px;
      display:inline-block;
      margin-right:10px;
      box-shadow:0 0 0 1px rgba(255,255,255,0.15);
      vertical-align:middle;
      transform: translateY(-1px);
    }
    .status-ok{ background:#34c759; box-shadow:0 0 10px rgba(52,199,89,.35), 0 0 0 1px rgba(255,255,255,0.15); }
    .status-warn{ background:#ffcc00; box-shadow:0 0 10px rgba(255,204,0,.30), 0 0 0 1px rgba(255,255,255,0.15); }
    .status-bad{ background:#ff3b30; box-shadow:0 0 10px rgba(255,59,48,.30), 0 0 0 1px rgba(255,255,255,0.15); }

    .settings-bar{
      margin:10px 0 6px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .btn-ghost{
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);
      color:#e5e5e5;
      border-radius:12px;
      padding:10px 12px;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      transition:.15s;
      touch-action:manipulation;
      -webkit-tap-highlight-color:transparent;
      user-select:none;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .btn-ghost:active{opacity:.65;transform:scale(.98)}
    .btn-ghost .chev{opacity:.75;transition:transform .2s ease}
    .btn-ghost.open .chev{transform:rotate(180deg)}
    .btn-ghost.locked{border-color:rgba(255,59,48,.35);}

    .settings-panel{
      overflow:hidden;
      max-height:0;
      opacity:0;
      transform:translateY(-4px);
      transition:max-height .25s ease, opacity .25s ease, transform .25s ease;
    }
    .settings-panel.open{
      max-height:2600px; /* ƒë·ªß l·ªõn cho to√†n b·ªô ph·∫ßn c√†i ƒë·∫∑t */
      opacity:1;
      transform:translateY(0);
    }

    /* Khi kh√≥a: l√†m m·ªù to√†n b·ªô ph·∫ßn c√†i ƒë·∫∑t */
    .settings-panel.is-locked{ opacity:.55; }
    .settings-panel.is-locked button,
    .settings-panel.is-locked input{
      pointer-events:none;
    }

    /* === [M·ªöI] LOCK ONLY (center + big) === */
    .settings-bar{
      justify-content:center;
      margin:12px 0 10px;
    }
    .btn-lock-big{
      width:auto;
      min-width:180px;
      height:40px;
      border-radius:12px;
      padding:0 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:0;
      white-space:nowrap;
      /* font gi·ªëng tab TRANG CH·ª¶ */
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      font-weight:600;
      font-size: 12px;
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    @media (max-width: 420px){
      .btn-lock-big{ min-width:200px; height:44px; font-size: 12px; border-radius:12px; }
    }
    .lock-note{
      margin-top:8px;
      font-size:12px;
      color:#8e8e93;
      font-weight:700;
      letter-spacing:.2px;
    }
    #lockBtnLabel{display:inline-block;}

    /* === [M·ªöI] BADGES ROW (STATUS/MQTT/DEVICE) === */
    .badges-row{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .pill{
      padding:6px 15px;
      border-radius:50px;
      font-weight:600;
      font-size:12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      text-transform:uppercase;
      letter-spacing:.5px;
      box-shadow:0 2px 10px rgba(0,0,0,0.2);
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.10);
      color:#e5e5e5;
      white-space:nowrap;
    }
    .pill .dot{
      width:8px;height:8px;border-radius:999px;display:inline-block;
      box-shadow:0 0 0 1px rgba(255,255,255,0.15);
    }
    .pill.mqtt-ok .dot{background:#34c759; box-shadow:0 0 10px rgba(52,199,89,.35), 0 0 0 1px rgba(255,255,255,0.15);}
    .pill.mqtt-bad .dot{background:#ff3b30; box-shadow:0 0 10px rgba(255,59,48,.30), 0 0 0 1px rgba(255,255,255,0.15);}
    .pill.dev-ok .dot{background:#34c759; box-shadow:0 0 10px rgba(52,199,89,.35), 0 0 0 1px rgba(255,255,255,0.15);}
    .pill.dev-bad .dot{background:#ff3b30; box-shadow:0 0 10px rgba(255,59,48,.30), 0 0 0 1px rgba(255,255,255,0.15);}

  

/* =============================
   SETTINGS ACCORDION (CARDS)
   ============================= */
.cfg-wrap{margin-top:8px;}
.cfg-card{
  border:1px solid rgba(255,255,255,0.10);
  border-radius:16px;
  overflow:hidden;
  margin:10px 0;
  background:rgba(0,0,0,0.22);
}
.cfg-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  padding:12px 12px;
  cursor:pointer;
  user-select:none;
}
.cfg-left{display:flex;align-items:center;gap:10px;}
.cfg-badge{
  font-size:10px;
  font-weight:900;
  letter-spacing:.7px;
  text-transform:uppercase;
  padding:4px 8px;
  border-radius:999px;
  background:rgba(255,255,255,0.10);
  border:1px solid rgba(255,255,255,0.10);
  color:#e5e5e5;
}
.cfg-title{font-weight:800;font-size:13px;letter-spacing:.3px;}
.cfg-arrow{opacity:.75;transition:transform .2s ease;}
.cfg-body{
  max-height:0;
  opacity:0;
  transform:translateY(-3px);
  transition:max-height .25s ease, opacity .25s ease, transform .25s ease;
  padding:0 12px;
}
.cfg-card.open .cfg-body{
  max-height:2200px;
  opacity:1;
  transform:translateY(0);
  padding-bottom:12px;
}
.cfg-card.open .cfg-arrow{transform:rotate(180deg);}
.cfg-note{
  margin-top:6px;
  font-size:11px;
  color:#8e8e93;
  text-align:left;
  font-weight:700;
}
.cfg-footnote{
  margin-top:8px;
  font-size:11px;
  color:#cfd2d8;
  opacity:.85;
  text-align:left;
}

.cfg-card.wifi{border-left:4px solid #0a84ff;}
.cfg-card.blynk{border-left:4px solid #34c759;}
.cfg-card.tb{border-left:4px solid #32ade6;}
.cfg-card.sensors{border-left:4px solid #ff9f0a;}
.cfg-card.emqx-dev{border-left:4px solid #bf5af2;}
.cfg-card.mqttws{border-left:4px solid #60efff;}

/* === [NEW] MODAL PIN === */
.modal-overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.6);backdrop-filter:blur(5px);
  z-index:2000;display:none;justify-content:center;align-items:center;
}
.modal-overlay.show{display:flex;animation:fadeIn .2s}
.modal-box{
  background:#2a2a2a;border:1px solid rgba(255,255,255,0.1);
  padding:20px;border-radius:16px;width:280px;text-align:center;
  box-shadow:0 10px 40px rgba(0,0,0,0.5);
}
.pin-display{
  background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);
  color:#fff;font-size:24px;letter-spacing:5px;padding:10px;
  width:100%;border-radius:8px;margin-bottom:15px;text-align:center;
  outline:none;font-weight:bold;
}
.pin-pad{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.btn-pin{
  background:rgba(255,255,255,0.1);border:none;color:#fff;
  font-size:18px;padding:12px;border-radius:8px;cursor:pointer;
  transition:.1s;
}
.btn-pin:active{background:rgba(255,255,255,0.2);transform:scale(.95)}
.btn-pin.red{background:rgba(255,69,58,0.2);color:#ff453a}
.btn-pin.green{background:rgba(40,167,69,0.2);color:#28a745}

</style>
</head>

<body>
  <div id="toast">Th√¥ng b√°o</div>

  <!-- [NEW] Modal PIN -->
  <div id="pinModal" class="modal-overlay">
    <div class="modal-box">
      <h3 style="margin-top:0;color:#e5e5e5;font-size:16px;margin-bottom:15px">NH·∫¨P M·∫¨T KH·∫®U (PIN)</h3>
      <input type="password" id="pinInput" class="pin-display" readonly placeholder="****">
      <div class="pin-pad">
        <button class="btn-pin" onclick="typePin(1)">1</button>
        <button class="btn-pin" onclick="typePin(2)">2</button>
        <button class="btn-pin" onclick="typePin(3)">3</button>
        <button class="btn-pin" onclick="typePin(4)">4</button>
        <button class="btn-pin" onclick="typePin(5)">5</button>
        <button class="btn-pin" onclick="typePin(6)">6</button>
        <button class="btn-pin" onclick="typePin(7)">7</button>
        <button class="btn-pin" onclick="typePin(8)">8</button>
        <button class="btn-pin" onclick="typePin(9)">9</button>
        <button class="btn-pin red" onclick="clearPin()">C</button>
        <button class="btn-pin" onclick="typePin(0)">0</button>
        <button class="btn-pin green" onclick="submitPin()">OK</button>
      </div>
      <button class="btn-ghost" style="width:100%;margin-top:15px;justify-content:center;color:#8e8e93" onclick="closePinModal()">H·ªßy b·ªè</button>
    </div>
  </div>

  <div class="card">
    <div class="nav-tabs">
      <div id="tab-home" class="nav-item active" onclick="switchTab('home')">TRANG CH·ª¶</div>
      <div id="tab-schedule" class="nav-item" onclick="openSchedule()">H·∫∏N GI·ªú</div>
      <!-- [UPDATE] Th√™m b·∫£o m·∫≠t cho tab settings -->
      <div id="tab-settings" class="nav-item" onclick="tryOpenSettings()">C√ÄI ƒê·∫∂T</div>
    </div>

    <div id="home" class="tab-content active">
      <div class="badges-row">
        <div id="statusBadge" class="status-badge status-off">SLEEPING (OFF)</div>
        <div id="mqttPill" class="pill mqtt-bad"><span class="dot"></span><span>MQTT</span></div>
        <div id="devPill" class="pill dev-bad"><span class="dot"></span><span>DEVICE</span></div>
      </div>
<h2>ESP32 TIMER PRO</h2>
      <div id="timerDisplay" class="timer-box">--:--</div>
      <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>

      <div class="simple-sensors" id="simpleSensors">
        <span id="statusDot" class="status-dot status-bad" title="MQTT / Telemetry"></span>
        <div><span id="ampsValue">--</span><span class="unit">A</span></div>
        <div><span id="tempValue">--</span><span class="unit">¬∞C</span></div>
      </div>



      <div class="settings-bar">
        <button type="button" id="btnLock" class="btn-ghost btn-lock-big locked" onclick="toggleLock()" title="M·ªü kh√≥a ƒë·ªÉ ch·ªânh / t·ª± kh√≥a sau 30s">
          <span id="lockBtnLabel">·∫§n v√†o ƒë√¢y ƒë·ªÉ ƒëi·ªÅu khi·ªÉn</span>
        </button>
      </div>

      <div id="settingsPanel" class="settings-panel">
<div style="text-align:left;font-size:11px;color:#8e8e93;font-weight:bold;margin-bottom:8px">C·∫§U H√åNH NHANH (PRESETS)</div>
      <div class="presets-container">
        <button class="btn-preset" onclick="applyPreset(5,10)"><span>T∆Ø·ªöI C√ÇY</span>5m T·∫Øt / 10s B·∫≠t</button>
        <button class="btn-preset" onclick="applyPreset(30,5)"><span>B∆†M N∆Ø·ªöC</span>30m T·∫Øt / 5s B·∫≠t</button>
        <button class="btn-preset" onclick="applyPreset(1,2)"><span>TEST NHANH</span>1m T·∫Øt / 2s B·∫≠t</button>
      </div>

      <div class="control-row">
        <div class="label-section">
          <div class="icon">üèÉ</div>
          <div><div>CH·∫†Y (On)</div><span class="sub-text">Th·ªùi gian b·∫≠t Relay</span></div>
        </div>
        <div class="stepper">
          <button type="button" class="btn-step" onclick="adjustValue('onSec',-1)">‚àí</button>
          <input type="number" id="onSec" value="" placeholder="--">
          <button type="button" class="btn-step" onclick="adjustValue('onSec',1)">+</button>
        </div>
      </div>

      <div class="control-row">
        <div class="label-section">
          <div class="icon">üí§</div>
          <div><div>NGH·ªà (Off)</div><span class="sub-text">Th·ªùi gian t·∫Øt Relay</span></div>
        </div>
        <div class="stepper">
          <button type="button" class="btn-step" onclick="adjustValue('offMin',-1)">‚àí</button>
          <input type="number" id="offMin" value="" placeholder="--">
          <button type="button" class="btn-step" onclick="adjustValue('offMin',1)">+</button>
        </div>
      </div>

      <button class="btn-primary" onclick="saveSettings()">L∆ØU TH·ªúI GIAN</button>
      
      <div class="maintenance-title">üîß Ch·∫ø ƒë·ªô b·∫£o tr√¨</div>
      <div class="maintenance-grid">
        <button class="btn-m" onclick="setMaint(1)">7 Ph√∫t</button>
        <button class="btn-m" onclick="setMaint(2)">15 Ph√∫t</button>
        <button class="btn-m" onclick="setMaint(3)">30 Ph√∫t</button>
        <button class="btn-m" onclick="setMaint(4)">50 Ph√∫t</button>
        <button class="btn-m" onclick="setMaint(5)">80 Ph√∫t</button>
        <button class="btn-m btn-manual" onclick="setMaint(6)">‚àû Th·ªß c√¥ng</button>
      </div>
      <button class="btn-cancel" onclick="setMaint(0)">H·ª¶Y B·∫¢O TR√å</button>
      
      </div>

    </div>

    <div id="schedule" class="tab-content">
      <h2>H·∫πn gi·ªù ngh·ªâ</h2>


      <div class="timeline-container">
        <div class="timeline-labels">
          <span>00:00</span><span>12:00</span><span>23:59</span>
        </div>
        <div id="timelineBar" class="timeline-bar"></div>
        <div id="timelineStatus" style="margin-top:6px;font-size:11px;color:#8e8e93;text-align:right">
          H√¥m nay kh√¥ng c√≥ l·ªãch ngh·ªâ n√†o k√≠ch ho·∫°t.
        </div>
      </div>


      <div class="card2">
        <div style="text-align:left;font-size:11px;color:#8e8e93;margin-bottom:8px">
          Thi·∫øt l·∫≠p c√°c kho·∫£ng th·ªùi gian motor s·∫Ω <b>t·∫°m ngh·ªâ</b> (M√†u ƒê·ªè).
        </div>

        <table class="tbl">
          <thead>
            <tr>
              <th>B·∫Øt ƒë·∫ßu</th>
              <th>K·∫øt th√∫c</th>
              <th style="text-align:center">B·∫≠t</th>
              <th style="text-align:center">X√≥a</th>
            </tr>
          </thead>
          <tbody id="pauseTbody"></tbody>
        </table>

        <div class="btn-row">
          <button class="btn-m" onclick="addPauseRow()">+ Th√™m m·ªëc</button>
          <button class="btn-save" onclick="savePause()">L∆∞u L·ªãch</button>
        </div>

        <div style="margin-top:8px;text-align:left;font-size:11px;color:#8e8e93">
          M·∫πo: h·ªó tr·ª£ kho·∫£ng qua ƒë√™m (vd 22:00‚Üí05:00).
        </div>
      </div>
    </div>

    <div id="settings" class="tab-content">
      <h2>C·∫•u h√¨nh H·ªá th·ªëng</h2>

      <div class="cfg-wrap">

        <!-- MQTT WebSocket (Browser Dashboard) -->
        <div class="cfg-card mqttws" id="cfgCard-mqttws">
          <div class="cfg-head" onclick="toggleCfgCard(this)">
            <div class="cfg-left">
              <span class="cfg-badge">MQTT</span>
              <span class="cfg-title">MQTT WebSocket (Dashboard)</span>
            </div>
            <div class="cfg-arrow">‚ñæ</div>
          </div>

          <div class="cfg-body">
            <div class="input-group">
              <label>Device ID (ƒë·ªÉ t·∫°o Topic)</label>
              <input type="text" id="cfg_devid" value="timer02">
            </div>

            <div class="input-group">
              <label>EMQX Host</label>
              <input type="text" id="cfg_emqx_host" value="n21f2dda.ala.dedicated.aws.emqxcloud.com">
            </div>

            <div class="input-group">
              <label>EMQX WebSocket Port</label>
              <input type="number" id="cfg_emqx_ws_port" value="8084">
            </div>

            <div class="input-group">
              <label>WebSocket Path</label>
              <input type="text" id="cfg_emqx_ws_path" value="/mqtt">
            </div>

            <div class="input-group">
              <label>Use TLS (wss)</label>
              <select id="cfg_emqx_wss">
                <option value="1" selected>B·∫≠t (wss://)</option>
                <option value="0">T·∫Øt (ws://)</option>
              </select>
            </div>

            <div class="input-group">
              <label>EMQX Username</label>
              <input type="text" id="cfg_emqx_user" value="anhtrung1">
            </div>

            <div class="input-group">
              <label>EMQX Password</label>
              <input type="password" id="cfg_emqx_pass" value="anhtrung1">
              <span class="toggle-eye" onclick="togglePass('cfg_emqx_pass')">üëÅÔ∏è</span>
            </div>

            <button class="btn-primary" onclick="saveUiSettings()">L∆ØU (TR√äN TR√åNH DUY·ªÜT)</button>

            <div style="margin-top:10px;display:flex;gap:8px">
              <button class="btn-m" style="flex:1;background:#007bff" onclick="mqttConnect()">K·∫æT N·ªêI</button>
              <button class="btn-m" style="flex:1" onclick="mqttDisconnect()">NG·∫ÆT</button>
            </div>

            <div class="log-box" id="topicBox" style="height:auto;margin-top:12px">
              <div class="log-entry"><b>Topic EMQX ƒëang d√πng:</b></div>
              <div class="log-entry" id="topicInfo">-</div>
            </div>

            <div class="log-box" id="logDisplay" style="margin-top:12px">
              <div class="log-entry">Log: ready.</div>
            </div>

            <div style="margin-top:10px;text-align:left;font-size:11px;color:#cfd2d8;opacity:.9">
              L∆∞u √Ω: GitHub Pages ch·ªâ ch·∫°y tr√™n browser n√™n <b>ph·∫£i d√πng MQTT qua WebSocket</b> (ws/wss). Port TCP 1883 kh√¥ng d√πng tr·ª±c ti·∫øp trong browser.
            </div>
          </div>
        </div>

        <!-- WiFi + Device -->
        <div class="cfg-card wifi" id="cfgCard-wifi">
          <div class="cfg-head" onclick="toggleCfgCard(this)">
            <div class="cfg-left">
              <span class="cfg-badge">ESP32</span>
              <span class="cfg-title">WiFi & Device</span>
            </div>
            <div class="cfg-arrow">‚ñæ</div>
          </div>

          <div class="cfg-body">
            <div class="input-group">
              <label>Device ID (ESP32 sau reboot)</label>
              <input type="text" id="cfg_sys_devid" value="timer02">
            </div>

            <div class="input-group">
              <label>WiFi SSID</label>
              <input type="text" id="cfg_wifi_ssid" value="Thanh Trung 123">
            </div>

            <div class="input-group">
              <label>WiFi Password</label>
              <input type="password" id="cfg_wifi_pass" value="anhtrung">
              <span class="toggle-eye" onclick="togglePass('cfg_wifi_pass')">üëÅÔ∏è</span>
            </div>

            <div class="cfg-note">* ƒê·ªïi WiFi / Device ID s·∫Ω khi·∫øn ESP32 reboot.</div>
          </div>
        </div>

        <!-- Blynk -->
        <div class="cfg-card blynk" id="cfgCard-blynk">
          <div class="cfg-head" onclick="toggleCfgCard(this)">
            <div class="cfg-left">
              <span class="cfg-badge">APP</span>
              <span class="cfg-title">Blynk</span>
            </div>
            <div class="cfg-arrow">‚ñæ</div>
          </div>

          <div class="cfg-body">
            <div class="input-group">
              <label>Tr·∫°ng th√°i Blynk</label>
              <select id="cfg_b_en">
                <option value="1" selected>B·∫≠t (Enable)</option>
                <option value="0">T·∫Øt (Disable)</option>
              </select>
            </div>

            <div class="input-group">
              <label>Blynk Server</label>
              <input type="text" id="cfg_b_host" value="blynk.hqn.vn">
            </div>

            <div class="input-group">
              <label>Blynk Port</label>
              <input type="number" id="cfg_b_port" value="8080">
            </div>

            <div class="input-group">
              <label>Blynk Token</label>
              <input type="password" id="cfg_b_token" value="gxShmU6_ZvZOKY2UZRew9PwkipWM_9uJ">
              <span class="toggle-eye" onclick="togglePass('cfg_b_token')">üëÅÔ∏è</span>
            </div>
          </div>
        </div>

        <!-- ThingsBoard -->
        <div class="cfg-card tb" id="cfgCard-tb">
          <div class="cfg-head" onclick="toggleCfgCard(this)">
            <div class="cfg-left">
              <span class="cfg-badge">IOT</span>
              <span class="cfg-title">ThingsBoard</span>
            </div>
            <div class="cfg-arrow">‚ñæ</div>
          </div>

          <div class="cfg-body">
            <div class="input-group">
              <label>Tr·∫°ng th√°i ThingsBoard</label>
              <select id="cfg_tb_en">
                <option value="1" selected>B·∫≠t (Enable)</option>
                <option value="0">T·∫Øt (Disable)</option>
              </select>
            </div>

            <div class="input-group">
              <label>ThingsBoard Server</label>
              <input type="text" id="cfg_tb_host" value="thingsboard.cloud">
            </div>

            <div class="input-group">
              <label>ThingsBoard Port</label>
              <input type="number" id="cfg_tb_port" value="1883">
            </div>

            <div class="input-group">
              <label>Device Token</label>
              <input type="password" id="cfg_tb_token" value="KtRAK5YlpIeoDvrqKg6p">
              <span class="toggle-eye" onclick="togglePass('cfg_tb_token')">üëÅÔ∏è</span>
            </div>
          </div>
        </div>

        <!-- Sensors -->
        <div class="cfg-card sensors" id="cfgCard-sensors">
          <div class="cfg-head" onclick="toggleCfgCard(this)">
            <div class="cfg-left">
              <span class="cfg-badge">HW</span>
              <span class="cfg-title">Sensors</span>
            </div>
            <div class="cfg-arrow">‚ñæ</div>
          </div>

          <div class="cfg-body">
            <div class="input-group">
              <label>SCT (C·∫£m bi·∫øn d√≤ng)</label>
              <select id="cfg_sct_en">
                <option value="1" selected>B·∫≠t</option>
                <option value="0">T·∫Øt</option>
              </select>
            </div>

            <div class="input-group">
              <label>DS18B20 (Nhi·ªát ƒë·ªô)</label>
              <select id="cfg_temp_en">
                <option value="1" selected>B·∫≠t</option>
                <option value="0">T·∫Øt</option>
              </select>
            </div>

            <div class="input-group">
              <label>Phao ch·ªëng tr√†n (Phao 1)</label>
              <select id="cfg_phao1_en">
                <option value="1" selected>B·∫≠t</option>
                <option value="0">T·∫Øt</option>
              </select>
            </div>

            <div class="cfg-note">* Thay ƒë·ªïi sensor s·∫Ω khi·∫øn ESP32 reboot.</div>
          </div>
        </div>

        <!-- EMQX (ESP32 TCP) -->
        <div class="cfg-card emqx-dev" id="cfgCard-emqx-dev">
          <div class="cfg-head" onclick="toggleCfgCard(this)">
            <div class="cfg-left">
              <span class="cfg-badge">MQTT</span>
              <span class="cfg-title">EMQX (ESP32 TCP)</span>
            </div>
            <div class="cfg-arrow">‚ñæ</div>
          </div>

          <div class="cfg-body">
            <div class="input-group">
              <label>Tr·∫°ng th√°i EMQX (ESP32)</label>
              <select id="cfg_dev_emqx_en">
                <option value="1" selected>B·∫≠t</option>
                <option value="0">T·∫Øt</option>
              </select>
            </div>

            <div class="input-group">
              <label>EMQX Host (TCP)</label>
              <input type="text" id="cfg_dev_emqx_host" value="n21f2dda.ala.dedicated.aws.emqxcloud.com">
            </div>

            <div class="input-group">
              <label>EMQX Port (TCP)</label>
              <input type="number" id="cfg_dev_emqx_port" value="1883">
            </div>

            <div class="input-group">
              <label>EMQX Username</label>
              <input type="text" id="cfg_dev_emqx_user" value="anhtrung1">
            </div>

            <div class="input-group">
              <label>EMQX Password</label>
              <input type="password" id="cfg_dev_emqx_pass" value="anhtrung1">
              <span class="toggle-eye" onclick="togglePass('cfg_dev_emqx_pass')">üëÅÔ∏è</span>
            </div>

            <div class="input-group">
              <label>Use TLS (ESP32)</label>
              <select id="cfg_dev_emqx_tls">
                <option value="1">B·∫≠t (TLS)</option>
                <option value="0" selected>T·∫Øt</option>
              </select>
            </div>

            <div style="margin-top:8px;display:flex;gap:8px">
              <button class="btn-m" style="flex:1" onclick="copyUiToDevEmqx()">COPY T·ª™ MQTT WEB</button>
            </div>

            <div class="cfg-note">* Thay ƒë·ªïi EMQX (ESP32) s·∫Ω khi·∫øn ESP32 reboot.</div>
          </div>
        </div>

        <button class="btn-primary" style="margin-top:10px;background:linear-gradient(90deg,#34c759,#0a84ff)" onclick="saveSysConfig()">G·ª¨I C·∫§U H√åNH XU·ªêNG ESP32 (RPC)</button>
        <div class="cfg-footnote">
          * S·∫Ω g·ªçi MQTT RPC method <b>setSysConfig</b> (theo code .ino) v√† ESP32 s·∫Ω reboot.
        </div>
      </div>
    </div>
  </div>

<script>
/* ========= STATE ========= */
let client = null;
let lastUserInteraction = 0;
let mqttConnState = 'disconnected';
let lastTelemetryTs = 0;
const STALE_MS = 10000; // 10s kh√¥ng c√≥ telemetry => coi nh∆∞ stale
const DEVICE_TIMEOUT_MS = 30000; // >30s kh√¥ng c√≥ telemetry => DEVICE LOST
let deviceOnline = false;
let deviceWatchdog = null;
let uiLocked = true;
let autoRelockTimer = null;
const AUTO_RELOCK_MS = 30000; // 30s t·ª± kh√≥a l·∫°i sau khi m·ªü kh√≥a

const state = {
  time_rem: "--:--", rem_s: null, off_min: null, on_sec: null,
  status: "SLEEPING", maint_mode: 0, pause_active: 0, relay_run: false, wait5s: false,
  pause_json: [],
  amps: null, temp: null
};

/* ========= [NEW] TOAST FUNCTION ========= */
function showToast(msg) {
  var x = document.getElementById("toast");
  x.innerText = msg;
  x.className = "show";
  setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
}



function setMqttPill(connected){
  const el = document.getElementById("mqttPill");
  if(!el) return;
  el.classList.toggle("mqtt-ok", !!connected);
  el.classList.toggle("mqtt-bad", !connected);
}
function setDevPill(connected){
  const el = document.getElementById("devPill");
  if(!el) return;
  el.classList.toggle("dev-ok", !!connected);
  el.classList.toggle("dev-bad", !connected);
}
function startDeviceWatchdog(){
  if(deviceWatchdog) clearInterval(deviceWatchdog);
  deviceWatchdog = setInterval(()=>{
    const mqttOk = (mqttConnState === "connected");
    const devOk = mqttOk && lastTelemetryTs && (Date.now() - lastTelemetryTs <= DEVICE_TIMEOUT_MS);
    deviceOnline = !!devOk;
    setMqttPill(mqttOk);
    setDevPill(deviceOnline);
  }, 1000);
}
function stopDeviceWatchdog(){
  if(deviceWatchdog) clearInterval(deviceWatchdog);
  deviceWatchdog = null;
  deviceOnline = false;
  setDevPill(false);
}

function updateStatusDot(){
  const dot = document.getElementById("statusDot");
  if(!dot) return;

  const now = Date.now();
  const stale = (!lastTelemetryTs) || (now - lastTelemetryTs > STALE_MS);

  dot.classList.remove("status-ok","status-warn","status-bad");

  if(mqttConnState === "connected"){
    dot.classList.add(stale ? "status-warn" : "status-ok");
  } else if(mqttConnState === "reconnecting"){
    dot.classList.add("status-warn");
  } else {
    dot.classList.add("status-bad");
  }
}

function setSettingsOpen(open){
  const panel = document.getElementById('settingsPanel');
  if(!panel) return;
  panel.classList.toggle('open', !!open);
}

function setControlsDisabled(disabled){
  const panel = document.getElementById("settingsPanel");
  if(!panel) return;

  // ch·ªâ kh√≥a trong panel, kh√¥ng ·∫£nh h∆∞·ªüng n√∫t toggle/lock
  panel.classList.toggle("is-locked", disabled);

  panel.querySelectorAll("button, input").forEach(el=>{
    el.disabled = disabled;
  });
}

function armAutoRelock(){
  try{ if(autoRelockTimer) clearTimeout(autoRelockTimer); }catch(e){}
  autoRelockTimer = setTimeout(()=>{
    uiLocked = true;
    setSettingsOpen(false);
    const btn = document.getElementById('btnLock');
    if(btn){ btn.classList.add('locked'); }
    setSettingsOpen(false);
    setControlsDisabled(true);
    showToast('T·ª± kh√≥a sau 30s');
  }, AUTO_RELOCK_MS);
}
function disarmAutoRelock(){
  try{ if(autoRelockTimer) clearTimeout(autoRelockTimer); }catch(e){}
  autoRelockTimer = null;
}

function toggleLock(){
  uiLocked = !uiLocked;
  const btn = document.getElementById('btnLock');
  if(btn) {
    btn.classList.toggle('locked', uiLocked);
  }
  // Khi m·ªü kh√≥a -> m·ªü r·ªông ph·∫ßn c√†i ƒë·∫∑t; Khi kh√≥a -> thu l·∫°i
  setSettingsOpen(!uiLocked);
  setControlsDisabled(uiLocked);
  if(uiLocked){
    disarmAutoRelock();
    showToast('ƒê√£ kh√≥a & thu c√†i ƒë·∫∑t');
  } else {
    showToast('ƒê√£ m·ªü kh√≥a (30s s·∫Ω t·ª± kh√≥a)');
    armAutoRelock();
  }
}



function toggleSettings(){
  const panel = document.getElementById("settingsPanel");
  const btn = document.getElementById("btnToggleSettings");
  if(!panel || !btn) return;

  const open = !panel.classList.contains("open");
  panel.classList.toggle("open", open);
  btn.classList.toggle("open", open);

  // Khi m·ªü panel m√† ƒëang locked th√¨ v·∫´n gi·ªØ tr·∫°ng th√°i lock
  if(uiLocked) setControlsDisabled(true);
}

function addLog(msg){
  const box = document.getElementById("logDisplay");
  if(!box) return;
  const t = new Date().toLocaleTimeString('vi-VN', {hour12:false});
  const div = document.createElement("div");
  div.className="log-entry";
  div.textContent = `[${t}] ${msg}`;
  box.prepend(div);
  while(box.children.length>80) box.removeChild(box.lastChild);
}

/* ========= UI tabs ========= */
function switchTab(t){
  document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
  document.getElementById(t).classList.add('active');
  document.getElementById('tab-'+t).classList.add('active');

  // [NEW] Khi m·ªü tab C√ÄI ƒê·∫∂T: m·∫∑c ƒë·ªãnh ƒë√≥ng h·∫øt c√°c card (accordion)
  if(t === 'settings'){
    closeAllCfgCards();
  }
}
function openSchedule(){
  switchTab('schedule');
  // Load l·∫°i b·∫£ng (d·ªØ li·ªáu ƒë√£ c√≥ s·∫µn trong state do Auto-Sync)
  renderPauseTable();
}

/* ========= Password toggle ========= */
function togglePass(id){
  const x = document.getElementById(id);
  x.type = (x.type === "password") ? "text" : "password";
}



/* ========= [NEW] Settings Accordion ========= */
function closeAllCfgCards(){
  document.querySelectorAll('#settings .cfg-card').forEach(c=>c.classList.remove('open'));
}
function toggleCfgCard(headEl){
  const card = headEl.closest('.cfg-card');
  if(!card) return;
  const isOpen = card.classList.contains('open');
  closeAllCfgCards();
  if(!isOpen) card.classList.add('open');
}

/* ========= [NEW] ESP32 SysConfig (RPC setSysConfig) ========= */
function copyUiToDevEmqx(){
  try{
    const ui = getCfg();
    const h = document.getElementById('cfg_dev_emqx_host');
    const u = document.getElementById('cfg_dev_emqx_user');
    const p = document.getElementById('cfg_dev_emqx_pass');
    if(h && ui.host) h.value = ui.host;
    if(u && ui.user) u.value = ui.user;
    if(p && ui.pass) p.value = ui.pass;
    showToast('ƒê√£ copy EMQX t·ª´ MQTT Web');
  }catch(e){}
}

function getSysCfgFromForm(){
  const v = (id, d='') => (document.getElementById(id)?.value ?? d);
  const num = (x, d=0) => {
    const n = parseInt(String(x), 10);
    return Number.isFinite(n) ? n : d;
  };
  return {
    ssid: String(v('cfg_wifi_ssid')).trim(),
    pass: String(v('cfg_wifi_pass')),
    devid: String(v('cfg_sys_devid')).trim(),

    b_en: num(v('cfg_b_en','1'), 1),
    b_host: String(v('cfg_b_host')).trim(),
    b_port: num(v('cfg_b_port','8080'), 8080),
    b_token: String(v('cfg_b_token')),

    tb_en: num(v('cfg_tb_en','1'), 1),
    tb_host: String(v('cfg_tb_host')).trim(),
    tb_port: num(v('cfg_tb_port','1883'), 1883),
    tb_token: String(v('cfg_tb_token')),

    sct_en: num(v('cfg_sct_en','1'), 1),
    temp_en: num(v('cfg_temp_en','1'), 1),
    phao1_en: num(v('cfg_phao1_en','1'), 1),

    emqx_en: num(v('cfg_dev_emqx_en','1'), 1),
    emqx_host: String(v('cfg_dev_emqx_host')).trim(),
    emqx_port: num(v('cfg_dev_emqx_port','1883'), 1883),
    emqx_user: String(v('cfg_dev_emqx_user')).trim(),
    emqx_pass: String(v('cfg_dev_emqx_pass')),
    emqx_tls: num(v('cfg_dev_emqx_tls','0'), 0)
  };
}

function saveSysConfig(){
  const cfg = getSysCfgFromForm();
  localStorage.setItem('esp_sys_cfg', JSON.stringify(cfg));

  if(!client || !client.connected){
    showToast('Ch∆∞a k·∫øt n·ªëi MQTT ƒë·ªÉ g·ª≠i SysConfig!');
    return;
  }
  rpcCall('setSysConfig', cfg);
  showToast('ƒê√£ g·ª≠i SysConfig - ESP32 s·∫Ω reboot!');
}

function loadSysConfig(){
  // defaults from .ino
  const defaults = {
    ssid: "Thanh Trung 123",
    pass: "anhtrung",
    devid: "timer02",
    b_en: 1,
    b_host: "blynk.hqn.vn",
    b_port: 8080,
    b_token: "gxShmU6_ZvZOKY2UZRew9PwkipWM_9uJ",
    tb_en: 1,
    tb_host: "thingsboard.cloud",
    tb_port: 1883,
    tb_token: "KtRAK5YlpIeoDvrqKg6p",
    sct_en: 1,
    temp_en: 1,
    phao1_en: 1,
    emqx_en: 1,
    emqx_host: "n21f2dda.ala.dedicated.aws.emqxcloud.com",
    emqx_port: 1883,
    emqx_user: "anhtrung1",
    emqx_pass: "anhtrung1",
    emqx_tls: 0
  };

  let c = null;
  try{
    const raw = localStorage.getItem('esp_sys_cfg');
    c = raw ? JSON.parse(raw) : null;
  }catch(e){ c = null; }

  const ui = (()=>{ try{return getCfg();}catch(e){return null;} })();
  const seed = Object.assign({}, defaults);

  // If UI cfg exists, mirror host/user/pass to ease setup
  if(ui){
    if(ui.devid) seed.devid = ui.devid;
    if(ui.host) seed.emqx_host = ui.host;
    if(ui.user) seed.emqx_user = ui.user;
    if(ui.pass) seed.emqx_pass = ui.pass;
  }

  c = Object.assign(seed, (c||{}));

  const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = String(val ?? ''); };
  setVal('cfg_wifi_ssid', c.ssid);
  setVal('cfg_wifi_pass', c.pass);
  setVal('cfg_sys_devid', c.devid);

  setVal('cfg_b_en', c.b_en);
  setVal('cfg_b_host', c.b_host);
  setVal('cfg_b_port', c.b_port);
  setVal('cfg_b_token', c.b_token);

  setVal('cfg_tb_en', c.tb_en);
  setVal('cfg_tb_host', c.tb_host);
  setVal('cfg_tb_port', c.tb_port);
  setVal('cfg_tb_token', c.tb_token);

  setVal('cfg_sct_en', c.sct_en);
  setVal('cfg_temp_en', c.temp_en);
  setVal('cfg_phao1_en', c.phao1_en);

  setVal('cfg_dev_emqx_en', c.emqx_en);
  setVal('cfg_dev_emqx_host', c.emqx_host);
  setVal('cfg_dev_emqx_port', c.emqx_port);
  setVal('cfg_dev_emqx_user', c.emqx_user);
  setVal('cfg_dev_emqx_pass', c.emqx_pass);
  setVal('cfg_dev_emqx_tls', c.emqx_tls);

  // Keep sys devid auto-follow UI devid until user edits sys devid manually
  const uiId = document.getElementById('cfg_devid');
  const sysId = document.getElementById('cfg_sys_devid');
  if(uiId && sysId){
    if(!sysId.dataset.touched){
      sysId.value = String(c.devid || uiId.value || '');
    }
    uiId.addEventListener('change', ()=>{
      if(sysId.dataset.touched === '1') return;
      sysId.value = uiId.value;
    });
    sysId.addEventListener('input', ()=>{ sysId.dataset.touched = '1'; });
  }
}

/* ========= Settings persistence ========= */
function getCfg(){
  return {
    devid: (document.getElementById('cfg_devid').value || "timer02").trim(),
    host: (document.getElementById('cfg_emqx_host').value || "").trim(),
    wsPort: parseInt(document.getElementById('cfg_emqx_ws_port').value || "8084", 10),
    wsPath: (document.getElementById('cfg_emqx_ws_path').value || "/mqtt").trim(),
    wss: (document.getElementById('cfg_emqx_wss').value || "1") === "1",
    user: (document.getElementById('cfg_emqx_user').value || "").trim(),
    pass: (document.getElementById('cfg_emqx_pass').value || "")
  };
}
function saveUiSettings(){
  localStorage.setItem("emqx_ui_cfg", JSON.stringify(getCfg()));
  showToast("ƒê√£ l∆∞u c·∫•u h√¨nh!"); // Thay alert
  updateTopicInfo();
}
function loadUiSettings(){
  try{
    const raw = localStorage.getItem("emqx_ui_cfg");
    if(!raw) return;
    const cfg = JSON.parse(raw);
    if(cfg.devid) document.getElementById('cfg_devid').value = cfg.devid;
    if(cfg.host) document.getElementById('cfg_emqx_host').value = cfg.host;
    if(cfg.wsPort) document.getElementById('cfg_emqx_ws_port').value = cfg.wsPort;
    if(cfg.wsPath) document.getElementById('cfg_emqx_ws_path').value = cfg.wsPath;
    document.getElementById('cfg_emqx_wss').value = cfg.wss ? "1" : "0";
    if(cfg.user) document.getElementById('cfg_emqx_user').value = cfg.user;
    if(cfg.pass !== undefined) document.getElementById('cfg_emqx_pass').value = cfg.pass;
  }catch(e){}
}

/* ========= Topics ========= */
function baseTopic(){ return "devices/" + getCfg().devid; }
function topicTelemetry(){ return baseTopic() + "/telemetry"; }
function topicRpcReqPlus(){ return baseTopic() + "/rpc/request/+"; }
function topicRpcRespPlus(){ return baseTopic() + "/rpc/response/+"; }

function updateTopicInfo(){
  const info = [`PUB Telemetry: ${topicTelemetry()}`, `PUB RPC: ${baseTopic() + "/rpc/response/{reqId}"}`].join(" | ");
  document.getElementById("topicInfo").innerHTML = info;
}

/* ========= [NEW] VISUAL TIMELINE LOGIC ========= */
// Chuy·ªÉn "HH:MM" -> ph√∫t trong ng√†y (0-1439)
function hm2min(s) {
    if(!s) return 0;
    const p = s.split(':');
    return parseInt(p[0])*60 + parseInt(p[1]);
}

function renderTimeline() {
    const bar = document.getElementById("timelineBar");
    const stt = document.getElementById("timelineStatus");
    if(!bar) return;
    bar.innerHTML = "";

    // 1. T·∫°o m·∫£ng 1440 ph√∫t (0 = Ch·∫°y/Xanh, 1 = Ngh·ªâ/ƒê·ªè)
    let dayMap = new Array(1440).fill(0);
    const ranges = state.pause_json || [];
    
    // N·∫øu kh√¥ng c√≥ l·ªãch n√†o -> Full xanh
    if(ranges.length === 0) {
        bar.innerHTML = '<div class="t-seg t-run" style="width:100%"></div>';
        stt.innerText = "L·ªãch tr√¨nh: Ch·∫°y c·∫£ ng√†y (Kh√¥ng ngh·ªâ)";
        return;
    }

    // L·∫•y th·ª© hi·ªán t·∫°i (0=CN, 1=T2...)
    const todayBit = 1 << new Date().getDay();

    ranges.forEach(r => {
        // Ch·ªâ v·∫Ω n·∫øu Enabled (on=1) V√Ä ƒë√∫ng ng√†y h√¥m nay
        const w = (r.w === undefined) ? 127 : r.w;
        if (r.on && (w & todayBit)) {
            let s = hm2min(r.s);
            let e = hm2min(r.e);
            if (s < e) {
                for(let i=s; i<e; i++) dayMap[i] = 1; 
            } else {
                // Qua ƒë√™m (22:00 -> 05:00)
                for(let i=s; i<1440; i++) dayMap[i] = 1;
                for(let i=0; i<e; i++) dayMap[i] = 1;
            }
        }
    });

    // 2. G·ªôp c√°c ƒëo·∫°n li√™n ti·∫øp ƒë·ªÉ v·∫Ω HTML
    let html = "";
    let currentVal = dayMap[0]; // 0 or 1
    let count = 0;

    for(let i=0; i<1440; i++) {
        if(dayMap[i] === currentVal) {
            count++;
        } else {
            // ƒê·ªïi tr·∫°ng th√°i -> ch·ªët ƒëo·∫°n c≈©
            let percent = (count / 14.4).toFixed(2); // 1440p = 100%
            let cls = currentVal === 1 ? "t-off" : "t-run";
            html += `<div class="t-seg ${cls}" style="width:${percent}%"></div>`;
            
            // Reset
            currentVal = dayMap[i];
            count = 1;
        }
    }
    // ƒêo·∫°n cu·ªëi c√πng
    let percent = (count / 14.4).toFixed(2);
    let cls = currentVal === 1 ? "t-off" : "t-run";
    html += `<div class="t-seg ${cls}" style="width:${percent}%"></div>`;

    bar.innerHTML = html;
    
    // Update text
    let activeCnt = ranges.filter(r => r.on && ((r.w===undefined?127:r.w) & todayBit)).length;
    if(activeCnt > 0) stt.innerText = `H√¥m nay: ${activeCnt} kho·∫£ng ngh·ªâ (ƒê·ªè)`;
    else stt.innerText = "H√¥m nay kh√¥ng c√≥ l·ªãch ngh·ªâ n√†o k√≠ch ho·∫°t.";
}

/* ========= MQTT Connect ========= */
function mqttConnect(){
  const cfg = getCfg();
  if(!cfg.host){ alert("Thi·∫øu EMQX Host"); return; }

  const proto = cfg.wss ? "wss" : "ws";
  const url = `${proto}://${cfg.host}:${cfg.wsPort}${cfg.wsPath.startsWith('/')?cfg.wsPath:'/'+cfg.wsPath}`;

  if(client){ try{ client.end(true); }catch(e){} client = null; }

  addLog("Connecting: " + url);
  client = mqtt.connect(url, {
    username: cfg.user || undefined,
    password: cfg.pass || undefined,
    clientId: cfg.devid + "_web_" + Math.random().toString(16).slice(2,8),
    clean: true, keepalive: 60, reconnectPeriod: 2000
  });

  client.on("connect", () => {
    mqttConnState = "connected";
    setMqttPill(true);
    startDeviceWatchdog();
    updateStatusDot();
    addLog("MQTT Connected!");
    showToast("ƒê√£ k·∫øt n·ªëi Server!", "show"); // Toast b√°o k·∫øt n·ªëi
    updateTopicInfo();

    client.subscribe([topicTelemetry(), topicRpcRespPlus()], (err) => {
      if(err) addLog("SUB error: " + err.message);
      else {
        addLog("Subscribed. Requesting Sync...");
        // Auto Sync
        rpcCall("setOffMin", {}); 
        rpcCall("setOnSec", {});
        rpcCall("getPauseJson", {}); 
      }
    });
  });

  client.on("reconnect", () => {
    mqttConnState = "reconnecting";
    updateStatusDot();
    });
  client.on("close", () => {
    mqttConnState = "disconnected";
    updateStatusDot();
    });
  client.on("error", (e) => addLog("MQTT Err: " + e.message));

  client.on("message", (topic, payload) => {
    const txt = payload.toString();

    // 1. Telemetry
    if(topic === topicTelemetry()){
      try{
        const obj = JSON.parse(txt);
        // Sync
        if(obj.time_rem !== undefined) state.time_rem = obj.time_rem;
        if(obj.rem_s !== undefined) state.rem_s = obj.rem_s;
        if(obj.on_sec !== undefined) state.on_sec = obj.on_sec;
        if(obj.off_min !== undefined) state.off_min = obj.off_min;
        if(obj.status !== undefined) state.status = obj.status;
        if(obj.maint_mode !== undefined) state.maint_mode = obj.maint_mode;
        if(obj.pause_active !== undefined) state.pause_active = obj.pause_active;
        if(obj.relay_run !== undefined) state.relay_run = obj.relay_run;
        if(obj.amps !== undefined) state.amps = obj.amps;
        if(obj.temp !== undefined) state.temp = obj.temp;

        // SYNC L·ªäCH TR√åNH
        if(obj.pause_json !== undefined) {
           let raw = obj.pause_json;
           if (typeof raw === 'string') { try { raw = JSON.parse(raw); } catch(e){} }
           if(Array.isArray(raw)) state.pause_json = raw; else state.pause_json = [];
           
           // [M·ªöI] V·∫Ω l·∫°i Timeline ngay khi c√≥ d·ªØ li·ªáu l·ªãch
           renderTimeline();

           // N·∫øu ƒëang m·ªü tab Schedule th√¨ v·∫Ω l·∫°i b·∫£ng
           if(document.getElementById('schedule').classList.contains('active')) renderPauseTable();
        }
        lastTelemetryTs = Date.now();
        deviceOnline = true;
        setDevPill(true);
        updateStatusDot();
        renderHome();
      }catch(e){}
    }
    // 2. RPC Response
    else if(topic.startsWith(baseTopic()+"/rpc/response/")){
      try{
        const r = JSON.parse(txt);
        if(r.off_min !== undefined) document.getElementById("offMin").value = r.off_min;
        if(r.on_sec !== undefined) document.getElementById("onSec").value = r.on_sec;
        if(r.ok) showToast("L·ªánh th√†nh c√¥ng!"); // Toast ph·∫£n h·ªìi RPC
      }catch(e){}
    }
  });
}

function mqttDisconnect(){
  if(client){ try{ client.end(true); }catch(e){} client = null; }
  addLog("MQTT disconnected");
}

/* ========= RPC ========= */
function mqttPublish(topic, msgObj){
  if(!client || !client.connected){ alert("M·∫•t k·∫øt n·ªëi MQTT!"); return false; }
  client.publish(topic, JSON.stringify(msgObj), {qos:0, retain:false});
  return true;
}
function rpcCall(method, params){
  const reqId = Date.now().toString();
  const t = baseTopic() + "/rpc/request/" + reqId;
  const ok = mqttPublish(t, { method, params });
  return reqId;
}

/* ========= ACTIONS ========= */
function adjustValue(id,d){
  if(uiLocked){ showToast('ƒêang kh√≥a thao t√°c'); return; }

  const i=document.getElementById(id); let c=parseInt(i.value)||0; let n=c+d;
  if(n<0) n=0; if(id==='onSec' && n<1) n=1; i.value=n;
  lastUserInteraction=Date.now();
}
document.getElementById('offMin').addEventListener('input',()=>lastUserInteraction=Date.now());
document.getElementById('onSec').addEventListener('input',()=>lastUserInteraction=Date.now());

function applyPreset(m,s){
  if(uiLocked){ showToast('ƒêang kh√≥a thao t√°c'); return; }

  document.getElementById('offMin').value = m; document.getElementById('onSec').value = s;
  saveSettings(); lastUserInteraction = Date.now() + 2000;
}
function saveSettings(){
  if(uiLocked){ showToast('ƒêang kh√≥a thao t√°c'); return; }

  const m = parseInt(document.getElementById("offMin").value||"0",10);
  const s = parseInt(document.getElementById("onSec").value||"0",10);
  rpcCall("setOffMin", m); rpcCall("setOnSec", s); rpcCall("save", 1);
  showToast("ƒê√£ g·ª≠i c√†i ƒë·∫∑t...", "show"); // Toast
  lastUserInteraction=0;
}
function setMaint(mode){
  if(uiLocked){ showToast('ƒêang kh√≥a thao t√°c'); return; }
 
    rpcCall("setMaintenance", mode);
    showToast("G·ª≠i l·ªánh b·∫£o tr√¨...", "show"); // Toast
}

/* ========= RENDER HOME ========= */
function renderHome(){
  document.getElementById("timerDisplay").textContent = (state.time_rem && state.time_rem.length>0) ? state.time_rem : "--:--";
  const b = document.getElementById("statusBadge");
  const pb = document.getElementById("progressBar");
  const timerBox = document.getElementById("timerDisplay");

  let ac="#28a745", ag="rgba(40,167,69,0.55)";
  const pause = (Number(state.pause_active)||0)>0;
  const maint = Number(state.maint_mode)||0;
  const relay = !!state.relay_run;
  const wait5s = (String(state.status).toUpperCase().includes("WAIT") || String(state.status).toUpperCase().includes("CHO RESET"));

  if(pause){
    b.innerHTML="‚è∏ ƒêANG NGH·ªà"; b.className="status-badge status-off";
    pb.style.width="100%"; pb.style.backgroundColor="#6c757d"; ac="#6c757d"; ag="rgba(108,117,125,0.55)";
  } else if(maint>0){
    b.innerHTML="üîß ƒêANG B·∫¢O TR√å"; b.className="status-badge status-maint";
    pb.style.width="100%"; pb.style.backgroundColor="#dc3545"; ac="#dc3545"; ag="rgba(220,53,69,0.55)";
  } else if(relay){
    b.innerHTML="RUNNING (ON)"; b.className="status-badge status-on"; pb.style.backgroundColor="#28a745";
    const t=Number(state.on_sec)||0, c=Number(state.rem_s)||0;
    if(t>0 && c>=0) pb.style.width=(c/t*100)+"%";
  } else if(wait5s){
    b.innerHTML="WAITING RESET."; b.className="status-badge status-wait";
    pb.style.backgroundColor="#ffc107"; ac="#ffc107"; ag="rgba(255,193,7,0.55)"; pb.style.width="100%";
  } else {
    b.innerHTML="SLEEPING (OFF)"; b.className="status-badge status-off"; pb.style.backgroundColor="#6c757d";
    ac="#6c757d"; ag="rgba(108,117,125,0.55)";
    const t=(Number(state.off_min)||0)*60, c=Number(state.rem_s)||0;
    if(t>0 && c>=0) pb.style.width=(c/t*100)+"%";
  }
  timerBox.style.setProperty("--accent", ac);
  timerBox.style.setProperty("--accentGlow", ag);
  timerBox.style.boxShadow = "0 0 0 1px rgba(255,255,255,0.1), 0 0 28px " + ag;

  // [M·ªöI] Sensor UI (amps / temp) + stale detect
  const sensorsBox = document.getElementById("simpleSensors");
  const stale = (!lastTelemetryTs) || (Date.now() - lastTelemetryTs > STALE_MS);

  if(sensorsBox) sensorsBox.classList.toggle("stale", stale);

  const aEl = document.getElementById("ampsValue");
  if(aEl){
    const v = parseFloat(state.amps);
    aEl.textContent = (!stale && Number.isFinite(v)) ? v.toFixed(2) : "--";
  }
  const tEl = document.getElementById("tempValue");
  if(tEl){
    const v = parseFloat(state.temp);
    tEl.textContent = (!stale && Number.isFinite(v)) ? v.toFixed(2) : "--";
  }
  updateStatusDot();


  if(Date.now()-lastUserInteraction>5000){
    if(state.off_min!==null) document.getElementById("offMin").value=state.off_min;
    if(state.on_sec!==null) document.getElementById("onSec").value=state.on_sec;
  }
}

/* ========= SCHEDULE TABLE ========= */
function renderPauseTable(){
  const tb=document.getElementById('pauseTbody');
  if(!tb) return;
  tb.innerHTML="";
  let arr = state.pause_json;
  if(!Array.isArray(arr)) arr=[];

  if(arr.length===0){
    tb.innerHTML='<tr><td colspan="4" style="color:#8e8e93;padding:15px">Ch∆∞a c√≥ m·ªëc. B·∫•m <b>+ Th√™m m·ªëc</b></td></tr>';
    return;
  }
  const labels=["CN","T2","T3","T4","T5","T6","T7"];
  arr.forEach((r, idx)=>{
    const s=(r.s||"12:00"), e=(r.e||"13:00"), on=(r.on==1), w=(r.w===undefined?127:r.w);
    let daysHtml = '<div class="day-selector">';
    for(let i=1;i<=7;i++){
      const b=(i==7?0:i), act=(w&(1<<b));
      daysHtml += `<div class="day-btn ${act?'active':''}" onclick="toggleDay(${idx},${b},this)">${labels[b]}</div>`;
    }
    daysHtml += '</div>';

    const tr1=document.createElement('tr');
    tr1.innerHTML =
      `<td><input type="time" value="${s}" onchange="updP(${idx},'s',this.value)"></td>`+
      `<td><input type="time" value="${e}" onchange="updP(${idx},'e',this.value)"></td>`+
      `<td style="text-align:center"><label class="switch"><input type="checkbox" ${on?'checked':''} onchange="updP(${idx},'on',this.checked?1:0)"><span class="slider"></span></label></td>`+
      `<td style="text-align:center"><button class="btn-del" onclick="delP(${idx})">X</button></td>`;
    tb.appendChild(tr1);
    const tr2=document.createElement('tr');
    tr2.innerHTML = `<td colspan="4" style="border:none;padding-top:2px;padding-bottom:10px">${daysHtml}</td>`;
    tb.appendChild(tr2);
  });
}
function updP(idx,k,v){
  if(!state.pause_json[idx]) state.pause_json[idx]={s:"12:00",e:"13:00",on:1,w:127};
  state.pause_json[idx][k]=v;
  // Render l·∫°i timeline lu√¥n ƒë·ªÉ user th·∫•y thay ƒë·ªïi (preview)
  renderTimeline();
}
function toggleDay(idx,b,el){
  if(!state.pause_json[idx]) return;
  let w = state.pause_json[idx].w===undefined?127:state.pause_json[idx].w;
  const m = 1<<b;
  if(w&m){ w &= ~m; el.classList.remove('active'); }
  else { w |= m; el.classList.add('active'); }
  state.pause_json[idx].w = w;
  renderTimeline();
}
function addPauseRow(){
  if(!Array.isArray(state.pause_json)) state.pause_json=[];
  state.pause_json.push({s:"11:00",e:"05:00",on:1,w:127});
  renderPauseTable();
  renderTimeline();
}
function delP(idx){
  state.pause_json.splice(idx,1);
  renderPauseTable();
  renderTimeline();
}
function savePause(){
  const pl = state.pause_json||[];
  if(JSON.stringify(pl).length>2000){ showToast("Data qu√° d√†i!"); return; } // Toast error
  rpcCall("setPauseJson", pl);
  showToast("ƒê√£ g·ª≠i l·ªãch ngh·ªâ!"); // Toast success
}

/* ========= [NEW] PIN LOGIC ========= */
let enteredPin = "";
const CORRECT_PIN = "8888"; // M·∫∑c ƒë·ªãnh pass 8888
let isSettingsAuth = false;

function tryOpenSettings(){
  if(isSettingsAuth){
    switchTab('settings');
  } else {
    // Show modal
    document.getElementById('pinModal').classList.add('show');
    clearPin();
  }
}

function closePinModal(){
  document.getElementById('pinModal').classList.remove('show');
  enteredPin = "";
}

function typePin(n){
  if(enteredPin.length < 6) {
    enteredPin += n;
    updatePinDisplay();
  }
}

function clearPin(){
  enteredPin = "";
  updatePinDisplay();
}

function updatePinDisplay(){
  const el = document.getElementById('pinInput');
  el.value = enteredPin ? "*".repeat(enteredPin.length) : "";
}

function submitPin(){
  if(enteredPin === CORRECT_PIN){
    isSettingsAuth = true;
    closePinModal();
    switchTab('settings');
    showToast("ƒê√£ m·ªü kh√≥a c√†i ƒë·∫∑t");
  } else {
    showToast("Sai m·∫≠t kh·∫©u!");
    clearPin();
  }
}

/* ========= BOOT ========= */
loadUiSettings();
loadSysConfig();
updateTopicInfo();
renderHome();
setTimeout(mqttConnect, 350);
  // [M·ªöI] default: ·∫©n ph·∫ßn c√†i ƒë·∫∑t ƒë·ªÉ m√†n h√¨nh g·ªçn
  // (m·ªü b·∫±ng n√∫t ‚öôÔ∏è C√ÄI ƒê·∫∂T)
  // lock m·∫∑c ƒë·ªãnh: OFF
  (function(){
    const panel = document.getElementById('settingsPanel');
    if(panel) panel.classList.remove('open');
    const btn = document.getElementById('btnLock');
    if(btn){ btn.classList.add('locked'); }
    setControlsDisabled(true);
    setMqttPill(false);
    setDevPill(false);
    startDeviceWatchdog();
    updateStatusDot();
  })();
</script>
</body>
</html>
