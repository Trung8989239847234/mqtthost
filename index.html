<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT Control - 0907888149</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #fff; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 400px; background: #1c1c1e; padding: 20px; border-radius: 20px; box-shadow: 0 4px 30px rgba(0,0,0,0.5); border: 1px solid #333; }
        h2 { text-align: center; color: #0a84ff; margin-top: 0; }
        .status-box { background: #000; color: #00ff00; font-family: monospace; font-size: 40px; text-align: center; padding: 20px; border: 1px solid #333; border-radius: 10px; margin: 15px 0; font-weight: bold; }
        .badge { display: inline-block; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
        .bg-conn { background: #dc3545; color: white; } /* Disconnected red */
        .bg-conn.active { background: #28a745; } /* Connected green */
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 12px; color: #aaa; margin-bottom: 5px; }
        input { width: 100%; padding: 10px; background: #2c2c2e; border: 1px solid #3a3a3c; color: white; border-radius: 8px; box-sizing: border-box; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-primary { background: #0a84ff; color: white; }
        .btn-primary:active { transform: scale(0.98); opacity: 0.8; }
        .btn-connect { background: #333; color: #aaa; border: 1px solid #555; }
        
        .row { display: flex; gap: 10px; margin-top: 10px; }
        .col { flex: 1; }
        
        .hidden-config { display: none; margin-top: 15px; border-top: 1px solid #333; padding-top: 15px; }
        .toggle-cfg { text-align: center; font-size: 11px; color: #555; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div style="text-align:center">
        <span id="connBadge" class="badge bg-conn">Mất kết nối MQTT</span>
        <h2>Điều Khiển Timer</h2>
    </div>

    <div id="displayTimer" class="status-box">--:--</div>
    <div style="text-align:center; font-size:14px; color:#aaa" id="statusText">Đang chờ dữ liệu...</div>

    <div class="row">
        <div class="col">
            <div class="input-group">
                <label>Thời gian Nghỉ (Phút)</label>
                <input type="number" id="inpMin" value="1">
            </div>
        </div>
        <div class="col">
            <div class="input-group">
                <label>Thời gian Chạy (Giây)</label>
                <input type="number" id="inpSec" value="5">
            </div>
        </div>
    </div>

    <button class="btn btn-primary" onclick="sendSave()">CẬP NHẬT CẤU HÌNH</button>

    <hr style="border-color:#333; margin: 20px 0;">
    
    <div class="input-group">
        <label>Chọn chế độ bảo trì</label>
        <div class="row" style="margin-top:0">
            <button class="btn" style="background:#2c2c2e; color:#fff; font-size:12px" onclick="sendMaint(1)">7p</button>
            <button class="btn" style="background:#2c2c2e; color:#fff; font-size:12px" onclick="sendMaint(3)">30p</button>
            <button class="btn" style="background:#2c2c2e; color:#fff; font-size:12px" onclick="sendMaint(0); sendSave()">Hủy</button>
        </div>
    </div>

    <div class="toggle-cfg" onclick="toggleConfig()">▼ Cài đặt MQTT (Nhấn để mở)</div>
    
    <div id="configArea" class="hidden-config">
        <div class="input-group"><label>MQTT Host</label><input type="text" id="mqttHost" value="n21f2dda.ala.dedicated.aws.emqxcloud.com"></div>
        <div class="input-group"><label>MQTT Port (WSS/SSL)</label><input type="number" id="mqttPort" value="8084"></div>
        <div class="input-group"><label>Username</label><input type="text" id="mqttUser" value="anhtrung1"></div>
        <div class="input-group"><label>Password</label><input type="password" id="mqttPass" value="anhtrung1"></div>
        <div class="row">
            <div class="col"><div class="input-group"><label>SĐT Khách</label><input type="text" id="cfgPhone" value="0907888149"></div></div>
            <div class="col"><div class="input-group"><label>Device ID</label><input type="text" id="cfgDevId" value="timer02"></div></div>
        </div>
        <button class="btn btn-connect" onclick="doConnect()">Kết nối lại MQTT</button>
    </div>
</div>

<script>
    // Biến toàn cục MQTT
    var client;
    var isConnected = false;

    // Hàm khởi tạo và kết nối
    function doConnect() {
        var host = document.getElementById("mqttHost").value;
        var port = Number(document.getElementById("mqttPort").value);
        var user = document.getElementById("mqttUser").value;
        var pass = document.getElementById("mqttPass").value;
        var clientId = "web_" + parseInt(Math.random() * 100000, 10);

        console.log("Connecting to " + host + ":" + port);
        
        // Ngắt kết nối cũ nếu có
        if(isConnected) {
            try { client.disconnect(); } catch(e){}
        }

        client = new Paho.MQTT.Client(host, port, clientId);

        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        var options = {
            useSSL: true, // Server EMQX Cloud thường bắt buộc SSL trên port 8084
            userName: user,
            password: pass,
            onSuccess: onConnect,
            onFailure: onFailure,
            keepAliveInterval: 30
        };
        
        document.getElementById("connBadge").innerText = "Đang kết nối...";
        client.connect(options);
    }

    function onConnect() {
        console.log("MQTT Connected");
        isConnected = true;
        var badge = document.getElementById("connBadge");
        badge.innerText = "Đã kết nối";
        badge.classList.add("active");

        // Subscribe vào Topic Status của thiết bị
        // Cấu trúc: khachhang/[SDT]/[DEVID]/status
        var phone = document.getElementById("cfgPhone").value;
        var devId = document.getElementById("cfgDevId").value;
        var topic = "khachhang/" + phone + "/" + devId + "/status";
        
        console.log("Subscribing to: " + topic);
        client.subscribe(topic);
    }

    function onFailure(message) {
        console.log("Connection failed: " + message.errorMessage);
        var badge = document.getElementById("connBadge");
        badge.innerText = "Lỗi kết nối!";
        badge.classList.remove("active");
        isConnected = false;
        alert("Không thể kết nối Server MQTT. Kiểm tra lại Port (8083 hoặc 8084)!");
    }

    function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
            console.log("Connection lost: " + responseObject.errorMessage);
            var badge = document.getElementById("connBadge");
            badge.innerText = "Mất kết nối";
            badge.classList.remove("active");
            isConnected = false;
        }
    }

    // Xử lý tin nhắn nhận được từ ESP32
    function onMessageArrived(message) {
        // Topic nhận được: khachhang/0907888149/timer02/status
        // Payload: {"status":"RUNNING","time_rem":"01:20","maint":0,"set_min":1,"set_sec":5}
        try {
            console.log("Msg: " + message.payloadString);
            var data = JSON.parse(message.payloadString);

            // Cập nhật giao diện
            document.getElementById("displayTimer").innerText = data.time_rem;
            document.getElementById("statusText").innerText = "Trạng thái: " + data.status;

            // Nếu người dùng không đang nhập liệu thì cập nhật ô input cho đồng bộ
            if(document.activeElement.id !== "inpMin") document.getElementById("inpMin").value = data.set_min;
            if(document.activeElement.id !== "inpSec") document.getElementById("inpSec").value = data.set_sec;

            // Đổi màu status box
            var box = document.getElementById("displayTimer");
            if(data.status === "RUNNING" || data.status === "ON RUN") {
                box.style.color = "#4cd964"; // Xanh lá
                box.style.borderColor = "#28a745";
            } else if (data.status === "BAO TRI") {
                box.style.color = "#ff6b6b"; // Đỏ
                box.style.borderColor = "#dc3545";
            } else {
                box.style.color = "#aaa"; // Xám
                box.style.borderColor = "#333";
            }

        } catch(e) {
            console.log("Lỗi parse JSON: " + e);
        }
    }

    // Hàm gửi lệnh lưu thời gian
    function sendSave() {
        if(!isConnected) { alert("Chưa kết nối MQTT!"); return; }
        
        var phone = document.getElementById("cfgPhone").value;
        var devId = document.getElementById("cfgDevId").value;
        var min = document.getElementById("inpMin").value;
        var sec = document.getElementById("inpSec").value;

        // Gửi Set Min
        var msgMin = new Paho.MQTT.Message(min.toString());
        msgMin.destinationName = "khachhang/" + phone + "/" + devId + "/set/min";
        client.send(msgMin);

        // Gửi Set Sec
        var msgSec = new Paho.MQTT.Message(sec.toString());
        msgSec.destinationName = "khachhang/" + phone + "/" + devId + "/set/sec";
        client.send(msgSec);

        // Gửi lệnh Lưu (1)
        setTimeout(function(){
            var msgSave = new Paho.MQTT.Message("1");
            msgSave.destinationName = "khachhang/" + phone + "/" + devId + "/cmd/save";
            client.send(msgSave);
        }, 200); // Delay nhỏ để ESP32 kịp nhận min/sec trước
    }

    // Hàm gửi lệnh bảo trì
    function sendMaint(mode) {
        if(!isConnected) { alert("Chưa kết nối MQTT!"); return; }
        var phone = document.getElementById("cfgPhone").value;
        var devId = document.getElementById("cfgDevId").value;
        
        var message = new Paho.MQTT.Message(mode.toString());
        message.destinationName = "khachhang/" + phone + "/" + devId + "/cmd/maint";
        client.send(message);
    }

    function toggleConfig() {
        var x = document.getElementById("configArea");
        if (x.style.display === "block") {
            x.style.display = "none";
        } else {
            x.style.display = "block";
        }
    }

    // Tự động kết nối khi mở trang
    window.onload = function() {
        doConnect();
    }
</script>

</body>
</html>
