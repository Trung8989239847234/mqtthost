<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT Smart Home Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <style>
        body { background-color: #0a1128; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .card { background: #121d3d; border-radius: 20px; padding: 30px; text-align: center; width: 300px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .gauge { font-size: 48px; font-weight: bold; margin: 20px 0; color: #3b82f6; }
        .controls { display: flex; justify-content: space-between; align-items: center; background: #0f172a; padding: 15px; border-radius: 15px; margin-top: 20px; }
        button { background: #1e293b; color: white; border: none; padding: 15px 20px; border-radius: 10px; cursor: pointer; font-size: 20px; transition: 0.3s; }
        button:hover { background: #3b82f6; }
        #status { font-size: 12px; margin-top: 10px; color: #64748b; }
        .log-container { margin-top: 20px; width: 300px; height: 150px; background: #000; padding: 10px; font-size: 11px; overflow-y: auto; border-radius: 10px; color: #10b981; text-align: left; }
    </style>
</head>
<body>

    <div class="card">
        <div style="color: #94a3b8; font-size: 14px;">CURRENT</div>
        <div class="gauge" id="temp-display">--.-°C</div>
        <div style="font-size: 12px; color: #475569;">Topic: /home/living-room/temp</div>

        <hr style="border: 0.5px solid #1e293b; margin: 30px 0;">

        <div style="font-weight: bold;">Target Temperature</div>
        <div class="controls">
            <button onclick="changeSetpoint(-1)">−</button>
            <div>
                <div id="setpoint-display" style="font-size: 24px; font-weight: bold;">22</div>
                <div style="font-size: 10px; color: #64748b;">SETPOINT</div>
            </div>
            <button onclick="changeSetpoint(1)">+</button>
        </div>
        <div id="status">Đang kết nối...</div>
    </div>

    <div class="log-container" id="mqtt-log">
        [System]: Khởi tạo console...<br>
    </div>

    <script>
        // Cấu hình MQTT
        const MQTT_CONFIG = {
            host: "trung-2601.ddns.net",
            port: 8084, // Cổng WebSocket SSL (WSS) của EMQX Cloud
            user: "haymd2a",
            pass: "all.ddnskey.com",
            clientId: "web_client_" + Math.random().toString(16).substr(2, 8),
            topicSub: "/home/living-room/temp",
            topicPub: "/home/living-room/set"
        };

        let setpoint = 22;
        let client = new Paho.MQTT.Client(MQTT_CONFIG.host, Number(MQTT_CONFIG.port), MQTT_CONFIG.clientId);

        // Hàm Log ra màn hình
        function writeLog(msg) {
            const log = document.getElementById('mqtt-log');
            log.innerHTML += `> ${msg}<br>`;
            log.scrollTop = log.scrollHeight;
        }

        // Kết nối
        client.connect({
            useSSL: true,
            userName: MQTT_CONFIG.user,
            password: MQTT_CONFIG.pass,
            onSuccess: () => {
                writeLog("Kết nối thành công!");
                document.getElementById('status').innerText = "Đã kết nối";
                document.getElementById('status').style.color = "#10b981";
                client.subscribe(MQTT_CONFIG.topicSub);
                writeLog("Đã Sub: " + MQTT_CONFIG.topicSub);
            },
            onFailure: (err) => {
                writeLog("Lỗi kết nối: " + err.errorMessage);
                document.getElementById('status').innerText = "Lỗi kết nối";
            }
        });

        // Xử lý tin nhắn đến
        client.onMessageArrived = (message) => {
            writeLog(`Nhận: ${message.payloadString} từ ${message.destinationName}`);
            if (message.destinationName === MQTT_CONFIG.topicSub) {
                document.getElementById('temp-display').innerText = message.payloadString + "°C";
            }
        };

        // Hàm thay đổi Setpoint và Publish
        function changeSetpoint(val) {
            setpoint += val;
            document.getElementById('setpoint-display').innerText = setpoint;
            
            let message = new Paho.MQTT.Message(setpoint.toString());
            message.destinationName = MQTT_CONFIG.topicPub;
            client.send(message);
            writeLog(`Gửi setpoint: ${setpoint} tới ${MQTT_CONFIG.topicPub}`);
        }

        client.onConnectionLost = (responseObject) => {
            if (responseObject.errorCode !== 0) {
                writeLog("Mất kết nối: " + responseObject.errorMessage);
            }
        };
    </script>
</body>
</html>
