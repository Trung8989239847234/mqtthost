<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ESP32 TIMER PRO (GEMINI + VOICE)</title>

  <!-- MQTT -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <!-- Markdown Parser for AI responses -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root { --accent:#00ff00; --bg-card: rgba(30, 41, 59, 0.85); }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);
      color:#fff; display:flex; justify-content:center; align-items:center;
      min-height:100vh; margin:0;
    }
    .card{
      background: var(--bg-card);
      backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
      padding:24px; border-radius:24px;
      box-shadow:0 20px 50px rgba(0,0,0,0.5);
      width:360px;
      text-align:center;
      border:1px solid rgba(255,255,255,0.08);
      position: relative;
    }

    /* Tabs */
    .nav-tabs{display:flex;justify-content:center;gap:4px;margin-bottom:24px;background:rgba(0,0,0,0.3);padding:4px;border-radius:12px;}
    .nav-item{cursor:pointer;padding:8px 16px;color:#94a3b8;font-weight:700;font-size:11px;text-transform:uppercase;border-radius:8px;transition:.3s;flex:1;text-align:center;}
    .nav-item.active{background:rgba(255,255,255,0.1);color:#fff;box-shadow:0 2px 10px rgba(0,0,0,0.2);}
    .tab-content{display:none}
    .tab-content.active{display:block;animation:fadeIn .4s}
    @keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}

    /* === HEADER ROW (HOME) === */
    .header-row {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 2px; padding: 0 4px;
    }
    .app-title { 
      font-size: 11px; font-weight: 800; color: #64748b; 
      letter-spacing: 1.5px; text-transform: uppercase; 
    }
    .signals { display: flex; gap: 6px; }
    .sig-dot { 
      width: 8px; height: 8px; border-radius: 50%; 
      background: #334155; 
      box-shadow: 0 0 0 2px rgba(30, 41, 59, 1);
      transition: all 0.3s;
    }
    .sig-dot.on { background: #10b981; box-shadow: 0 0 8px #10b981, 0 0 0 2px rgba(30, 41, 59, 1); }
    .sig-dot.err { background: #ef4444; }

    /* === TIMER & STATUS (HOME) === */
    .timer-box{
      color: #e2e8f0;
      font-family: 'Courier New', monospace;
      font-size: 72px; 
      font-weight: 700;
      line-height: 1;
      margin-top: 10px;
      margin-bottom: 0;
      letter-spacing: -2px;
      text-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .progress-container{width:100%;background-color:rgba(255,255,255,0.05);height:4px;border-radius:10px;overflow:hidden;margin: 15px 0 20px 0;}
    .progress-bar{height:100%;width:100%;background-color:#28a745;transition:width 1s linear, background-color .5s}

    .status-text {
      font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
      color: #64748b; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    .status-text.run { color: #3b82f6; }
    .status-text.wait { color: #f59e0b; }

    /* === NEW: QUICK INFO GROUP (BIG STYLE) === */
    .info-group {
      display: flex; justify-content: space-around; align-items: center;
      background: rgba(0,0,0,0.25);
      border-radius: 18px;
      padding: 15px 0;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .info-item { text-align: center; flex: 1; }
    .info-label { 
      font-size: 10px; color: #94a3b8; font-weight: 700; 
      text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; 
    }
    .info-val-row {
        display: flex; align-items: baseline; justify-content: center; gap: 4px;
    }
    .info-val { 
        font-size: 42px; line-height: 1; font-weight: 800; color: #fff; 
        font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
        text-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .info-unit { font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; }
    .info-div { width: 1px; height: 45px; background: rgba(255,255,255,0.1); }

    /* === SENSORS ROW (HOME) === */
    .simple-sensors {
      display: flex; justify-content: space-between; align-items: center;
      background: rgba(0,0,0,0.3);
      border-radius: 16px;
      padding: 12px 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .sensor-item { text-align: center; }
    .sensor-label { display: block; font-size: 9px; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 2px; }
    .sensor-val { font-size: 18px; font-weight: 700; color: #fff; font-family: 'Courier New', monospace; }
    .sensor-unit { font-size: 10px; color: #94a3b8; margin-left: 1px; }
    
    .sensor-divider { width: 1px; height: 24px; background: rgba(255,255,255,0.1); }

    /* AI Button Mini */
    .btn-ai-mini {
      background: linear-gradient(135deg, #8b5cf6, #d946ef);
      border: none; color: white;
      padding: 6px 12px; border-radius: 8px;
      font-size: 11px; font-weight: 700;
      cursor: pointer; display: flex; align-items: center; gap: 4px;
      box-shadow: 0 4px 12px rgba(217, 70, 239, 0.3);
      transition: .2s;
    }
    .btn-ai-mini:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(217, 70, 239, 0.4); }
    .btn-ai-mini:active { transform: scale(0.95); }

    /* Lock Button & Settings Panel */
    .settings-bar { display: flex; justify-content: center; margin-bottom: 0; }
    .btn-lock-pill {
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
      color: #64748b; padding: 8px 16px; border-radius: 20px;
      font-size: 11px; font-weight: 700; cursor: pointer;
      display: flex; align-items: center; gap: 6px; transition: .2s;
    }
    .btn-lock-pill.locked { color: #475569; }
    .btn-lock-pill:hover { background: rgba(255,255,255,0.1); color: #fff; }

    .settings-panel{ overflow:hidden; max-height:0; opacity:0; transform:translateY(-10px); transition:all .3s cubic-bezier(0.4, 0, 0.2, 1); margin-top: 0; }
    .settings-panel.open{ max-height:2600px; opacity:1; transform:translateY(0); margin-top: 20px; }
    .settings-panel.is-locked{ opacity:.5; pointer-events: none; filter: grayscale(1); }

    /* Controls (Stepper, etc) */
    .control-row { 
      background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px; margin-bottom: 8px; 
      display: flex; justify-content: space-between; align-items: center;
    }
    .stepper { display: flex; align-items: center; gap: 4px; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 4px; }
    .btn-step { width: 32px; height: 32px; background: rgba(255,255,255,0.05); border: none; color: #fff; border-radius: 6px; font-size: 16px; cursor: pointer; }
    .btn-step:hover { background: rgba(255,255,255,0.15); }
    .stepper input { width: 40px; background: transparent; border: none; color: #fff; text-align: center; font-weight: bold; font-size: 14px; outline: none; }
    
    .label-section { display: flex; align-items: center; gap: 10px; font-size: 13px; font-weight: 600; color: #cbd5e1; }
    .sub-text { font-size: 10px; color: #64748b; font-weight: 400; display: block; }

    .btn-primary { width: 100%; padding: 12px; border-radius: 12px; border: none; background: #3b82f6; color: white; font-weight: 700; cursor: pointer; margin-top: 10px; }
    
    /* Maintenance */
    .maintenance-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 15px; }
    .btn-m { background: rgba(255,255,255,0.05); border: none; color: #94a3b8; padding: 8px; border-radius: 8px; font-size: 11px; cursor: pointer; }
    .btn-m:hover { background: rgba(255,255,255,0.1); color: white; }
    .btn-manual { color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
    
    /* [ƒê√É S·ª¨A] Style n√∫t H·ªßy B·∫£o Tr√¨ l·∫•y t·ª´ file c≈© */
    .btn-cancel {
        background: rgba(255,69,58,0.15);
        color: #ff453a;
        border: 1px solid rgba(255,69,58,0.3);
        margin-top: 10px;
        width: 100%;
        padding: 12px;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
        font-size: 12px;
        transition: .2s;
    }
    .btn-cancel:hover { background: rgba(255,69,58,0.25); }

    /* Other Styles (Gemini, Toast, Modal...) preserved or adapted */
    #toast { visibility: hidden; min-width: 180px; background-color: rgba(15,23,42,0.95); color: #fff; text-align: center; border-radius: 50px; padding: 10px 20px; position: fixed; z-index: 1000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 13px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.3s, bottom 0.3s; border: 1px solid rgba(255,255,255,0.1); font-weight: 600; backdrop-filter: blur(5px); }
    #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
    
    .gemini-box { margin-bottom: 15px; padding: 10px; background: rgba(139, 92, 246, 0.05); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 12px; }
    .gemini-input { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 8px; border-radius: 8px; font-size: 12px; resize: none; box-sizing: border-box; }
    .input-row { display: flex; gap: 8px; margin-bottom: 8px; }
    .btn-gemini { width: 100%; padding: 8px; border-radius: 8px; background: #8b5cf6; color: white; border: none; font-weight: 700; font-size: 12px; cursor: pointer; }
    .btn-mic { width: 34px; height: 34px; background: rgba(255,255,255,0.1); border-radius: 8px; border: none; color: #fff; cursor: pointer; flex-shrink: 0; }
    .btn-mic.listening { background: #ef4444; animation: pulse 1s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    /* Modal & Config Styles */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .modal-box { background: #1e293b; padding: 20px; border-radius: 20px; width: 260px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
    .pin-display { background: rgba(0,0,0,0.3); border: none; color: #fff; font-size: 24px; text-align: center; width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 10px; letter-spacing: 5px; }
    .pin-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .btn-pin { padding: 12px; background: rgba(255,255,255,0.05); border: none; color: #fff; border-radius: 8px; font-size: 16px; cursor: pointer; }
    .btn-pin:active { background: rgba(255,255,255,0.15); }
    
    .cfg-wrap { text-align: left; }
    .cfg-card { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 8px; overflow: hidden; }
    .cfg-head { padding: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .cfg-title { font-size: 12px; font-weight: 700; color: #cbd5e1; }
    .cfg-body { padding: 0 10px 10px; display: none; }
    .cfg-card.open .cfg-body { display: block; }
    
    /* [RESTORED] Full Input Styles for Settings */
    .input-group { margin-bottom: 10px; }
    .input-group label { display: block; font-size: 11px; color: #94a3b8; margin-bottom: 4px; font-weight: 600; }
    .input-group input, .input-group select { width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 13px; box-sizing: border-box; transition: .2s; }
    .input-group input:focus { border-color: #3b82f6; outline: none; background: rgba(0,0,0,0.5); }
    
    /* [RESTORED] Full Schedule Table Styles */
    .card2 { text-align: left; }
    .tbl { width: 100%; font-size: 12px; color: #fff; border-collapse: collapse; }
    .tbl th, .tbl td { padding: 8px 6px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.08); vertical-align: middle; }
    .tbl th { color: #94a3b8; font-weight: 700; font-size: 11px; letter-spacing: 0.5px; }
    .tbl input[type="time"] { width: 100%; background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.12); color: #fff; padding: 6px 8px; border-radius: 8px; font-size: 12px; }
    
    /* Switch restored */
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #475569; transition: .2s; border-radius: 999px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .2s; border-radius: 50%; }
    input:checked + .slider { background-color: #10b981; }
    input:checked + .slider:before { transform: translateX(20px); }
    
    /* Day selector restored */
    .day-selector { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 4px; }
    .day-btn { padding: 6px 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #94a3b8; font-weight: 700; font-size: 10px; cursor: pointer; }
    .day-btn.active { background: rgba(59,130,246,0.25); border-color: rgba(59,130,246,0.6); color: #fff; }

    .btn-del { background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.3); color: #f87171; border-radius: 8px; padding: 6px 10px; cursor: pointer; font-weight: bold; font-size: 11px; }
    .btn-del:hover { background: rgba(239,68,68,0.3); }

    .presets-container{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:15px}
    .btn-preset{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.1);color:#ccc;border-radius:8px;padding:8px;font-size:11px;cursor:pointer;transition:.2s;display: flex;flex-direction: column;align-items: center;justify-content: center;text-align: center;height: 100%;}
    .btn-preset:hover{background:rgba(255,255,255,0.15);color:#fff;border-color:#0a84ff}
    .btn-preset span{display:block;font-weight:bold;font-size:13px;margin-bottom:2px;color:#fff}
    
    .cfg-note { margin-top: 6px; font-size: 11px; color: #8e8e93; font-weight: 600; text-align: left; }
    .cfg-footnote { margin-top: 8px; font-size: 11px; color: #cfd2d8; opacity: 0.85; text-align: left; }

    /* Timeline Bar (Fixed) */
    .timeline-container { margin: 15px 0 20px 0; text-align: left; }
    .timeline-labels { display: flex; justify-content: space-between; font-size: 10px; color: #888; margin-bottom: 3px; }
    .timeline-bar {
        width: 100%; height: 10px; background: #28a745; border-radius: 5px; overflow: hidden; display: flex;
        border: 1px solid rgba(255,255,255,0.1);
    }
    .t-seg { height: 100%; }
    .t-run { background: #28a745; } /* M√†u xanh ch·∫°y */
    .t-off { background: #dc3545; } /* M√†u ƒë·ªè ngh·ªâ */

    .cfg-card.wifi{border-left:4px solid #0a84ff;}
    .cfg-card.blynk{border-left:4px solid #34c759;}
    .cfg-card.tb{border-left:4px solid #32ade6;}
    .cfg-card.sensors{border-left:4px solid #ff9f0a;}
    .cfg-card.emqx-dev{border-left:4px solid #bf5af2;}
    .cfg-card.mqttws{border-left:4px solid #60efff;}
    .cfg-card.ai{border-left:4px solid #8E2DE2;}

  </style>
</head>

<body>
  <div id="toast">Th√¥ng b√°o</div>

  <!-- Modal PIN -->
  <div id="pinModal" class="modal-overlay">
    <div class="modal-box">
      <h3 style="margin-top:0;color:#e2e8f0;font-size:14px;margin-bottom:20px; font-weight: 700;">NH·∫¨P M√É PIN</h3>
      <input type="password" id="pinInput" class="pin-display" readonly placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      <div class="pin-pad">
        <button class="btn-pin" onclick="typePin(1)">1</button>
        <button class="btn-pin" onclick="typePin(2)">2</button>
        <button class="btn-pin" onclick="typePin(3)">3</button>
        <button class="btn-pin" onclick="typePin(4)">4</button>
        <button class="btn-pin" onclick="typePin(5)">5</button>
        <button class="btn-pin" onclick="typePin(6)">6</button>
        <button class="btn-pin" onclick="typePin(7)">7</button>
        <button class="btn-pin" onclick="typePin(8)">8</button>
        <button class="btn-pin" onclick="typePin(9)">9</button>
        <button class="btn-pin" style="color:#ef4444" onclick="clearPin()">C</button>
        <button class="btn-pin" onclick="typePin(0)">0</button>
        <button class="btn-pin" style="color:#10b981" onclick="submitPin()">OK</button>
      </div>
      <button style="margin-top:15px;background:none;border:none;color:#64748b;cursor:pointer;font-size:12px;" onclick="closePinModal()">ƒê√≥ng</button>
    </div>
  </div>

  <div class="card">
    <!-- 1. Tabs g·ªçn g√†ng -->
    <div class="nav-tabs">
      <div id="tab-home" class="nav-item active" onclick="switchTab('home')">Trang ch·ªß</div>
      <div id="tab-schedule" class="nav-item" onclick="openSchedule()">H·∫πn gi·ªù</div>
      <div id="tab-settings" class="nav-item" onclick="tryOpenSettings()">C√†i ƒë·∫∑t</div>
    </div>

    <div id="home" class="tab-content active">
      
      <!-- 2. Header Row Compact (NEW STYLE) -->
      <div class="header-row">
        <div class="app-title">ESP32 TIMER PRO</div>
        <div class="signals">
          <div id="mqttPill" class="sig-dot" title="MQTT"></div>
          <div id="devPill" class="sig-dot" title="Device"></div>
        </div>
      </div>

      <!-- 3. Timer & Status Below (NEW STYLE) -->
      <div id="timerDisplay" class="timer-box">--:--</div>
      <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
      
      <div id="statusText" class="status-text">
         <span>‚ö°</span> ƒêANG NGH·ªà (OFF)
      </div>

      <!-- 3.5 [NEW] QUICK VIEW SETTINGS -->
      <div class="info-group">
        <div class="info-item">
            <span class="info-label">C√ÄI ƒê·∫∂T NGH·ªà</span>
            <div class="info-val-row">
                <span id="qOff" class="info-val">--</span>
                <span class="info-unit">Ph√∫t</span>
            </div>
        </div>
        <div class="info-div"></div>
        <div class="info-item">
            <span class="info-label">C√ÄI ƒê·∫∂T CH·∫†Y</span>
            <div class="info-val-row">
                <span id="qOn" class="info-val">--</span>
                <span class="info-unit">Gi√¢y</span>
            </div>
        </div>
      </div>

      <!-- 4. Sensors Compact Row (NEW STYLE) -->
      <div class="simple-sensors" id="simpleSensors">
        <div class="sensor-item">
            <span class="sensor-label">D√íNG ƒêI·ªÜN</span>
            <div><span id="ampsValue" class="sensor-val">--</span><span class="sensor-unit">A</span></div>
        </div>
        <div class="sensor-divider"></div>
        <div class="sensor-item">
            <span class="sensor-label">NHI·ªÜT ƒê·ªò</span>
            <div><span id="tempValue" class="sensor-val">--</span><span class="sensor-unit">¬∞C</span></div>
        </div>
        <div class="sensor-divider"></div>
        <button id="btnAiAnalyze" class="btn-ai-mini" onclick="analyzeSensorsAI()">
             ‚ú® Dr.AI
        </button>
      </div>

      <!-- Lock Button Pill -->
      <div class="settings-bar">
        <button type="button" id="btnLock" class="btn-lock-pill locked" onclick="toggleLock()">
          üîí <span id="lockBtnLabel">ƒê√É KH√ìA ƒêI·ªÄU KHI·ªÇN</span>
        </button>
      </div>

      <!-- Settings Panel Inside Home (Quick Controls) -->
      <div id="settingsPanel" class="settings-panel">
          <!-- Voice Control -->
          <div class="gemini-box">
            <div class="input-row">
              <textarea id="aiControlPrompt" class="gemini-input" rows="1" placeholder="VD: TƒÉng ch·∫°y 5s..."></textarea>
              <button class="btn-mic" onclick="startListening('aiControlPrompt', this)">üé§</button>
            </div>
            <button id="btnAiControl" class="btn-gemini" onclick="controlSettingsAI()">‚ú® Th·ª±c hi·ªán</button>
          </div>
          
          <!-- Presets Restored -->
          <div style="text-align:left;font-size:11px;color:#8e8e93;font-weight:bold;margin-bottom:8px">C·∫§U H√åNH NHANH</div>
          <div class="presets-container">
            <button class="btn-preset" onclick="applyPreset(5,10)"><span>T∆Ø·ªöI C√ÇY</span>5m T·∫Øt / 10s B·∫≠t</button>
            <button class="btn-preset" onclick="applyPreset(30,5)"><span>B∆†M N∆Ø·ªöC</span>30m T·∫Øt / 5s B·∫≠t</button>
            <button class="btn-preset" onclick="applyPreset(1,2)"><span>TEST NHANH</span>1m T·∫Øt / 2s B·∫≠t</button>
          </div>

          <div class="control-row">
            <div class="label-section">
              <div class="icon">üèÉ</div>
              <div><div>CH·∫†Y (On)</div><span class="sub-text">Th·ªùi gian b·∫≠t</span></div>
            </div>
            <div class="stepper">
              <button type="button" class="btn-step" onclick="adjustValue('onSec',-1)">‚àí</button>
              <input type="number" id="onSec" value="" placeholder="--">
              <button type="button" class="btn-step" onclick="adjustValue('onSec',1)">+</button>
            </div>
          </div>

          <div class="control-row">
            <div class="label-section">
              <div class="icon">üí§</div>
              <div><div>NGH·ªà (Off)</div><span class="sub-text">Th·ªùi gian t·∫Øt</span></div>
            </div>
            <div class="stepper">
              <button type="button" class="btn-step" onclick="adjustValue('offMin',-1)">‚àí</button>
              <input type="number" id="offMin" value="" placeholder="--">
              <button type="button" class="btn-step" onclick="adjustValue('offMin',1)">+</button>
            </div>
          </div>

          <button class="btn-primary" onclick="saveSettings()">L∆ØU C√ÄI ƒê·∫∂T</button>
          
          <div class="maintenance-title">üîß Ch·∫ø ƒë·ªô b·∫£o tr√¨</div>
          <div class="maintenance-grid">
            <button class="btn-m" onclick="setMaint(1)">7p</button>
            <button class="btn-m" onclick="setMaint(2)">15p</button>
            <button class="btn-m" onclick="setMaint(3)">30p</button>
            <button class="btn-m" onclick="setMaint(4)">50p</button>
            <button class="btn-m" onclick="setMaint(5)">80p</button>
            <button class="btn-m btn-manual" onclick="setMaint(6)">‚àû</button>
          </div>
          <!-- [ƒê√É S·ª¨A] D√πng class btn-cancel ƒë·ªÉ c√≥ m√†u ƒë·ªè nh∆∞ theme c≈© -->
          <button class="btn-cancel" onclick="setMaint(0)">H·ª¶Y B·∫¢O TR√å</button>
      </div>
    </div>

    <!-- SCHEDULE TAB (RESTORED FULL UI & FIXED TIMELINE) -->
    <div id="schedule" class="tab-content">
      <div class="gemini-box">
        <div class="input-row">
          <textarea id="aiPrompt" class="gemini-input" rows="2" placeholder="VD: Ngh·ªâ t·ª´ 22h ƒë·∫øn 5h s√°ng..."></textarea>
          <button class="btn-mic" onclick="startListening('aiPrompt', this)">üé§</button>
        </div>
        <button id="btnAiSchedule" class="btn-gemini" onclick="generateScheduleAI()">‚ú® T·∫°o l·ªãch t·ª± ƒë·ªông</button>
      </div>

      <!-- [FIXED] Timeline Bar Restoration -->
      <div class="timeline-container">
        <div class="timeline-labels">
          <span>00:00</span><span>12:00</span><span>23:59</span>
        </div>
        <div id="timelineBar" class="timeline-bar"></div>
        <div id="timelineStatus" style="margin-top:6px;font-size:11px;color:#8e8e93;text-align:right">
          H√¥m nay kh√¥ng c√≥ l·ªãch ngh·ªâ n√†o k√≠ch ho·∫°t.
        </div>
      </div>

      <div class="card2">
        <div style="text-align:left;font-size:11px;color:#94a3b8;margin-bottom:8px; font-weight:700;">DANH S√ÅCH GI·ªú NGH·ªà</div>
        <table class="tbl">
          <thead>
            <tr><th>B·∫Øt ƒë·∫ßu</th><th>K·∫øt th√∫c</th><th style="text-align:center">B·∫≠t</th><th style="text-align:center">X√≥a</th></tr>
          </thead>
          <tbody id="pauseTbody"></tbody>
        </table>
        <div class="btn-row">
          <button class="btn-m" onclick="addPauseRow()">+ Th√™m m·ªëc</button>
          <button class="btn-save" onclick="savePause()">L∆∞u L·ªãch</button>
        </div>
      </div>
    </div>

    <!-- SETTINGS TAB (RESTORED FULL CARDS) -->
    <div id="settings" class="tab-content">
      <div class="cfg-wrap">
        
        <!-- Gemini API Key -->
        <div class="cfg-card ai">
          <div class="cfg-head" onclick="toggleCfgCard(this)">
            <div class="cfg-left"><span class="cfg-badge">AI</span><span class="cfg-title">Gemini API Key (B·∫Øt bu·ªôc)</span></div>
            <div class="cfg-arrow">‚ñæ</div>
          </div>
          <div class="cfg-body">
            <div class="input-group">
              <label>API Key (L·∫•y t·ª´ Google AI Studio)</label>
              <input type="password" id="cfg_gemini_key" value="AIzaSyB5K7JbtmLiQ4t-HpcB6wrzPBhJ5PWcFhs"><span class="toggle-eye" onclick="togglePass('cfg_gemini_key')">üëÅÔ∏è</span>
            </div>
            <button class="btn-primary" onclick="saveUiSettings()">L∆∞u Key</button>
          </div>
        </div>

        <!-- MQTT WebSocket (Browser Dashboard) -->
        <div class="cfg-card mqttws">
          <div class="cfg-head" onclick="toggleCfgCard(this)">
            <div class="cfg-left"><span class="cfg-badge">MQTT</span><span class="cfg-title">MQTT WebSocket (Dashboard)</span></div>
            <div class="cfg-arrow">‚ñæ</div>
          </div>
          <div class="cfg-body">
            <div class="input-group">
              <label>Device ID (ƒë·ªÉ t·∫°o Topic)</label>
              <input type="text" id="cfg_devid" value="timer02">
            </div>

            <div class="input-group">
              <label>EMQX Host</label>
              <input type="text" id="cfg_emqx_host" value="n21f2dda.ala.dedicated.aws.emqxcloud.com">
            </div>

            <div class="input-group">
              <label>EMQX WebSocket Port</label>
              <input type="number" id="cfg_emqx_ws_port" value="8084">
            </div>

            <div class="input-group">
              <label>WebSocket Path</label>
              <input type="text" id="cfg_emqx_ws_path" value="/mqtt">
            </div>

            <div class="input-group">
              <label>Use TLS (wss)</label>
              <select id="cfg_emqx_wss">
                <option value="1" selected>B·∫≠t (wss://)</option>
                <option value="0">T·∫Øt (ws://)</option>
              </select>
            </div>

            <div class="input-group">
              <label>EMQX Username</label>
              <input type="text" id="cfg_emqx_user" value="anhtrung1">
            </div>

            <div class="input-group">
              <label>EMQX Password</label>
              <input type="password" id="cfg_emqx_pass" value="anhtrung1">
              <span class="toggle-eye" onclick="togglePass('cfg_emqx_pass')">üëÅÔ∏è</span>
            </div>

            <button class="btn-primary" onclick="saveUiSettings()">L∆ØU (TR√äN TR√åNH DUY·ªÜT)</button>

            <div style="margin-top:10px;display:flex;gap:8px">
              <button class="btn-m" style="flex:1;background:#007bff;color:white" onclick="mqttConnect()">K·∫æT N·ªêI</button>
              <button class="btn-m" style="flex:1" onclick="mqttDisconnect()">NG·∫ÆT</button>
            </div>

            <div class="log-box" id="logDisplay" style="margin-top:12px">
              <div class="log-entry">Log: ready.</div>
            </div>
            
            <div style="margin-top:10px;text-align:left;font-size:11px;color:#cfd2d8;opacity:.9">
              L∆∞u √Ω: GitHub Pages ch·ªâ ch·∫°y tr√™n browser n√™n <b>ph·∫£i d√πng MQTT qua WebSocket</b> (ws/wss). Port TCP 1883 kh√¥ng d√πng tr·ª±c ti·∫øp trong browser.
            </div>
          </div>
        </div>
        
        <!-- WiFi + Device -->
        <div class="cfg-card wifi">
          <div class="cfg-head" onclick="toggleCfgCard(this)">
            <div class="cfg-left"><span class="cfg-badge">ESP32</span><span class="cfg-title">WiFi & Device</span></div>
            <div class="cfg-arrow">‚ñæ</div>
          </div>
          <div class="cfg-body">
            <div class="input-group">
              <label>Device ID (ESP32 sau reboot)</label>
              <input type="text" id="cfg_sys_devid" value="timer02">
            </div>

            <div class="input-group">
              <label>WiFi SSID</label>
              <input type="text" id="cfg_wifi_ssid" value="Thanh Trung 123">
            </div>

            <div class="input-group">
              <label>WiFi Password</label>
              <input type="password" id="cfg_wifi_pass" value="anhtrung">
              <span class="toggle-eye" onclick="togglePass('cfg_wifi_pass')">üëÅÔ∏è</span>
            </div>

            <div class="cfg-note">* ƒê·ªïi WiFi / Device ID s·∫Ω khi·∫øn ESP32 reboot.</div>
          </div>
        </div>

        <!-- Blynk -->
        <div class="cfg-card blynk">
          <div class="cfg-head" onclick="toggleCfgCard(this)">
            <div class="cfg-left"><span class="cfg-badge">APP</span><span class="cfg-title">Blynk</span></div>
            <div class="cfg-arrow">‚ñæ</div>
          </div>
          <div class="cfg-body">
            <div class="input-group">
              <label>Tr·∫°ng th√°i Blynk</label>
              <select id="cfg_b_en">
                <option value="1" selected>B·∫≠t (Enable)</option>
                <option value="0">T·∫Øt (Disable)</option>
              </select>
            </div>

            <div class="input-group">
              <label>Blynk Server</label>
              <input type="text" id="cfg_b_host" value="blynk.hqn.vn">
            </div>

            <div class="input-group">
              <label>Blynk Port</label>
              <input type="number" id="cfg_b_port" value="8080">
            </div>

            <div class="input-group">
              <label>Blynk Token</label>
              <input type="password" id="cfg_b_token" value="gxShmU6_ZvZOKY2UZRew9PwkipWM_9uJ">
              <span class="toggle-eye" onclick="togglePass('cfg_b_token')">üëÅÔ∏è</span>
            </div>
          </div>
        </div>

        <!-- ThingsBoard -->
        <div class="cfg-card tb">
          <div class="cfg-head" onclick="toggleCfgCard(this)">
            <div class="cfg-left"><span class="cfg-badge">IOT</span><span class="cfg-title">ThingsBoard</span></div>
            <div class="cfg-arrow">‚ñæ</div>
          </div>
          <div class="cfg-body">
            <div class="input-group">
              <label>Tr·∫°ng th√°i ThingsBoard</label>
              <select id="cfg_tb_en">
                <option value="1" selected>B·∫≠t (Enable)</option>
                <option value="0">T·∫Øt (Disable)</option>
              </select>
            </div>

            <div class="input-group">
              <label>ThingsBoard Server</label>
              <input type="text" id="cfg_tb_host" value="thingsboard.cloud">
            </div>

            <div class="input-group">
              <label>ThingsBoard Port</label>
              <input type="number" id="cfg_tb_port" value="1883">
            </div>

            <div class="input-group">
              <label>Device Token</label>
              <input type="password" id="cfg_tb_token" value="KtRAK5YlpIeoDvrqKg6p">
              <span class="toggle-eye" onclick="togglePass('cfg_tb_token')">üëÅÔ∏è</span>
            </div>
          </div>
        </div>

        <!-- Sensors -->
        <div class="cfg-card sensors">
          <div class="cfg-head" onclick="toggleCfgCard(this)">
            <div class="cfg-left"><span class="cfg-badge">HW</span><span class="cfg-title">Sensors</span></div>
            <div class="cfg-arrow">‚ñæ</div>
          </div>
          <div class="cfg-body">
            <div class="input-group">
              <label>SCT (C·∫£m bi·∫øn d√≤ng)</label>
              <select id="cfg_sct_en">
                <option value="1" selected>B·∫≠t</option>
                <option value="0">T·∫Øt</option>
              </select>
            </div>

            <div class="input-group">
              <label>DS18B20 (Nhi·ªát ƒë·ªô)</label>
              <select id="cfg_temp_en">
                <option value="1" selected>B·∫≠t</option>
                <option value="0">T·∫Øt</option>
              </select>
            </div>

            <div class="input-group">
              <label>Phao ch·ªëng tr√†n (Phao 1)</label>
              <select id="cfg_phao1_en">
                <option value="1" selected>B·∫≠t</option>
                <option value="0">T·∫Øt</option>
              </select>
            </div>

            <div class="cfg-note">* Thay ƒë·ªïi sensor s·∫Ω khi·∫øn ESP32 reboot.</div>
          </div>
        </div>

        <!-- EMQX (ESP32 TCP) -->
        <div class="cfg-card emqx-dev">
          <div class="cfg-head" onclick="toggleCfgCard(this)">
            <div class="cfg-left"><span class="cfg-badge">MQTT</span><span class="cfg-title">EMQX (ESP32 TCP)</span></div>
            <div class="cfg-arrow">‚ñæ</div>
          </div>
          <div class="cfg-body">
            <div class="input-group">
              <label>Tr·∫°ng th√°i EMQX (ESP32)</label>
              <select id="cfg_dev_emqx_en">
                <option value="1" selected>B·∫≠t</option>
                <option value="0">T·∫Øt</option>
              </select>
            </div>

            <div class="input-group">
              <label>EMQX Host (TCP)</label>
              <input type="text" id="cfg_dev_emqx_host" value="n21f2dda.ala.dedicated.aws.emqxcloud.com">
            </div>

            <div class="input-group">
              <label>EMQX Port (TCP)</label>
              <input type="number" id="cfg_dev_emqx_port" value="1883">
            </div>

            <div class="input-group">
              <label>EMQX Username</label>
              <input type="text" id="cfg_dev_emqx_user" value="anhtrung1">
            </div>

            <div class="input-group">
              <label>EMQX Password</label>
              <input type="password" id="cfg_dev_emqx_pass" value="anhtrung1">
              <span class="toggle-eye" onclick="togglePass('cfg_dev_emqx_pass')">üëÅÔ∏è</span>
            </div>

            <div class="input-group">
              <label>Use TLS (ESP32)</label>
              <select id="cfg_dev_emqx_tls">
                <option value="1">B·∫≠t (TLS)</option>
                <option value="0" selected>T·∫Øt</option>
              </select>
            </div>

            <div style="margin-top:8px;display:flex;gap:8px">
              <button class="btn-m" style="flex:1" onclick="copyUiToDevEmqx()">COPY T·ª™ MQTT WEB</button>
            </div>

            <div class="cfg-note">* Thay ƒë·ªïi EMQX (ESP32) s·∫Ω khi·∫øn ESP32 reboot.</div>
          </div>
        </div>

        <button class="btn-primary" style="margin-top:10px;background:linear-gradient(90deg,#34c759,#0a84ff)" onclick="saveSysConfig()">G·ª¨I C·∫§U H√åNH XU·ªêNG ESP32 (RPC)</button>
        <div class="cfg-footnote">
          * S·∫Ω g·ªçi MQTT RPC method <b>setSysConfig</b> (theo code .ino) v√† ESP32 s·∫Ω reboot.
        </div>
      </div>
    </div>
  </div>

<script>
/* ========= STATE ========= */
let client = null;
let lastUserInteraction = 0;
let mqttConnState = 'disconnected';
let lastTelemetryTs = 0;
const STALE_MS = 10000;
const DEVICE_TIMEOUT_MS = 30000;
let deviceOnline = false;
let deviceWatchdog = null;
let uiLocked = true;
let autoRelockTimer = null;
const AUTO_RELOCK_MS = 30000;

window.state = {
  time_rem: "--:--", rem_s: null, off_min: null, on_sec: null,
  status: "OFFLINE", maint_mode: 0, pause_active: 0, relay_run: false, wait5s: false,
  pause_json: [],
  amps: null, temp: null
};

/* ========= UI HELPERS ========= */
function showToast(msg) {
  var x = document.getElementById("toast");
  x.innerText = msg;
  x.className = "show";
  setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
}

function updateStatusText(text, type){
    const el = document.getElementById("statusText");
    if(!el) return;
    
    // Icon mapping
    let icon = "üí§";
    if(type === "run") icon = "‚ö°";
    else if(type === "wait") icon = "‚è≥";
    
    el.innerHTML = `<span>${icon}</span> ${text}`;
    el.className = "status-text " + (type || "");
}

function setMqttPill(connected){
  const el = document.getElementById("mqttPill");
  if(el) {
      el.classList.toggle("on", !!connected);
      el.classList.toggle("err", !connected);
  }
}
function setDevPill(connected){
  const el = document.getElementById("devPill");
  if(el) {
      el.classList.toggle("on", !!connected);
      el.classList.toggle("err", !connected);
  }
}

function startDeviceWatchdog(){
  if(deviceWatchdog) clearInterval(deviceWatchdog);
  deviceWatchdog = setInterval(()=>{
    const mqttOk = (mqttConnState === "connected");
    const devOk = mqttOk && lastTelemetryTs && (Date.now() - lastTelemetryTs <= DEVICE_TIMEOUT_MS);
    deviceOnline = !!devOk;
    setMqttPill(mqttOk);
    setDevPill(deviceOnline);
    
    if(!mqttOk) updateStatusText("M·∫§T K·∫æT N·ªêI SERVER", "wait");
    else if(!devOk) updateStatusText("M·∫§T K·∫æT N·ªêI THI·∫æT B·ªä", "wait");
    
  }, 1000);
}

/* ========= RENDER HOME REFACTORED ========= */
function renderHome(){
  document.getElementById("timerDisplay").textContent = (window.state.time_rem && window.state.time_rem.length>0) ? window.state.time_rem : "--:--";
  const pb = document.getElementById("progressBar");

  const pause = (Number(window.state.pause_active)||0)>0;
  const maint = Number(window.state.maint_mode)||0;
  const relay = !!window.state.relay_run;
  const wait5s = (String(window.state.status).toUpperCase().includes("WAIT"));

  let statusStr = "ƒêANG NGH·ªà (OFF)";
  let statusClass = "";

  if(pause){
    statusStr = "ƒêANG T·∫†M NGH·ªà";
    pb.style.width="100%"; pb.style.backgroundColor="#475569";
  } else if(maint>0){
    statusStr = "ƒêANG B·∫¢O TR√å";
    statusClass = "wait"; 
    pb.style.width="100%"; pb.style.backgroundColor="#ef4444";
  } else if(relay){
    statusStr = "ƒêANG CH·∫†Y (ON)";
    statusClass = "run"; 
    pb.style.backgroundColor="#3b82f6";
    const t=Number(window.state.on_sec)||0, c=Number(window.state.rem_s)||0;
    if(t>0 && c>=0) pb.style.width=(c/t*100)+"%";
  } else if(wait5s){
    statusStr = "CH·ªú KH·ªûI ƒê·ªòNG...";
    statusClass = "wait";
    pb.style.backgroundColor="#f59e0b"; pb.style.width="100%";
  } else {
    // Normal OFF
    pb.style.backgroundColor="#475569";
    const t=(Number(window.state.off_min)||0)*60, c=Number(window.state.rem_s)||0;
    if(t>0 && c>=0) pb.style.width=(c/t*100)+"%";
  }

  updateStatusText(statusStr, statusClass);
  
  // Sensors
  const stale = (!lastTelemetryTs) || (Date.now() - lastTelemetryTs > STALE_MS);
  const sBox = document.getElementById("simpleSensors");
  if(sBox) sBox.classList.toggle("stale", stale);

  const aEl = document.getElementById("ampsValue");
  if(aEl) aEl.textContent = (!stale && Number.isFinite(parseFloat(window.state.amps))) ? parseFloat(window.state.amps).toFixed(2) : "--";
  
  const tEl = document.getElementById("tempValue");
  if(tEl) tEl.textContent = (!stale && Number.isFinite(parseFloat(window.state.temp))) ? parseFloat(window.state.temp).toFixed(2) : "--";

  // Quick Info
  if(window.state.off_min!==null) document.getElementById("qOff").textContent = window.state.off_min;
  if(window.state.on_sec!==null) document.getElementById("qOn").textContent = window.state.on_sec;

  // Sync inputs if idle
  if(Date.now()-lastUserInteraction>5000){
    if(window.state.off_min!==null) document.getElementById("offMin").value=window.state.off_min;
    if(window.state.on_sec!==null) document.getElementById("onSec").value=window.state.on_sec;
  }
}

/* ========= LOCK LOGIC ========= */
function toggleLock(){
  uiLocked = !uiLocked;
  const btn = document.getElementById('btnLock');
  const label = document.getElementById('lockBtnLabel');
  
  if(btn) btn.classList.toggle('locked', uiLocked);
  
  const panel = document.getElementById('settingsPanel');
  if(panel) {
      panel.classList.toggle('is-locked', uiLocked);
      if(!uiLocked) panel.classList.add('open'); 
      else panel.classList.remove('open');
  }

  if(uiLocked){
    disarmAutoRelock();
    if(label) label.innerText = "ƒê√É KH√ìA ƒêI·ªÄU KHI·ªÇN";
    showToast('ƒê√£ kh√≥a');
  } else {
    if(label) label.innerText = "CH·∫†M ƒê·ªÇ KH√ìA";
    showToast('ƒê√£ m·ªü kh√≥a');
    armAutoRelock();
  }
}

function armAutoRelock(){
  try{ if(autoRelockTimer) clearTimeout(autoRelockTimer); }catch(e){}
  autoRelockTimer = setTimeout(()=>{
    if(!uiLocked) toggleLock();
  }, AUTO_RELOCK_MS);
}
function disarmAutoRelock(){
  try{ if(autoRelockTimer) clearTimeout(autoRelockTimer); }catch(e){}
  autoRelockTimer = null;
}

/* ========= TABS & ACCORDION ========= */
function switchTab(t){
  document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
  document.getElementById(t).classList.add('active');
  document.getElementById('tab-'+t).classList.add('active');
  if(t === 'settings') closeAllCfgCards();
}
function openSchedule(){
  switchTab('schedule');
  if(window.renderTimeline) window.renderTimeline();
  if(window.renderPauseTable) window.renderPauseTable();
}
function toggleCfgCard(headEl){
  const card = headEl.closest('.cfg-card');
  const isOpen = card.classList.contains('open');
  closeAllCfgCards();
  if(!isOpen) card.classList.add('open');
}
function closeAllCfgCards(){
  document.querySelectorAll('.cfg-card').forEach(c=>c.classList.remove('open'));
}

/* ========= MQTT & DATA LOGIC ========= */
function getCfg(){
  return {
    devid: (document.getElementById('cfg_devid').value || "timer02").trim(),
    host: (document.getElementById('cfg_emqx_host').value || "").trim(),
    wsPort: parseInt(document.getElementById('cfg_emqx_ws_port').value || "8084", 10),
    wsPath: (document.getElementById('cfg_emqx_ws_path').value || "/mqtt").trim(),
    wss: (document.getElementById('cfg_emqx_wss').value || "1") === "1",
    user: (document.getElementById('cfg_emqx_user').value || "").trim(),
    pass: (document.getElementById('cfg_emqx_pass').value || ""),
    geminiKey: (document.getElementById('cfg_gemini_key').value || "")
  };
}

function mqttConnect(){
  const cfg = getCfg();
  if(!cfg.host){ showToast("Thi·∫øu Host MQTT"); return; }
  const proto = cfg.wss ? "wss" : "ws";
  const url = `${proto}://${cfg.host}:${cfg.wsPort}${cfg.wsPath}`;

  if(client){ try{ client.end(true); }catch(e){} client = null; }
  
  addLog("Connecting...");
  client = mqtt.connect(url, {
    username: cfg.user, password: cfg.pass,
    clientId: cfg.devid + "_web_" + Math.random().toString(16).slice(2,8),
    clean: true, keepalive: 60
  });

  client.on("connect", () => {
    mqttConnState = "connected";
    startDeviceWatchdog();
    addLog("Connected!");
    showToast("ƒê√£ k·∫øt n·ªëi Server");
    client.subscribe([`devices/${cfg.devid}/telemetry`, `devices/${cfg.devid}/rpc/response/+`], (err) => {
      if(!err){
        addLog("Subscribed. Requesting Sync...");
        rpcCall("setOffMin", {}); 
        rpcCall("setOnSec", {}); 
        rpcCall("getPauseJson", {});
      } else {
        addLog("Subscribe Error: " + err.message);
      }
    });
  });
  
  client.on("reconnect", ()=>{ mqttConnState = "reconnecting"; updateStatusDot(); });
  client.on("close", ()=>{ mqttConnState = "disconnected"; updateStatusDot(); });
  
  client.on("message", (topic, payload) => {
    const txt = payload.toString();
    if(topic.includes("telemetry")){
        try{
            const obj = JSON.parse(txt);
            Object.assign(window.state, obj);
            if(obj.pause_json && typeof obj.pause_json === 'string') {
                try { window.state.pause_json = JSON.parse(obj.pause_json); } catch(e){}
            } else if (obj.pause_json && Array.isArray(obj.pause_json)) {
                window.state.pause_json = obj.pause_json;
            }
            
            lastTelemetryTs = Date.now();
            renderHome();
            if(document.getElementById('schedule').classList.contains('active')) {
                window.renderTimeline();
                window.renderPauseTable();
            }
        }catch(e){}
    } else if(topic.includes("rpc/response")){
        // [ƒê√É S·ª¨A] B·∫Øt gi√° tr·ªã RPC Response v√† c·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c v√†o √¥ input v√† quick view
        try {
            const r = JSON.parse(txt);
            if(r.off_min !== undefined) {
                document.getElementById("offMin").value = r.off_min;
                window.state.off_min = r.off_min; // Sync v√†o state lu√¥n
            }
            if(r.on_sec !== undefined) {
                document.getElementById("onSec").value = r.on_sec;
                window.state.on_sec = r.on_sec; // Sync v√†o state lu√¥n
            }
            // G·ªçi renderHome ƒë·ªÉ update quick view
            renderHome();
        } catch(e){}
        showToast("L·ªánh th√†nh c√¥ng!");
    }
  });
}

function rpcCall(method, params){
    if(!client || !client.connected) { showToast("Ch∆∞a k·∫øt n·ªëi MQTT"); return; }
    const cfg = getCfg();
    const reqId = Date.now().toString();
    const t = `devices/${cfg.devid}/rpc/request/${reqId}`;
    client.publish(t, JSON.stringify({ method, params }), {qos:0, retain:false});
}

function mqttDisconnect(){
  if(client){ try{ client.end(true); }catch(e){} client = null; }
  addLog("MQTT disconnected");
  showToast("ƒê√£ ng·∫Øt k·∫øt n·ªëi");
}

function addLog(msg){
  const box = document.getElementById("logDisplay");
  if(box) box.innerHTML = `<div class="log-entry">${msg}</div>` + box.innerHTML;
}
function saveUiSettings(){
  localStorage.setItem("emqx_ui_cfg", JSON.stringify(getCfg()));
  showToast("ƒê√£ l∆∞u!");
  if(client) mqttConnect();
}
function loadUiSettings(){
  try{
    const raw = localStorage.getItem("emqx_ui_cfg");
    if(raw) {
        const c = JSON.parse(raw);
        if(c.devid) document.getElementById('cfg_devid').value = c.devid;
        if(c.host) document.getElementById('cfg_emqx_host').value = c.host;
        if(c.geminiKey) document.getElementById('cfg_gemini_key').value = c.geminiKey;
        // ... load others if needed
    }
  }catch(e){}
}
// [FIX] Sys Config logic restored
function copyUiToDevEmqx(){
  try{
    const ui = getCfg();
    const h = document.getElementById('cfg_dev_emqx_host');
    const u = document.getElementById('cfg_dev_emqx_user');
    const p = document.getElementById('cfg_dev_emqx_pass');
    if(h && ui.host) h.value = ui.host;
    if(u && ui.user) u.value = ui.user;
    if(p && ui.pass) p.value = ui.pass;
    showToast('ƒê√£ copy EMQX t·ª´ MQTT Web');
  }catch(e){}
}

function getSysCfgFromForm(){
  const v = (id, d='') => (document.getElementById(id)?.value ?? d);
  const num = (x, d=0) => {
    const n = parseInt(String(x), 10);
    return Number.isFinite(n) ? n : d;
  };
  return {
    ssid: String(v('cfg_wifi_ssid')).trim(),
    pass: String(v('cfg_wifi_pass')),
    devid: String(v('cfg_sys_devid')).trim(),

    b_en: num(v('cfg_b_en','1'), 1),
    b_host: String(v('cfg_b_host')).trim(),
    b_port: num(v('cfg_b_port','8080'), 8080),
    b_token: String(v('cfg_b_token')),

    tb_en: num(v('cfg_tb_en','1'), 1),
    tb_host: String(v('cfg_tb_host')).trim(),
    tb_port: num(v('cfg_tb_port','1883'), 1883),
    tb_token: String(v('cfg_tb_token')),

    sct_en: num(v('cfg_sct_en','1'), 1),
    temp_en: num(v('cfg_temp_en','1'), 1),
    phao1_en: num(v('cfg_phao1_en','1'), 1),

    emqx_en: num(v('cfg_dev_emqx_en','1'), 1),
    emqx_host: String(v('cfg_dev_emqx_host')).trim(),
    emqx_port: num(v('cfg_dev_emqx_port','1883'), 1883),
    emqx_user: String(v('cfg_dev_emqx_user')).trim(),
    emqx_pass: String(v('cfg_dev_emqx_pass')),
    emqx_tls: num(v('cfg_dev_emqx_tls','0'), 0)
  };
}

function saveSysConfig(){
  const cfg = getSysCfgFromForm();
  localStorage.setItem('esp_sys_cfg', JSON.stringify(cfg));
  if(!client || !client.connected){
    showToast('Ch∆∞a k·∫øt n·ªëi MQTT!');
    return;
  }
  rpcCall('setSysConfig', cfg);
  showToast('ƒê√£ g·ª≠i SysConfig - ESP32 s·∫Ω reboot!');
}

function loadSysConfig(){
    // Simplified load logic, can expand if needed
    let c = null;
    try{
        const raw = localStorage.getItem('esp_sys_cfg');
        c = raw ? JSON.parse(raw) : null;
    }catch(e){ c = null; }
    
    if(c){
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = String(val ?? ''); };
        setVal('cfg_wifi_ssid', c.ssid);
        // ... set other fields
    }
}


/* ========= ACTIONS ========= */
function adjustValue(id,d){
  if(uiLocked){ showToast('ƒêang kh√≥a'); return; }
  const i=document.getElementById(id); let c=parseInt(i.value)||0; let n=c+d;
  if(n<0) n=0; i.value=n;
  lastUserInteraction=Date.now();
}
function applyPreset(m,s){
  if(uiLocked){ showToast('ƒêang kh√≥a'); return; }
  document.getElementById('offMin').value = m; document.getElementById('onSec').value = s;
  saveSettings();
}
function saveSettings(){
  if(uiLocked){ showToast('ƒêang kh√≥a'); return; }
  const m = parseInt(document.getElementById("offMin").value||"0");
  const s = parseInt(document.getElementById("onSec").value||"0");
  rpcCall("setOffMin", m); rpcCall("setOnSec", s); rpcCall("save", 1);
  showToast("ƒê√£ g·ª≠i c√†i ƒë·∫∑t");
}
function setMaint(mode){
  if(uiLocked){ showToast('ƒêang kh√≥a'); return; }
  rpcCall("setMaintenance", mode);
  showToast("G·ª≠i l·ªánh b·∫£o tr√¨...");
}

/* ========= TIMELINE & SCHEDULE (FIXED) ========= */
window.renderTimeline = function() {
    const bar = document.getElementById("timelineBar");
    const stt = document.getElementById("timelineStatus");
    if(!bar) return;
    bar.innerHTML = "";

    // 1. T·∫°o m·∫£ng 1440 ph√∫t (0 = Ch·∫°y/Xanh, 1 = Ngh·ªâ/ƒê·ªè)
    let dayMap = new Array(1440).fill(0);
    const ranges = window.state.pause_json || [];
    
    // N·∫øu kh√¥ng c√≥ l·ªãch n√†o -> Full xanh
    if(ranges.length === 0) {
        bar.innerHTML = '<div class="t-seg t-run" style="width:100%"></div>';
        stt.innerText = "L·ªãch tr√¨nh: Ch·∫°y c·∫£ ng√†y (Kh√¥ng ngh·ªâ)";
        return;
    }

    // L·∫•y th·ª© hi·ªán t·∫°i (0=CN, 1=T2...)
    const todayBit = 1 << new Date().getDay();

    ranges.forEach(r => {
        // Ch·ªâ v·∫Ω n·∫øu Enabled (on=1) V√Ä ƒë√∫ng ng√†y h√¥m nay
        const w = (r.w === undefined) ? 127 : r.w;
        if (r.on && (w & todayBit)) {
            // Parse hh:mm
            let s = 0, e = 0;
            // X·ª≠ l√Ω chu·ªói gi·ªù d·∫°ng "HH:MM"
            if(r.s && r.s.includes(':')) {
                const p = r.s.split(':');
                s = parseInt(p[0])*60 + parseInt(p[1]);
            }
            if(r.e && r.e.includes(':')) {
                const p = r.e.split(':');
                e = parseInt(p[0])*60 + parseInt(p[1]);
            }

            if (s < e) {
                for(let i=s; i<e; i++) dayMap[i] = 1; 
            } else {
                // Qua ƒë√™m (22:00 -> 05:00)
                for(let i=s; i<1440; i++) dayMap[i] = 1;
                for(let i=0; i<e; i++) dayMap[i] = 1;
            }
        }
    });

    // 2. G·ªôp c√°c ƒëo·∫°n li√™n ti·∫øp ƒë·ªÉ v·∫Ω HTML
    let html = "";
    let currentVal = dayMap[0]; // 0 or 1
    let count = 0;

    for(let i=0; i<1440; i++) {
        if(dayMap[i] === currentVal) {
            count++;
        } else {
            // ƒê·ªïi tr·∫°ng th√°i -> ch·ªët ƒëo·∫°n c≈©
            let percent = (count / 14.4).toFixed(2); // 1440p = 100%
            let cls = currentVal === 1 ? "t-off" : "t-run";
            html += `<div class="t-seg ${cls}" style="width:${percent}%"></div>`;
            
            // Reset
            currentVal = dayMap[i];
            count = 1;
        }
    }
    // ƒêo·∫°n cu·ªëi c√πng
    let percent = (count / 14.4).toFixed(2);
    let cls = currentVal === 1 ? "t-off" : "t-run";
    html += `<div class="t-seg ${cls}" style="width:${percent}%"></div>`;

    bar.innerHTML = html;
    
    // Update text
    let activeCnt = ranges.filter(r => r.on && ((r.w===undefined?127:r.w) & todayBit)).length;
    if(activeCnt > 0) stt.innerText = `H√¥m nay: ${activeCnt} kho·∫£ng ngh·ªâ (ƒê·ªè)`;
    else stt.innerText = "H√¥m nay kh√¥ng c√≥ l·ªãch ngh·ªâ n√†o k√≠ch ho·∫°t.";
}

window.renderPauseTable = function(){
    const tb = document.getElementById("pauseTbody");
    if(!tb) return;
    tb.innerHTML = "";
    const arr = window.state.pause_json || [];
    if(arr.length === 0) { tb.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px; color: #64748b;">Ch∆∞a c√≥ l·ªãch ngh·ªâ</td></tr>'; return; }
    
    const labels=["CN","T2","T3","T4","T5","T6","T7"];
    arr.forEach((r, idx) => {
        const s=(r.s||"12:00"), e=(r.e||"13:00"), on=(r.on==1), w=(r.w===undefined?127:r.w);
        
        // Day selector logic restored
        let daysHtml = '<div class="day-selector">';
        for(let i=1;i<=7;i++){
          const b=(i==7?0:i), act=(w&(1<<b));
          daysHtml += `<div class="day-btn ${act?'active':''}" onclick="toggleDay(${idx},${b},this)">${labels[b]}</div>`;
        }
        daysHtml += '</div>';

        const tr1 = document.createElement("tr");
        tr1.innerHTML = `<td><input type="time" value="${s}" onchange="updP(${idx},'s',this.value)"></td>
                         <td><input type="time" value="${e}" onchange="updP(${idx},'e',this.value)"></td>
                         <td style="text-align:center"><label class="switch"><input type="checkbox" ${on?'checked':''} onchange="updP(${idx},'on',this.checked?1:0)"><span class="slider"></span></label></td>
                         <td style="text-align:center"><button class="btn-del" onclick="delP(${idx})">X</button></td>`;
        
        const tr2 = document.createElement("tr");
        tr2.innerHTML = `<td colspan="4" style="border:none;padding-top:2px;padding-bottom:10px">${daysHtml}</td>`;
        
        tb.appendChild(tr1);
        tb.appendChild(tr2);
    });
}
window.updP = function(idx,k,v){
    if(!window.state.pause_json[idx]) window.state.pause_json[idx]={s:"12:00",e:"13:00",on:1,w:127};
    window.state.pause_json[idx][k]=v;
    window.renderTimeline();
}
window.toggleDay = function(idx,b,el){
    if(!window.state.pause_json[idx]) return;
    let w = window.state.pause_json[idx].w===undefined?127:window.state.pause_json[idx].w;
    const m = 1<<b;
    if(w&m){ w &= ~m; el.classList.remove('active'); }
    else { w |= m; el.classList.add('active'); }
    window.state.pause_json[idx].w = w;
    window.renderTimeline();
}
window.addPauseRow = function(){
    if(!window.state.pause_json) window.state.pause_json = [];
    window.state.pause_json.push({s:"12:00", e:"13:00", on:1, w:127});
    window.renderPauseTable();
}
window.savePause = function(){
    rpcCall("setPauseJson", window.state.pause_json);
    showToast("ƒê√£ l∆∞u l·ªãch!");
}
window.delP = function(idx){
    window.state.pause_json.splice(idx,1);
    window.renderPauseTable();
}

/* ========= AI FUNCTIONS ========= */
async function callGemini(prompt) {
  const key = document.getElementById('cfg_gemini_key').value.trim();
  if (!key) { showToast("Thi·∫øu API Key!"); return null; }
  
  try {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
    });
    if (!response.ok) throw new Error("L·ªói API");
    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text;
  } catch (error) { showToast(error.message); return null; }
}

window.controlSettingsAI = async function() {
    const input = document.getElementById("aiControlPrompt").value;
    if (!input) { showToast("Vui l√≤ng nh·∫≠p l·ªánh!"); return; }
    const btn = document.getElementById("btnAiControl");
    const originalText = btn.innerHTML;
    btn.innerHTML = `‚è≥`; btn.disabled = true;

    const currentOn = parseInt(document.getElementById("onSec").value || "0");
    const currentOff = parseInt(document.getElementById("offMin").value || "0");

    const prompt = `
      B·∫°n l√† tr·ª£ l√Ω ƒëi·ªÅu khi·ªÉn thi·∫øt b·ªã.
      Tr·∫°ng th√°i hi·ªán t·∫°i: Th·ªùi gian CH·∫†Y (ON) = ${currentOn} gi√¢y, Th·ªùi gian NGH·ªà (OFF) = ${currentOff} ph√∫t.
      Y√™u c·∫ßu ng∆∞·ªùi d√πng: "${input}"

      H√£y t√≠nh to√°n v√† tr·∫£ v·ªÅ JSON ch·ª©a gi√° tr·ªã m·ªõi.
      Format JSON: {"on_sec": s·ªë_nguy√™n, "off_min": s·ªë_nguy√™n}
      Ch·ªâ tr·∫£ v·ªÅ JSON thu·∫ßn.
    `;

    const result = await callGemini(prompt);
    if (result) {
        try {
            const start = result.indexOf('{');
            const end = result.lastIndexOf('}');
            if (start !== -1 && end !== -1) {
                const jsonStr = result.substring(start, end + 1);
                const changes = JSON.parse(jsonStr);
                let changed = false;
                if (changes.on_sec !== undefined) { document.getElementById("onSec").value = changes.on_sec; changed = true; }
                if (changes.off_min !== undefined) { document.getElementById("offMin").value = changes.off_min; changed = true; }
                if (changed) {
                    saveSettings();
                    showToast(`ƒê√£ c·∫≠p nh·∫≠t: On=${document.getElementById("onSec").value}s, Off=${document.getElementById("offMin").value}m`);
                    document.getElementById("aiControlPrompt").value = "";
                } else showToast("Kh√¥ng thay ƒë·ªïi.");
            }
        } catch(e) { console.error(e); showToast("L·ªói AI"); }
    }
    btn.innerHTML = originalText; btn.disabled = false;
}

window.generateScheduleAI = async function() {
    const input = document.getElementById("aiPrompt").value;
    if (!input) { showToast("Vui l√≤ng nh·∫≠p m√¥ t·∫£!"); return; }
    
    const btn = document.getElementById("btnAiSchedule");
    const originalText = btn.innerHTML;
    btn.innerHTML = `‚è≥`; btn.disabled = true;

    const prompt = `
      Tr·ª£ l√Ω l·∫≠p l·ªãch IoT. Y√™u c·∫ßu: "${input}"
      T·∫°o m·∫£ng JSON l·ªãch tr√¨nh NGH·ªà (PAUSE).
      Format JSON: [{"s": "HH:MM", "e": "HH:MM", "on": 1, "w": 127}]
      w: Bitmask th·ª© (CN=1, T2=2... T7=64).
      Ch·ªâ tr·∫£ v·ªÅ JSON thu·∫ßn.
    `;

    const result = await callGemini(prompt);
    if (result) {
        try {
            const start = result.indexOf('[');
            const end = result.lastIndexOf(']');
            if (start !== -1 && end !== -1) {
                const jsonStr = result.substring(start, end + 1);
                const newItems = JSON.parse(jsonStr);
                if (Array.isArray(newItems)) {
                    const currentList = Array.isArray(window.state.pause_json) ? window.state.pause_json : [];
                    window.state.pause_json = currentList.concat(newItems);
                    window.renderPauseTable(); window.renderTimeline();
                    showToast(`ƒê√£ th√™m ${newItems.length} l·ªãch!`);
                    if(window.savePause) window.savePause();
                }
            } else showToast("L·ªói ƒë·ªãnh d·∫°ng AI");
        } catch (e) { console.error(e); showToast("L·ªói AI"); }
    }
    btn.innerHTML = originalText; btn.disabled = false;
}
window.analyzeSensorsAI = async function() {
   const result = await callGemini(`Ph√¢n t√≠ch nhanh: D√≤ng ${window.state.amps}A, Nhi·ªát ${window.state.temp}C.`);
   if(result) alert("ü§ñ Dr.AI:\n" + result);
}
window.startListening = function(id, btn) {
    if(!('webkitSpeechRecognition' in window)) { alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£"); return; }
    const r = new webkitSpeechRecognition();
    r.lang = 'vi-VN';
    r.start();
    btn.classList.add('listening');
    r.onresult = (e) => {
        document.getElementById(id).value = e.results[0][0].transcript;
        btn.classList.remove('listening');
    }
    r.onerror = () => btn.classList.remove('listening');
    r.onspeechend = () => btn.classList.remove('listening');
}

/* ========= PIN & INIT ========= */
let enteredPin = "";
const CORRECT_PIN = "8888"; 
window.tryOpenSettings = function(){
  const p = document.getElementById('settingsPanel');
  if(!p.classList.contains('is-locked')) { switchTab('settings'); return; }
  document.getElementById('pinModal').style.display = 'flex';
  enteredPin = "";
  document.getElementById('pinInput').value = "";
}
window.typePin = function(n){ enteredPin+=n; document.getElementById('pinInput').value="*".repeat(enteredPin.length); }
window.clearPin = function(){ enteredPin=""; document.getElementById('pinInput').value=""; }
window.closePinModal = function(){ document.getElementById('pinModal').style.display='none'; }
window.submitPin = function(){
    if(enteredPin===CORRECT_PIN) {
        document.getElementById('settingsPanel').classList.remove('is-locked');
        uiLocked=false;
        document.getElementById('btnLock').classList.remove('locked');
        document.getElementById('lockBtnLabel').innerText = "CH·∫†M ƒê·ªÇ KH√ìA";
        closePinModal();
        switchTab('settings');
    } else { showToast("Sai m√£ PIN"); clearPin(); }
}
function togglePass(id){
    const x = document.getElementById(id);
    x.type = x.type === "password" ? "text" : "password";
}

// Boot
loadUiSettings();
loadSysConfig();
setTimeout(mqttConnect, 500);
startDeviceWatchdog();
</script>
</body>
</html>
